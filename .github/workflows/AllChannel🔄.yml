name: All Channel ğŸ”„
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download playlists
      run: |
        echo "ğŸ“¥ Downloading playlists..."
        curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        curl -s -L -o source_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/Ayna.m3u"
        
        for file in main_playlist.m3u source_playlist.m3u; do
          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "âŒ ERROR: $file download failed!"
            exit 1
          fi
          LINES=$(wc -l < "$file")
          echo "âœ… $file downloaded - $LINES lines"
        done
        
    - name: Update All Channel ğŸ”„
      run: |
        echo "ğŸ”„ Updating All Channel ğŸ”„..."
        
        python3 - << 'EOF'
        import re
        from datetime import datetime
        import pytz
        import os
        
        # à¦šà§à¦¯à¦¾à¦¨à§‡à¦² à¦®à§à¦¯à¦¾à¦ªà¦¿à¦‚ - à¦†à¦ªà¦¨à¦¾à¦° à¦ªà§à¦°à¦¥à¦® à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿà§‡à¦° à¦¨à¦¾à¦® : à¦¸à§‡à¦•à§‡à¦¨à§à¦¡ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿà§‡ à¦–à§à¦à¦œà¦¬à§‡ à¦à¦®à¦¨ keywords
        CHANNEL_MAPPING = {
            "BTV National": ["BTV NATIONAL HD", "BTV World"],
            "BTV CTG": ["BTV CTG"],
            "Somoy TV": ["Somoy News TV", "Somoy TV"],
            "Jamuna TV": ["Jamuna TV","JAMUNA TV"],
            "Ekushey TV": ["Ekushey TV"],
            "NTV BD": ["NTV"],
            "NTV-Europe": ["NTV Europe"],
            "Channel 24": ["Channel 24"],
            "Deen TV": ["Deen TV"],
            "SATV": ["SA TV"],
            "GTV": ["Gazi TV"],
            "T Sports": ["T Sports HD", "A Sports", "PTV Sports"],
            "Channel 9": ["Channel 9"],
            "Channel I": ["Channel I"],
            "Bangla Vision": ["Bangla Vision"],
            "News 24": ["News 24 BD"], 
            "Boishakhi TV": ["Boishakhi TV"],
            "Bijoy TV": ["Bijoy TV"],
            "ATN Bangla": ["ATN Bangla"],
            "ATN-Bangla News": ["ATN News"],
            "DBC News": ["DBC News"],
            "Independent TV": ["Independent TV"],
            "Bangla TV": ["Bangla TV"],
            "Desh TV": ["Desh TV"],
            "RTV": ["RTV"],
            "My TV": ["My TV"],
            "Duronto": ["Duronto TV"],
            "Deepto TV": ["Deepto TV"],
            "Mohona TV": ["Mohona TV"],
            "Ananda TV": ["Ananda TV"],
            "Asian TV": ["Asian TV"],
            "Gaan Bangla": ["Gaan Bangla", "GAAN BANGLA", "gaan bangla", "Gaan", "GAAN"],
            "Channel 5 TV": ["Channel 5 TV"],
            "Music Bangla": ["Music Bangla"],
            "Ekattor TV": ["Ekattor TV"],
            "Nagorik TV": ["Nagorik TV"],
            "Ekhon TV": ["Ekhon TV"],
            "Peace TV Bangla": ["Peace TV Bangla HD"],
            "Islam Bangla": ["Islam Bangla"],
            "Iqra TV ": ["Iqra Bangla"],
            "Madani TV": ["Madani TV"],
            "News21 TV": ["News21 TV"],
            "Bangla 21": ["Bangla 21"],
            "Movie Bangla": ["Movie Bangla"],
            "Matri Bhumi": ["Matri Bhumi"],
            "Magic Bangla": ["Magic Bangla"],
            "Alpona TV": ["Alpona TV"],
            "Channel A1": ["Channel A1"],
            "Shadin Bangla": ["Shadin Bangla"],
            "Channel S UK": ["Channel S UK HD"],
            "Nandan TV": ["Nandan TV"],
            "Global TV": ["Global TV"],
            "Deshi TV": ["Deshi TV", "Deshi TV (720p)"],
            "Falguni TV": ["Falguni TV"],
            "Channel S BD": ["Channel S BD","Channel S HD"],
            "Rajdhani TV": ["Rajdhani TV"],
            "Rongeen TV": ["Rongeen TV"],
            "Sonic Bangla": ["Sonic Bangla"],
            "Discovery Kids": ["Discovery Kids"],
            "NAN TV": ["NAN TV"],
            "Star Jalsha": ["Star Jalsha HD", "Star Jalsha"],
            "Star-Jalsha Movies": ["Star Jalsha Movies HD"],
            "Zee Bangla": ["Zee Bangla International", "Zee Bangla"],
            "Zee-Bangla Cinema": ["Zee Bangla Cinema"],
            "Colors Bengali": ["colors bangla"],
            "Sangeet Bangla": ["Sangeet Bangla"],
            "Sony Aaat": ["Sony Aaat"],
            "Enter 10 Bangla": ["Enter 10 Bangla"],
            "Zee 24 Ghanta": ["Zee 24 Ghanta"],
        }
        
        def get_bangladesh_time():
            """à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶à§‡à¦° à¦¬à¦°à§à¦¤à¦®à¦¾à¦¨ à¦¸à¦®à¦¯à¦¼ à¦°à¦¿à¦Ÿà¦¾à¦°à§à¦¨ à¦•à¦°à§‡"""
            bangladesh_tz = pytz.timezone('Asia/Dhaka')
            now = datetime.now(bangladesh_tz)
            return now.strftime("%Y-%m-%d %I:%M:%S%p BD Time")
        
        def find_channel_url(source_file, keywords):
            """à¦¸à§‹à¦°à§à¦¸ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿ à¦¥à§‡à¦•à§‡ à¦šà§à¦¯à¦¾à¦¨à§‡à¦² URL à¦–à§à¦à¦œà§‡ à¦¬à§‡à¦° à¦•à¦°à§‡"""
            with open(source_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # à¦¸à¦¬ keywords à¦à¦° à¦œà¦¨à§à¦¯ à¦šà§‡à¦·à§à¦Ÿà¦¾ à¦•à¦°à§à¦¨
            for keyword in keywords:
                pattern = r'#EXTINF:[^\n]*{}[^\n]*\n(http[^\n]+)'.format(re.escape(keyword))
                match = re.search(pattern, content, re.IGNORECASE)
                
                if match:
                    url = match.group(1).strip()
                    print(f"âœ… Found URL for keyword '{keyword}': {url}")
                    return url
            
            print(f"âŒ No URL found for keywords: {keywords}")
            return None
        
        def update_channel_url(main_content, channel_name, new_url, is_manual_run=False):
            """à¦®à§‡à¦‡à¦¨ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿà§‡ à¦¨à¦¿à¦°à§à¦¦à¦¿à¦·à§à¦Ÿ à¦šà§à¦¯à¦¾à¦¨à§‡à¦²à§‡à¦° URL à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à§‡"""
            timestamp = get_bangladesh_time()
            
            # Pattern: #EXTINF à¦²à¦¾à¦‡à¦¨ à¦¯à§‡à¦–à¦¾à¦¨à§‡ channel_name à¦†à¦›à§‡
            pattern_extinf = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)'.format(re.escape(channel_name))
            
            match = re.search(pattern_extinf, main_content, re.IGNORECASE)
            if not match:
                print(f"âŒ {channel_name} not found in main playlist")
                return main_content
            
            extinf_line = match.group(1)
            
            # âœ… à¦¨à¦¤à§à¦¨ à¦«à¦°à¦®à§à¦¯à¦¾à¦Ÿ: à¦šà§à¦¯à¦¾à¦¨à§‡à¦²à§‡à¦° à¦¨à¦¾à¦® à¦¸à¦¹ AUTO-UPDATED à¦²à¦¾à¦‡à¦¨
            auto_updated_line = f"#AUTO-UPDATED - {channel_name} âœ…- {timestamp} ğŸŸ¡ - ğŸ”„ - ğŸ”´\n"
            
            if is_manual_run:
                # Manual run: à¦¨à¦¤à§à¦¨ AUTO-UPDATED à¦²à¦¾à¦‡à¦¨ à¦¯à§‹à¦— à¦•à¦°à¦¬à§‡ (à¦¯à¦¦à¦¿ à¦¨à¦¾ à¦¥à¦¾à¦•à§‡)
                auto_updated_pattern = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)(#AUTO-UPDATED[^\n]*\n)'.format(re.escape(channel_name))
                
                if re.search(auto_updated_pattern, main_content, re.IGNORECASE):
                    # AUTO-UPDATED already exists, replace the entire AUTO-UPDATED line with new one
                    pattern = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)(#AUTO-UPDATED[^\n]*\n)(http[^\n]*\n)'.format(re.escape(channel_name))
                    
                    def replacement(match):
                        return match.group(1) + auto_updated_line + new_url + "\n"
                    
                    updated_content = re.sub(pattern, replacement, main_content, flags=re.IGNORECASE)
                    print(f"âœ… Manual run: Updated AUTO-UPDATED line for {channel_name}")
                else:
                    # No AUTO-UPDATED exists, add it after EXTINF line
                    pattern = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)'.format(re.escape(channel_name))
                    
                    def replacement(match):
                        return match.group(1) + auto_updated_line + new_url + "\n"
                    
                    updated_content = re.sub(pattern, replacement, main_content, flags=re.IGNORECASE)
                    print(f"âœ… Manual run: Added new AUTO-UPDATED line for {channel_name}")
                
                return updated_content
            else:
                # Scheduled run: à¦¶à§à¦§à§ AUTO-UPDATED à¦²à¦¾à¦‡à¦¨ à¦à¦¬à¦‚ URL à¦°à¦¿à¦ªà§à¦²à§‡à¦¸ à¦•à¦°à¦¬à§‡
                pattern = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)(#AUTO-UPDATED[^\n]*\n)(http[^\n]*\n)'.format(re.escape(channel_name))
                
                def replacement(match):
                    return match.group(1) + auto_updated_line + new_url + "\n"
                
                if re.search(pattern, main_content, re.IGNORECASE):
                    updated_content = re.sub(pattern, replacement, main_content, flags=re.IGNORECASE)
                    print(f"âœ… Scheduled run: Updated AUTO-UPDATED line for {channel_name}")
                    return updated_content
                else:
                    # à¦¯à¦¦à¦¿ AUTO-UPDATED à¦¨à¦¾ à¦¥à¦¾à¦•à§‡, à¦•à¦¿à¦¨à§à¦¤à§ à¦šà§à¦¯à¦¾à¦¨à§‡à¦² à¦¥à¦¾à¦•à¦²à§‡ à¦¨à¦¤à§à¦¨ à¦¯à§‹à¦— à¦•à¦°à¦¬à§‡
                    pattern_extinf_only = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)'.format(re.escape(channel_name))
                    
                    def add_auto_updated(match):
                        return match.group(1) + auto_updated_line + new_url + "\n"
                    
                    updated_content = re.sub(pattern_extinf_only, add_auto_updated, main_content, flags=re.IGNORECASE)
                    print(f"âœ… Scheduled run: Added AUTO-UPDATED line for {channel_name}")
                    return updated_content
        
        # à¦®à§‡à¦‡à¦¨ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿ à¦²à§‹à¦¡ à¦•à¦°à§à¦¨
        with open('main_playlist.m3u', 'r', encoding='utf-8') as f:
            main_content = f.read()
        
        # Check if manual run or scheduled
        is_manual_run = os.environ.get('GITHUB_EVENT_NAME') == 'workflow_dispatch'
        
        updated_content = main_content
        update_count = 0
        
        # à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦šà§à¦¯à¦¾à¦¨à§‡à¦²à§‡à¦° à¦œà¦¨à§à¦¯ à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à§à¦¨
        for main_channel, search_keywords in CHANNEL_MAPPING.items():
            print(f"\nğŸ” Processing: {main_channel}")
            print(f"   Run type: {'Manual' if is_manual_run else 'Scheduled'}")
            
            new_url = find_channel_url('source_playlist.m3u', search_keywords)
            
            if new_url:
                updated_content = update_channel_url(updated_content, main_channel, new_url, is_manual_run)
                update_count += 1
            else:
                print(f"âš ï¸ Skipping {main_channel} - no URL found")
        
        # à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦•à¦¨à§à¦Ÿà§‡à¦¨à§à¦Ÿ à¦¸à§‡à¦­ à¦•à¦°à§à¦¨
        with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
        
        print(f"\nğŸ‰ Update Summary:")
        print(f"   Run type: {'Manual' if is_manual_run else 'Scheduled'}")
        print(f"   Total channels processed: {len(CHANNEL_MAPPING)}")
        print(f"   Successfully updated: {update_count}")
        print(f"   Failed: {len(CHANNEL_MAPPING) - update_count}")
        
        EOF
        
    - name: Verify and replace playlist
      run: |
        echo "ğŸ” Verifying updated playlist..."
        
        if [ ! -f "sirometv_updated.m3u" ] || [ ! -s "sirometv_updated.m3u" ]; then
          echo "âŒ ERROR: Updated playlist is missing or empty!"
          exit 1
        fi
        
        # à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦šà§à¦¯à¦¾à¦¨à§‡à¦²à¦—à§à¦²à§‹ à¦¦à§‡à¦–à¦¾à¦¨
        echo "ğŸ“Š Showing sample of updated channels:"
        grep -A 2 "#AUTO-UPDATED" sirometv_updated.m3u | head -20
        
        mv sirometv_updated.m3u sirometv.m3u
        
        echo "âœ… Playlist updated successfully!"
        
    - name: Commit and push changes
      run: |
        echo "ğŸ’¾ Saving changes to repository..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add sirometv.m3u
        
        if git diff --staged --quiet; then
          echo "âœ… No changes detected - playlist is up to date"
        else
          # à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶à§‡à¦° à¦¸à¦®à§Ÿ à¦¨à§‡à¦“à§Ÿà¦¾ (BD Time format)
          BANGLADESH_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %I:%M:%S%p BD Time')
          
          # Check if manual or scheduled run
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            git commit -m "ğŸ”„ Manual Update: All Channel ğŸ”„ - $BANGLADESH_TIME"
          else
            git commit -m "ğŸ”„ Scheduled Update: All Channel ğŸ”„ - $BANGLADESH_TIME"
          fi
          git push
          echo "ğŸ‰ Successfully updated All Channel ğŸ”„ at $BANGLADESH_TIME!"
        fi
        
    - name: Cleanup
      run: |
        rm -f main_playlist.m3u source_playlist.m3u
        echo "âœ… Cleanup completed!"
        
    - name: Success Notification
      if: success()
      run: |
        echo "ğŸŠ Workflow completed successfully!"
        echo "ğŸ“… Next update in 5 minutes"
        
    - name: Failure Notification
      if: failure()
      run: |
        echo "âŒ Workflow failed!"
        echo "Please check the logs for errors."
