name: Sync YuppTV Playlist

on:
  schedule:
    # à¦ªà§à¦°à¦¤à¦¿ à§« à¦®à¦¿à¦¨à¦¿à¦Ÿ à¦ªà¦° à¦ªà¦° à¦°à¦¾à¦¨ à¦¹à¦¬à§‡
    - cron: '*/5 * * * *'
  workflow_dispatch:  # à¦®à§à¦¯à¦¾à¦¨à§à¦¯à¦¼à¦¾à¦²à¦¿ à¦°à¦¾à¦¨ à¦•à¦°à¦¾à¦° à¦…à¦ªà¦¶à¦¨

permissions:
  contents: write

jobs:
  sync-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download YuppTV playlist (Secure)
      run: |
        echo "ğŸ“¥ Downloading YuppTV playlist from secure source..."
        curl -s -L -o Yupp.m3u "${{ secrets.YUPPTV_PLAYLIST_URL }}"
        
        # à¦«à¦¾à¦‡à¦² à¦¡à¦¾à¦‰à¦¨à¦²à§‹à¦¡ à¦¹à§Ÿà§‡à¦›à§‡ à¦•à¦¿à¦¨à¦¾ à¦šà§‡à¦• à¦•à¦°à§à¦¨
        if [ -f "Yupp.m3u" ] && [ -s "Yupp.m3u" ]; then
          echo "âœ… Playlist downloaded successfully"
          echo "ğŸ“Š File size: $(wc -l < Yupp.m3u) lines"
        else
          echo "âŒ Error: Failed to download playlist"
          exit 1
        fi
        
    - name: Check if playlist changed
      id: check_changes
      run: |
        changes_detected=false
        
        if [ -f "Yupp.m3u" ] && [ -s "Yupp.m3u" ]; then
          # à¦«à¦¾à¦‡à¦² à¦à¦•à§à¦¸à¦¿à¦¸à§à¦Ÿ à¦•à¦°à¦²à§‡ changes à¦šà§‡à¦• à¦•à¦°à§à¦¨
          if ! git diff --quiet Yupp.m3u; then
            changes_detected=true
            echo "ğŸ”„ Changes detected in Yupp.m3u"
          fi
        else
          changes_detected=true
          echo "ğŸ“ New Yupp.m3u file will be created"
        fi
        
        echo "changes_detected=$changes_detected" >> $GITHUB_OUTPUT
        
    - name: Commit and push if changes
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add Yupp.m3u
        
        # Commit message with timestamp
        commit_msg="ğŸ”„ Auto-update YuppTV playlist - $(date +'%Y-%m-%d %H:%M:%S')"
        git commit -m "$commit_msg"
        
        echo "ğŸš€ Pushing changes to repository..."
        git push
        echo "âœ… Playlist updated successfully!"
        
    - name: No changes detected
      if: steps.check_changes.outputs.changes_detected == 'false'
      run: |
        echo "âœ… No changes detected in playlist"
        echo "ğŸ• Next check in 5 minutes"
