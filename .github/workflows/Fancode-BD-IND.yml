name: Fancode-BD-IND

on:
  schedule:
    # প্রতি ঘন্টার 07,17,27,37,47,57 মিনিটে রান হবে
    - cron: '7,17,27,37,47,57 * * * *'
  workflow_dispatch:  # ম্যানুয়ালি রান করার অপশন
  push:
    paths:
      - 'fancode.json'  # JSON ফাইল পরিবর্তন হলে ও রান হবে

jobs:
  update-playlists:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests

    - name: Update BD and IND playlists
      run: |
        cat > update_playlists.py << 'EOF'
        import json
        import requests
        from datetime import datetime
        import os

        # JSON ফাইলের URL - আপনার JSON ফাইল URL এখানে দিন
        # যদি রিপোজিটরিতে থাকে, তাহলে সরাসরি ফাইল পড়ুন
        try:
            with open('fancode.json', 'r', encoding='utf-8') as f:
                data = json.load(f)
            print("Loaded JSON from local file")
        except FileNotFoundError:
            # যদি ফাইল না থাকে, তাহলে URL থেকে লোড করুন
            JSON_URL = "https://raw.githubusercontent.com/sirometv/playlist/main/fancode.json"  # আপনার JSON URL
            try:
                response = requests.get(JSON_URL, timeout=10)
                response.raise_for_status()
                data = response.json()
                print(f"Loaded JSON from URL: {JSON_URL}")
            except Exception as e:
                print(f"Error fetching JSON: {e}")
                data = None

        if not data:
            print("Failed to load JSON data")
            exit(1)

        print(f"JSON data loaded successfully at {datetime.now()}")

        def extract_streams(data, country_code):
            """JSON থেকে স্ট্রিম ডেটা এক্সট্র্যাক্ট করা"""
            streams = []
            
            if "matches" not in data:
                print("No 'matches' found in JSON")
                return streams
            
            for match in data["matches"]:
                # শুধুমাত্র adfree_url থাকলে নিবে
                if "adfree_url" in match and match["adfree_url"]:
                    # country_code অনুযায়ী URL পরিবর্তন
                    stream_url = match["adfree_url"]
                    
                    if country_code == "bd":
                        # BD playlist: https://bd-mc-fdlive.fancode.com/...
                        if "https://in-" in stream_url:
                            stream_url = stream_url.replace("https://in-", "https://bd-")
                        elif "https://mc-fdlive.fancode.com" in stream_url:
                            # যদি শুধু mc-fdlive থাকে
                            stream_url = stream_url.replace("https://mc-fdlive", "https://bd-mc-fdlive")
                    elif country_code == "in":
                        # IN playlist: https://in-mc-fdlive.fancode.com/...
                        if "https://bd-" in stream_url:
                            stream_url = stream_url.replace("https://bd-", "https://in-")
                        elif "https://mc-fdlive.fancode.com" in stream_url:
                            # যদি শুধু mc-fdlive থাকে
                            stream_url = stream_url.replace("https://mc-fdlive", "https://in-mc-fdlive")
                    
                    # লগো URL পাওয়া (src থেকে)
                    logo_url = ""
                    if "src" in match:
                        logo_url = match["src"]
                    
                    # টাইটেল পাওয়া
                    title = match.get("title", "Unknown")
                    
                    # EXTINF entry তৈরি
                    extinf_entry = {
                        "title": title,
                        "logo": logo_url,
                        "group": "Live Event",  # সবসময় "Live Event" গ্রুপ ব্যবহার করবে
                        "stream_url": stream_url
                    }
                    streams.append(extinf_entry)
            
            return streams

        def create_m3u_content(streams, playlist_name):
            """M3U প্লেলিস্ট কন্টেন্ট তৈরি করা"""
            content = ["#EXTM3U"]
            
            for i, stream in enumerate(streams):
                # tvg-logo এবং group-title যোগ করা
                extinf_line = f'#EXTINF:-1 tvg-logo="{stream["logo"]}" group-title="{stream["group"]}", {stream["title"]}'
                content.append(extinf_line)
                content.append(stream["stream_url"])
                
                # প্রতিটি #EXTINF এন্ট্রির পর দুই লাইন গ্যাপ দিতে হবে (শেষ এন্ট্রি বাদে)
                if i < len(streams) - 1:
                    content.append("")
                    content.append("")
            
            return "\n".join(content)

        def update_playlist_file(filename, content):
            """ফাইলে m3u কন্টেন্ট লিখা"""
            with open(filename, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"Updated {filename} - {len(content.splitlines())} lines")

        # BD প্লেলিস্টের জন্য স্ট্রিমস
        bd_streams = extract_streams(data, "bd")
        print(f"Found {len(bd_streams)} streams for BD playlist")
        
        # IN প্লেলিস্টের জন্য স্ট্রিমস
        in_streams = extract_streams(data, "in")
        print(f"Found {len(in_streams)} streams for IN playlist")
        
        # M3U কন্টেন্ট তৈরি
        bd_content = create_m3u_content(bd_streams, "Fancode Bangladesh")
        in_content = create_m3u_content(in_streams, "Fancode India")
        
        # ফাইল আপডেট
        update_playlist_file("fancodeBD.m3u", bd_content)
        update_playlist_file("fancodeIND.m3u", in_content)
        
        print(f"Playlists updated successfully at {datetime.now()}")
        EOF
        
        # Python স্ক্রিপ্ট রান করুন
        python update_playlists.py

    - name: Commit and push if changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add fancodeBD.m3u fancodeIND.m3u
        git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update Fancode playlists: $(date +'%Y-%m-%d %H:%M:%S')" && git push)
