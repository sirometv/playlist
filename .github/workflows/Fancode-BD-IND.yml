name: Fancode-BD-IND

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:  # à¦®à§à¦¯à¦¾à¦¨à§à¦¯à¦¼à¦¾à¦²à¦¿ à¦°à¦¾à¦¨ à¦•à¦°à¦¾à¦° à¦…à¦ªà¦¶à¦¨
  push:
    paths:
      - 'fancode.json'  # JSON à¦«à¦¾à¦‡à¦² à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦¹à¦²à§‡ à¦“ à¦°à¦¾à¦¨ à¦¹à¦¬à§‡

jobs:
  update-playlists:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pytz

    - name: Update BD and IND playlists
      run: |
        cat > update_playlists.py << 'EOF'
        import json
        import requests
        from datetime import datetime
        import os
        import pytz

        # JSON à¦«à¦¾à¦‡à¦²à§‡à¦° URL - à¦†à¦ªà¦¨à¦¾à¦° JSON à¦«à¦¾à¦‡à¦² URL à¦à¦–à¦¾à¦¨à§‡ à¦¦à¦¿à¦¨
        # à¦¯à¦¦à¦¿ à¦°à¦¿à¦ªà§‹à¦œà¦¿à¦Ÿà¦°à¦¿à¦¤à§‡ à¦¥à¦¾à¦•à§‡, à¦¤à¦¾à¦¹à¦²à§‡ à¦¸à¦°à¦¾à¦¸à¦°à¦¿ à¦«à¦¾à¦‡à¦² à¦ªà¦¡à¦¼à§à¦¨
        try:
            with open('fancode.json', 'r', encoding='utf-8') as f:
                data = json.load(f)
            print("Loaded JSON from local file")
        except FileNotFoundError:
            # à¦¯à¦¦à¦¿ à¦«à¦¾à¦‡à¦² à¦¨à¦¾ à¦¥à¦¾à¦•à§‡, à¦¤à¦¾à¦¹à¦²à§‡ URL à¦¥à§‡à¦•à§‡ à¦²à§‹à¦¡ à¦•à¦°à§à¦¨
            JSON_URL = "https://raw.githubusercontent.com/sirometv/playlist/main/fancode.json"  # à¦†à¦ªà¦¨à¦¾à¦° JSON URL
            try:
                response = requests.get(JSON_URL, timeout=10)
                response.raise_for_status()
                data = response.json()
                print(f"Loaded JSON from URL: {JSON_URL}")
            except Exception as e:
                print(f"Error fetching JSON: {e}")
                data = None

        if not data:
            print("Failed to load JSON data")
            exit(1)

        print(f"JSON data loaded successfully at {datetime.now()}")

        def get_bangladesh_time():
            """à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶ à¦¸à¦®à¦¯à¦¼ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾"""
            bd_tz = pytz.timezone('Asia/Dhaka')
            bd_time = datetime.now(bd_tz)
            return bd_time

        def format_bangladesh_time(bd_time):
            """à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶ à¦¸à¦®à¦¯à¦¼ à¦«à¦°à¦®à§à¦¯à¦¾à¦Ÿ à¦•à¦°à¦¾"""
            # AM/PM à¦¨à¦¿à¦°à§à¦§à¦¾à¦°à¦£
            am_pm = "am" if bd_time.hour < 12 else "pm"
            
            # 12-hour à¦«à¦°à¦®à§à¦¯à¦¾à¦Ÿà§‡ à¦¸à¦®à¦¯à¦¼
            hour_12 = bd_time.hour % 12
            if hour_12 == 0:
                hour_12 = 12
            
            # à¦¦à¦¿à¦¨-à¦®à¦¾à¦¸-à¦¬à¦›à¦° à¦«à¦°à¦®à§à¦¯à¦¾à¦Ÿ
            day_month_year = bd_time.strftime("%d-%m-%Y")
            
            # à¦Ÿà¦¾à¦‡à¦® à¦«à¦°à¦®à§à¦¯à¦¾à¦Ÿ
            time_str = f"{hour_12:02d}:{bd_time.minute:02d}:{bd_time.second:02d}{am_pm}"
            
            return f"{time_str} - {day_month_year}"

        def extract_streams(data, country_code):
            """JSON à¦¥à§‡à¦•à§‡ à¦¸à§à¦Ÿà§à¦°à¦¿à¦® à¦¡à§‡à¦Ÿà¦¾ à¦à¦•à§à¦¸à¦Ÿà§à¦°à§à¦¯à¦¾à¦•à§à¦Ÿ à¦•à¦°à¦¾"""
            streams = []
            
            if "matches" not in data:
                print("No 'matches' found in JSON")
                return streams
            
            for match in data["matches"]:
                # à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° adfree_url à¦¥à¦¾à¦•à¦²à§‡ à¦¨à¦¿à¦¬à§‡
                if "adfree_url" in match and match["adfree_url"]:
                    # country_code à¦…à¦¨à§à¦¯à¦¾à¦¯à¦¼à§€ URL à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨
                    stream_url = match["adfree_url"]
                    
                    if country_code == "bd":
                        # BD playlist: https://bd-mc-fdlive.fancode.com/...
                        if "https://in-" in stream_url:
                            stream_url = stream_url.replace("https://in-", "https://bd-")
                        elif "https://mc-fdlive.fancode.com" in stream_url:
                            # à¦¯à¦¦à¦¿ à¦¶à§à¦§à§ mc-fdlive à¦¥à¦¾à¦•à§‡
                            stream_url = stream_url.replace("https://mc-fdlive", "https://bd-mc-fdlive")
                    elif country_code == "in":
                        # IN playlist: https://in-mc-fdlive.fancode.com/...
                        if "https://bd-" in stream_url:
                            stream_url = stream_url.replace("https://bd-", "https://in-")
                        elif "https://mc-fdlive.fancode.com" in stream_url:
                            # à¦¯à¦¦à¦¿ à¦¶à§à¦§à§ mc-fdlive à¦¥à¦¾à¦•à§‡
                            stream_url = stream_url.replace("https://mc-fdlive", "https://in-mc-fdlive")
                    
                    # à¦²à¦—à§‹ URL à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ (src à¦¥à§‡à¦•à§‡)
                    logo_url = ""
                    if "src" in match:
                        logo_url = match["src"]
                    
                    # à¦Ÿà¦¾à¦‡à¦Ÿà§‡à¦² à¦ªà¦¾à¦“à¦¯à¦¼à¦¾
                    title = match.get("title", "Unknown")
                    
                    # EXTINF entry à¦¤à§ˆà¦°à¦¿
                    extinf_entry = {
                        "title": title,
                        "logo": logo_url,
                        "group": "Live Event",  # à¦¸à¦¬à¦¸à¦®à¦¯à¦¼ "Live Event" à¦—à§à¦°à§à¦ª à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à¦¬à§‡
                        "stream_url": stream_url
                    }
                    streams.append(extinf_entry)
            
            return streams

        def create_m3u_content(streams, playlist_name):
            """M3U à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿ à¦•à¦¨à§à¦Ÿà§‡à¦¨à§à¦Ÿ à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¾"""
            # à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶ à¦¸à¦®à¦¯à¦¼ à¦ªà¦¾à¦“à¦¯à¦¼à¦¾ à¦à¦¬à¦‚ à¦«à¦°à¦®à§à¦¯à¦¾à¦Ÿ à¦•à¦°à¦¾
            bd_time = get_bangladesh_time()
            update_time = format_bangladesh_time(bd_time)
            
            content = [
                "#EXTM3U",
                "#ğŸ”´ à¦à¦‡ à¦«à¦¾à¦‡à¦²à§‡à¦° à¦¸à¦®à¦¸à§à¦¤ à¦²à¦¿à¦™à§à¦• à¦ªà¦¾à¦¬à¦²à¦¿à¦• à¦¸à§‹à¦°à§à¦¸ à¦¥à§‡à¦•à§‡ à¦¸à¦‚à¦—à§à¦°à¦¹ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡à¥¤ à¦¯à¦¦à¦¿ à¦•à§‡à¦‰ à¦¤à¦¾à¦¦à§‡à¦° à¦¸à§‹à¦°à§à¦¸ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¤à§‡ à¦šà¦¾à¦¨, à¦¤à¦¾à¦¹à¦²à§‡ à¦¦à¦¯à¦¼à¦¾ à¦•à¦°à§‡ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦œà¦¾à¦¨à¦¾à¦¨à¥¤ à¦†à¦®à¦°à¦¾ à¦†à¦ªà¦¨à¦¾à¦° à¦®à¦¤à¦¾à¦®à¦¤ à¦à¦¬à¦‚ à¦ªà§à¦°à¦šà§‡à¦·à§à¦Ÿà¦¾à¦•à§‡ à¦¸à¦®à§à¦®à¦¾à¦¨ à¦•à¦°à¦¿, à¦¤à¦¾à¦‡ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à§‹à¦°à§à¦¸ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¾à¦° à¦¬à§à¦¯à¦¾à¦ªà¦¾à¦°à§‡ à¦†à¦®à¦°à¦¾ à¦†à¦ªà¦¤à§à¦¤à¦¿ à¦•à¦°à¦¬ à¦¨à¦¾à¥¤",
                "#ğŸ”´All the links in this file are collected from public sources. If anyone wants to remove their source, please let us know. We respect your opinions and efforts, so we will not object to removing your source.",
                f"#Update Time âœ”ï¸: {update_time} (Bangladesh Time)",
                "#Telegram ğŸ”—: https://t.me/sirometv",
                "#WEB TV ğŸ“º: https://sirometv-tv.vercel.app",
                "",  # à§§à¦® à¦—à§à¦¯à¦¾à¦« à¦²à¦¾à¦‡à¦¨
                "",  # à§¨à§Ÿ à¦—à§à¦¯à¦¾à¦« à¦²à¦¾à¦‡à¦¨
                "",  # à§©à§Ÿ à¦—à§à¦¯à¦¾à¦« à¦²à¦¾à¦‡à¦¨
                ""   # à§ªà¦°à§à¦¥ à¦—à§à¦¯à¦¾à¦« à¦²à¦¾à¦‡à¦¨
            ]
            
            for i, stream in enumerate(streams):
                # tvg-logo à¦à¦¬à¦‚ group-title à¦¯à§‹à¦— à¦•à¦°à¦¾
                extinf_line = f'#EXTINF:-1 tvg-logo="{stream["logo"]}" group-title="{stream["group"]}", {stream["title"]}'
                content.append(extinf_line)
                content.append(stream["stream_url"])
                
                # à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ #EXTINF à¦à¦¨à§à¦Ÿà§à¦°à¦¿à¦° à¦ªà¦° à¦¦à§à¦‡ à¦²à¦¾à¦‡à¦¨ à¦—à§à¦¯à¦¾à¦ª à¦¦à¦¿à¦¤à§‡ à¦¹à¦¬à§‡ (à¦¶à§‡à¦· à¦à¦¨à§à¦Ÿà§à¦°à¦¿ à¦¬à¦¾à¦¦à§‡)
                if i < len(streams) - 1:
                    content.append("")
                    content.append("")
            
            return "\n".join(content)

        def update_playlist_file(filename, content):
            """à¦«à¦¾à¦‡à¦²à§‡ m3u à¦•à¦¨à§à¦Ÿà§‡à¦¨à§à¦Ÿ à¦²à¦¿à¦–à¦¾"""
            with open(filename, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"Updated {filename} - {len(content.splitlines())} lines")

        # BD à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿà§‡à¦° à¦œà¦¨à§à¦¯ à¦¸à§à¦Ÿà§à¦°à¦¿à¦®à¦¸
        bd_streams = extract_streams(data, "bd")
        print(f"Found {len(bd_streams)} streams for BD playlist")
        
        # IN à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿà§‡à¦° à¦œà¦¨à§à¦¯ à¦¸à§à¦Ÿà§à¦°à¦¿à¦®à¦¸
        in_streams = extract_streams(data, "in")
        print(f"Found {len(in_streams)} streams for IN playlist")
        
        # M3U à¦•à¦¨à§à¦Ÿà§‡à¦¨à§à¦Ÿ à¦¤à§ˆà¦°à¦¿
        bd_content = create_m3u_content(bd_streams, "Fancode Bangladesh")
        in_content = create_m3u_content(in_streams, "Fancode India")
        
        # à¦«à¦¾à¦‡à¦² à¦†à¦ªà¦¡à§‡à¦Ÿ
        update_playlist_file("fancodeBD.m3u", bd_content)
        update_playlist_file("fancodeIND.m3u", in_content)
        
        print(f"Playlists updated successfully at {datetime.now()}")
        print(f"Next update in 10 minutes")
        EOF
        
        # Python à¦¸à§à¦•à§à¦°à¦¿à¦ªà§à¦Ÿ à¦°à¦¾à¦¨ à¦•à¦°à§à¦¨
        python update_playlists.py

    - name: Commit and push if changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add fancodeBD.m3u fancodeIND.m3u
        git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update Fancode playlists: $(date +'%Y-%m-%d %H:%M:%S')" && git push)
