name: Combined Playlist Updates1ğŸ”„
on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-all-channel:
    name: All Channel ğŸ”„ (Channel Mapping)
    runs-on: ubuntu-latest
    outputs:
      temp_file: ${{ steps.save-temp.outputs.temp_file }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download main playlist
      run: |
        echo "ğŸ“¥ Downloading main playlist..."
        curl -s -L -o sirometv_main.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        
        if [ ! -f "sirometv_main.m3u" ] || [ ! -s "sirometv_main.m3u" ]; then
          echo "âŒ ERROR: Main playlist download failed!"
          exit 1
        fi
        
        LINES=$(wc -l < "sirometv_main.m3u")
        echo "âœ… Main playlist downloaded - $LINES lines"
        
    - name: Download Ayna playlist
      run: |
        echo "ğŸ“¥ Downloading Ayna playlist..."
        curl -s -L -o Ayna.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/Ayna.m3u"
        
        if [ ! -f "Ayna.m3u" ] || [ ! -s "Ayna.m3u" ]; then
          echo "âŒ ERROR: Ayna playlist download failed!"
          exit 1
        fi
        
        LINES=$(wc -l < "Ayna.m3u")
        echo "âœ… Ayna playlist downloaded - $LINES lines"
        
    - name: Update Channel Mapping
      run: |
        echo "ğŸ”„ Updating All Channel (Channel Mapping)..."
        
        python3 - << 'EOF'
        import re
        from datetime import datetime
        import pytz
        import os
        
        # CHANNEL_MAPPING - All Channel
        CHANNEL_MAPPING = {
            "BTV National": ["BTV NATIONAL HD", "BTV World"],
            "BTV CTG": ["BTV CTG"],
            "Somoy TV": ["Somoy News TV", "Somoy TV"],
            "Jamuna TV": ["Jamuna TV","JAMUNA TV"],
            "Ekushey TV": ["Ekushey TV"],
            "NTV BD": ["NTV"],
            "NTV-Europe": ["NTV Europe"],
            "Channel 24": ["Channel 24"],
            "Deen TV": ["Deen TV"],
            "SATV": ["SA TV"],
            "GTV": ["Gazi TV"],
            "T Sports": ["T Sports HD", "A Sports", "PTV Sports"],
            "Channel 9": ["Channel 9"],
            "Channel I": ["Channel I"],
            "Bangla Vision": ["Bangla Vision"],
            "News 24": ["News 24 BD"], 
            "Boishakhi TV": ["Boishakhi TV"],
            "Bijoy TV": ["Bijoy TV"],
            "ATN Bangla": ["ATN Bangla"],
            "ATN-Bangla News": ["ATN News"],
            "DBC News": ["DBC News"],
            "Independent TV": ["Independent TV"],
            "Bangla TV": ["Bangla TV"],
            "Desh TV": ["Desh TV"],
            "RTV": ["RTV"],
            "My TV": ["My TV"],
            "Duronto": ["Duronto TV"],
            "Deepto TV": ["Deepto TV"],
            "Mohona TV": ["Mohona TV"],
            "Ananda TV": ["Ananda TV"],
            "Asian TV": ["Asian TV"],
            "Gaan Bangla": ["Gaan Bangla", "GAAN BANGLA", "gaan bangla", "Gaan", "GAAN"],
            "Channel 5 TV": ["Channel 5 TV"],
            "Music Bangla": ["Music Bangla"],
            "Ekattor TV": ["Ekattor TV"],
            "Nagorik TV": ["Nagorik TV"],
            "Ekhon TV": ["Ekhon TV"],
            "Peace TV Bangla": ["Peace TV Bangla HD"],
            "Islam Bangla": ["Islam Bangla"],
            "Iqra TV ": ["Iqra Bangla"],
            "Madani TV": ["Madani TV"],
            "News21 TV": ["News21 TV"],
            "Bangla 21": ["Bangla 21"],
            "Movie Bangla": ["Movie Bangla"],
            "Matri Bhumi": ["Matri Bhumi"],
            "Magic Bangla": ["Magic Bangla"],
            "Alpona TV": ["Alpona TV"],
            "Channel A1": ["Channel A1"],
            "Shadin Bangla": ["Shadin Bangla"],
            "Channel S UK": ["Channel S UK HD"],
            "Nandan TV": ["Nandan TV"],
            "Global TV": ["Global TV"],
            "Deshi TV": ["Deshi TV", "Deshi TV (720p)"],
            "Falguni TV": ["Falguni TV"],
            "Channel S BD": ["Channel S BD","Channel S HD"],
            "Rajdhani TV": ["Rajdhani TV"],
            "Rongeen TV": ["Rongeen TV"],
            "Sonic Bangla": ["Sonic Bangla"],
            "Discovery Kids": ["Discovery Kids"],
            "NAN TV": ["NAN TV"],
            "Star Jalsha": ["Star Jalsha HD", "Star Jalsha"],
            "Star-Jalsha Movies": ["Star Jalsha Movies HD"],
            "Zee Bangla": ["Zee Bangla International", "Zee Bangla"],
            "Zee-Bangla Cinema": ["Zee Bangla Cinema"],
            "Colors Bengali": ["colors bangla"],
            "Sangeet Bangla": ["Sangeet Bangla"],
            "Sony Aaat": ["Sony Aaat"],
            "Enter 10 Bangla": ["Enter 10 Bangla"],
            "Zee 24 Ghanta": ["Zee 24 Ghanta"],
        }
        
        def get_bangladesh_time():
            bangladesh_tz = pytz.timezone('Asia/Dhaka')
            now = datetime.now(bangladesh_tz)
            return now.strftime("%Y-%m-%d %I:%M:%S%p BD Time")
        
        def find_channel_url(source_file, keywords):
            with open(source_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            for keyword in keywords:
                pattern = r'#EXTINF:[^\n]*{}[^\n]*\n(http[^\n]+)'.format(re.escape(keyword))
                match = re.search(pattern, content, re.IGNORECASE)
                
                if match:
                    url = match.group(1).strip()
                    print(f"âœ… Found URL for keyword '{keyword}': {url}")
                    return url
            
            print(f"âŒ No URL found for keywords: {keywords}")
            return None
        
        def update_channel_url(main_content, channel_name, new_url):
            timestamp = get_bangladesh_time()
            
            pattern_extinf = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)'.format(re.escape(channel_name))
            
            match = re.search(pattern_extinf, main_content, re.IGNORECASE)
            if not match:
                print(f"âŒ {channel_name} not found in main playlist")
                return main_content
            
            auto_updated_line = f"#AUTO-UPDATED - {channel_name} âœ…- {timestamp} ğŸŸ¡ - ğŸ”„ - ğŸ”´\n"
            
            pattern = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)(#AUTO-UPDATED[^\n]*\n)?(http[^\n]*\n)'.format(re.escape(channel_name))
            
            def replacement(match):
                if match.group(2):  # AUTO-UPDATED already exists
                    return match.group(1) + auto_updated_line + new_url + "\n"
                else:  # No AUTO-UPDATED line
                    return match.group(1) + auto_updated_line + new_url + "\n"
            
            updated_content = re.sub(pattern, replacement, main_content, flags=re.IGNORECASE)
            print(f"âœ… Updated {channel_name}")
            return updated_content
        
        # Load main playlist
        with open('sirometv_main.m3u', 'r', encoding='utf-8') as f:
            main_content = f.read()
        
        is_manual_run = os.environ.get('GITHUB_EVENT_NAME') == 'workflow_dispatch'
        
        updated_content = main_content
        update_count = 0
        
        for main_channel, search_keywords in CHANNEL_MAPPING.items():
            print(f"\nğŸ” Processing: {main_channel}")
            
            new_url = find_channel_url('Ayna.m3u', search_keywords)
            
            if new_url:
                updated_content = update_channel_url(updated_content, main_channel, new_url)
                update_count += 1
            else:
                print(f"âš ï¸ Skipping {main_channel} - no URL found")
        
        # Save updated content
        with open('sirometv_after_allchannel.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
        
        print(f"\nğŸ‰ All Channel Update Summary:")
        print(f"   Run type: {'Manual' if is_manual_run else 'Scheduled'}")
        print(f"   Total channels: {len(CHANNEL_MAPPING)}")
        print(f"   Successfully updated: {update_count}")
        
        EOF
        
    - name: Verify All Channel update
      run: |
        echo "ğŸ” Verifying All Channel update..."
        
        if [ ! -f "sirometv_after_allchannel.m3u" ] || [ ! -s "sirometv_after_allchannel.m3u" ]; then
          echo "âŒ ERROR: Updated playlist is missing!"
          exit 1
        fi
        
        echo "ğŸ“Š Sample updated channels:"
        grep -A 1 "#AUTO-UPDATED" sirometv_after_allchannel.m3u | head -10
        
    - name: Save temp file for next job
      id: save-temp
      run: |
        echo "ğŸ’¾ Saving temporary file..."
        cp sirometv_after_allchannel.m3u sirometv_temp.m3u
        echo "temp_file=sirometv_temp.m3u" >> $GITHUB_OUTPUT

  update-live-fancode:
    name: Live Fancode ğŸ”„ğŸ”„ (Group Titles)
    runs-on: ubuntu-latest
    needs: update-all-channel
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Load temp file from previous job
      run: |
        echo "ğŸ“¥ Loading All Channel updated file..."
        if [ -f "sirometv_temp.m3u" ]; then
          cp sirometv_temp.m3u main_playlist.m3u
          echo "âœ… Loaded All Channel updated playlist"
        else
          echo "âš ï¸ Temp file not found, downloading fresh..."
          curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        fi
        
    - name: Download Live Fancode source
      run: |
        echo "ğŸ“¥ Downloading Live Fancode source playlist..."
        curl -s -L -o fancode_source.m3u "https://raw.githubusercontent.com/abusaeeidx/Mrgify-BDIX-IPTV/main/playlist.m3u"
        
        if [ ! -f "fancode_source.m3u" ] || [ ! -s "fancode_source.m3u" ]; then
          echo "âŒ ERROR: Fancode source download failed!"
          exit 1
        fi
        
        LINES=$(wc -l < "fancode_source.m3u")
        echo "âœ… Fancode source downloaded - $LINES lines"
        
    - name: Update Group Titles
      run: |
        echo "ğŸ”„ Updating Live Fancode (Group Titles)..."
        
        python3 - << 'EOF'
        import re
        from datetime import datetime
        import pytz
        import os
        
        # CONFIGURATION for Group Titles
        TARGET_LINE_NUMBER = 4
        
        TARGET_GROUP_TITLES = [
            "Live Event",
            # "Cricket",
            # "Akash Go",
            # "Football",
            # "Sports",
            # "Movies",
        ]
        
        def get_bangladesh_time():
            bangladesh_tz = pytz.timezone('Asia/Dhaka')
            now = datetime.now(bangladesh_tz)
            return now.strftime("%Y-%m-%d %I:%M:%S%p BD Time")
        
        def get_channel_name_strategy(group_title, extinf_line):
            channel_name_match = re.search(r',([^,\n]+)$', extinf_line)
            original_name = channel_name_match.group(1).strip() if channel_name_match else ""
            
            if group_title == "Live Event":
                return "Fancode"
            elif group_title == "Sports":
                return "Sports Live"
            elif group_title == "Akash Go":
                return original_name
            else:
                return original_name
        
        def extract_group_channels(source_file, group_title):
            channels = []
            
            with open(source_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            pattern = r'(#EXTINF:-1[^\n]*group-title="[^"]*{}[^"]*"[^\n]*\n)(http[^\n]+)'.format(re.escape(group_title))
            
            matches = re.finditer(pattern, content, re.IGNORECASE)
            
            for match in matches:
                extinf_line = match.group(1).strip()
                url_line = match.group(2).strip()
                
                logo_match = re.search(r'tvg-logo="([^"]*)"', extinf_line)
                tvg_logo = logo_match.group(1) if logo_match else "https://i.postimg.cc/d1hHy4ss/11.png"
                
                channel_name = get_channel_name_strategy(group_title, extinf_line)
                
                channels.append({
                    'url_line': url_line,
                    'tvg_logo': tvg_logo,
                    'channel_name': channel_name,
                    'group_title': group_title
                })
            
            print(f"âœ… Found {len(channels)} channels for group '{group_title}'")
            return channels
        
        def insert_groups_at_line(main_content, all_group_channels, target_line):
            timestamp = get_bangladesh_time()
            
            new_section = f"#AUTO-UPDATED-MULTIGROUP - {timestamp}\n"
            
            total_channels = 0
            
            for group_title, channels in all_group_channels.items():
                if channels:
                    new_section += f"# --- {group_title} Group ---\n"
                    
                    for channel in channels:
                        new_extinf_line = f'#EXTINF:-1 tvg-logo="{channel["tvg_logo"]}" group-title="{group_title}", {channel["channel_name"]}\n'
                        new_section += new_extinf_line
                        new_section += channel["url_line"] + "\n"
                    
                    total_channels += len(channels)
            
            lines = main_content.split('\n')
            
            if target_line < 1:
                target_line = 1
            if target_line > len(lines):
                target_line = len(lines)
            
            print(f"ğŸ“ Inserting at line: {target_line}")
            
            # Remove existing MULTIGROUP section if exists
            new_lines = []
            skip_section = False
            for line in lines:
                if '#AUTO-UPDATED-MULTIGROUP' in line:
                    skip_section = True
                    continue
                elif skip_section and (line.startswith('#EXTINF') or line.startswith('http') or line.startswith('# ---')):
                    continue
                elif skip_section:
                    skip_section = False
                    new_lines.append(line)
                else:
                    new_lines.append(line)
            
            # Insert new section at target line
            insert_pos = target_line - 1
            if insert_pos > len(new_lines):
                insert_pos = len(new_lines)
            
            final_lines = new_lines[:insert_pos] + new_section.split('\n') + new_lines[insert_pos:]
            updated_content = '\n'.join(final_lines)
            
            return updated_content, total_channels
        
        # Load main playlist
        with open('main_playlist.m3u', 'r', encoding='utf-8') as f:
            main_content = f.read()
        
        is_manual_run = os.environ.get('GITHUB_EVENT_NAME') == 'workflow_dispatch'
        
        active_groups = [group for group in TARGET_GROUP_TITLES if not group.startswith('#')]
        
        if not active_groups:
            print("âŒ ERROR: No active groups found!")
            exit(1)
        
        print(f"ğŸ¯ Active groups: {active_groups}")
        
        all_group_channels = {}
        
        for group_title in active_groups:
            print(f"\nğŸ” Processing group: {group_title}")
            channels = extract_group_channels('fancode_source.m3u', group_title)
            if channels:
                all_group_channels[group_title] = channels
        
        if not all_group_channels:
            print("âš ï¸ No channels found for any group, keeping existing content")
            updated_content = main_content
            total_added = 0
        else:
            updated_content, total_added = insert_groups_at_line(main_content, all_group_channels, TARGET_LINE_NUMBER)
        
        # Save final content
        with open('sirometv_final.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
        
        print(f"\nğŸ‰ Live Fancode Update Summary:")
        print(f"   Run type: {'Manual' if is_manual_run else 'Scheduled'}")
        print(f"   Target line: {TARGET_LINE_NUMBER}")
        print(f"   Groups processed: {len(active_groups)}")
        print(f"   Channels added: {total_added}")
        
        EOF
        
    - name: Verify final playlist
      run: |
        echo "ğŸ” Verifying final playlist..."
        
        if [ ! -f "sirometv_final.m3u" ] || [ ! -s "sirometv_final.m3u" ]; then
          echo "âŒ ERROR: Final playlist missing!"
          exit 1
        fi
        
        echo "ğŸ“Š Line count:"
        wc -l sirometv_final.m3u
        
        echo "ğŸ“ AUTO-UPDATED sections:"
        grep -n "AUTO-UPDATED" sirometv_final.m3u
        
        echo "âœ… Final playlist verified!"
        
    - name: Commit and push final file
      run: |
        echo "ğŸ’¾ Committing final changes..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # Rename to final filename
        mv sirometv_final.m3u sirometv.m3u
        git add sirometv.m3u
        
        if git diff --staged --quiet; then
          echo "âœ… No changes detected"
        else
          BANGLADESH_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %I:%M:%S%p BD Time')
          
          # Count updates
          CHANNEL_UPDATES=$(grep -c "#AUTO-UPDATED - .* âœ…-" sirometv.m3u || echo "0")
          GROUP_CHANNELS=$(grep -c 'group-title="Live Event"' sirometv.m3u || echo "0")
          
          COMMIT_MESSAGE="ğŸ”„ "
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            COMMIT_MESSAGE+="Manual: "
          else
            COMMIT_MESSAGE+="Auto: "
          fi
          
          COMMIT_MESSAGE+="Channels($CHANNEL_UPDATES) + Live Event($GROUP_CHANNELS) - $BANGLADESH_TIME"
          
          git commit -m "$COMMIT_MESSAGE"
          git push
          
          echo "ğŸ‰ Successfully updated!"
        fi
        
    - name: Cleanup
      run: |
        rm -f *.m3u
        echo "âœ… Cleanup completed!"
        
    - name: Success Notification
      if: success()
      run: |
        echo "ğŸŠ Combined workflow completed successfully!"
        echo "ğŸ“… Next update in 5 minutes"
