name: Ayna TV

on:
  schedule:
    # ржкрзНрж░рждрж┐ рзл ржорж┐ржирж┐ржЯ ржкрж░ ржкрж░ ржЖржкржбрзЗржЯ рж╣ржмрзЗ
    - cron: '*/5 * * * *'
  workflow_dispatch:  # ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓рж┐ рж░рж╛ржи ржХрж░рж╛рж░ ржЕржкрж╢ржи

permissions:
  contents: write

jobs:
  sync-ayna:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download original playlist
      run: |
        echo "ЁЯФД Starting Ayna TV playlist sync..."
        echo "ЁЯУе Downloading from secure source..."
        
        # рж╕рж┐ржХрзНрж░рзЗржЯ URL ржерзЗржХрзЗ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржбрж╛ржЙржирж▓рзЛржб
        curl -s -L -o original_playlist.m3u "${{ secrets.SIROMETV_AYNA }}"
        
        # ржбрж╛ржЙржирж▓рзЛржб рж╕ржлрж▓ рж╣рзЯрзЗржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ
        if [ ! -f "original_playlist.m3u" ] || [ ! -s "original_playlist.m3u" ]; then
          echo "тЭМ ERROR: Playlist download failed!"
          exit 1
        fi
        
        ORIGINAL_LINES=$(wc -l < original_playlist.m3u)
        echo "тЬЕ Download successful - $ORIGINAL_LINES lines"
        
    - name: Process and customize playlist
      run: |
        echo "ЁЯОи Customizing playlist with Sirome TV branding..."
        
        # ржЪрзНржпрж╛ржирзЗрж▓ ржХрж╛ржЙржирзНржЯ рж╕ржВржЧрзНрж░рж╣
        CHANNEL_COUNT=$(grep -c "#EXTINF:" original_playlist.m3u)
        CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
        
        # patterns for security
        PATTERN1=$(echo "Q3JlYXRlZCBieSB8VG90YWwgY2hhbm5lbHM6fEdlbmVyYXRlZDo=" | base64 -d)
        PATTERN2=$(echo "I0VYVElORjotMSB0dmctbG9nbz0iaHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0hlbGxvUGVvcGxUVjR5b3UvSVBUVi1QbGF5bGlzdC9jMjQ1MTQ2Y2QxNzhmOWRhM2NlMTRjY2ZlYzVjNjhjYWYxMzczMDI5L3gtZmlyZS1mbGl4LnBuZyIgZ3JvdXAtdGl0bGU9IkJZIFggZmlyZSBGbGl4IixYIGZpcmUgRmxpeA==" | base64 -d)
        PATTERN3=$(echo "aHR0cHM6Ly9yYXcuZ2l0aHVidXNlcmNvbnRlbnQuY29tL0hlbGxvUGVvcGxUVjR5b3UvbGl2ZS9yZWZzL2hlYWRzL21haW4vYnl4ZmlyZWZsaXgvQlktWC1GSVJFLUZMSVgubXA0" | base64 -d)
        
        # New Custom Header
        echo "#EXTM3U" > Ayna.m3u
        echo "# Sirome TV" >> Ayna.m3u
        echo "# Total channels: $CHANNEL_COUNT" >> Ayna.m3u
        echo "# Updated: $CURRENT_TIME" >> Ayna.m3u
        echo "# Powered-By: BDIX" >> Ayna.m3u
        echo "" >> Ayna.m3u
        
        # ржорзВрж▓ ржХржирзНржЯрзЗржирзНржЯ ржкрзНрж░рж╕рзЗрж╕рж┐ржВ (Base64 decoded patterns ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ)
        LINE_NUMBER=0
        SKIP_NEXT_LINE=0
        
        while IFS= read -r line; do
            LINE_NUMBER=$((LINE_NUMBER + 1))
            
            # ржЪрзЗржХ ржХрж░рзБржи ржпржжрж┐ рж▓рж╛ржЗржиржЯрж┐ skip ржХрж░рждрзЗ рж╣ржмрзЗ
            if [ $SKIP_NEXT_LINE -eq 1 ]; then
                SKIP_NEXT_LINE=0
                continue
            fi
            
            # PATTERN2 (X fire Flix EXTINF line) ржерж╛ржХрж▓рзЗ skip ржХрж░рзБржи
            if echo "$line" | grep -q "$PATTERN2"; then
                echo "ЁЯЪл Removing X fire Flix channel: $line"
                SKIP_NEXT_LINE=1
                continue
            fi
            
            # PATTERN3 (X fire Flix URL line) ржерж╛ржХрж▓рзЗ skip ржХрж░рзБржи
            if echo "$line" | grep -q "$PATTERN3"; then
                echo "ЁЯЪл Removing X fire Flix URL"
                continue
            fi
            
            # PATTERN1 (header lines) ржерж╛ржХрж▓рзЗ skip ржХрж░рзБржи
            if echo "$line" | grep -q "$PATTERN1"; then
                echo "ЁЯЪл Removing unwanted header: $line"
                continue
            fi
            
            # ржЕржирзНржп рж╕ржм рж▓рж╛ржЗржи ржпрзЛржЧ ржХрж░рзБржи
            echo "$line" >> Ayna.m3u
            
        done < original_playlist.m3u
        
        # ржлрж▓рж╛ржлрж▓ ржЪрзЗржХ
        FINAL_LINES=$(wc -l < Ayna.m3u)
        FINAL_CHANNELS=$(grep -c "#EXTINF:" Ayna.m3u)
        LINES_REMOVED=$((ORIGINAL_LINES - FINAL_LINES + 5))  # 5 lines ржЖржорж░рж╛ ржирждрзБржи рж╣рзЗржбрж╛рж░ ржпрзЛржЧ ржХрж░рзЗржЫрж┐
        
        echo "тЬи Customization completed!"
        echo "ЁЯУК Statistics:"
        echo "   Original lines: $ORIGINAL_LINES"
        echo "   Final lines: $FINAL_LINES"
        echo "   Original channels: $CHANNEL_COUNT"
        echo "   Final channels: $FINAL_CHANNELS"
        echo "   Removed channels: $((CHANNEL_COUNT - FINAL_CHANNELS))"
        echo "   Total lines removed: $LINES_REMOVED"
        
        # рж╕рж╛ржорзНржкрзНрж▓ ржХржирзНржЯрзЗржирзНржЯ ржжрзЗржЦрж╛ржи
        echo "ЁЯФН Preview of customized playlist:"
        head -8 Ayna.m3u
        
        # ржЯрзЗржорзНржкрзЛрж░рж╛рж░рж┐ ржлрж╛ржЗрж▓ ржХрзНрж▓рж┐ржиржЖржк
        rm -f original_playlist.m3u
        
    - name: Verify processed file
      run: |
        echo "ЁЯФН Verifying processed playlist..."
        
        if [ ! -f "Ayna.m3u" ] || [ ! -s "Ayna.m3u" ]; then
          echo "тЭМ ERROR: Processed file is missing or empty!"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < Ayna.m3u)
        LINES_COUNT=$(wc -l < Ayna.m3u)
        CHANNELS=$(grep -c "#EXTINF:" Ayna.m3u)
        
        echo "тЬЕ File verification passed!"
        echo "ЁЯУЛ File details:"
        echo "   Size: $FILE_SIZE bytes"
        echo "   Lines: $LINES_COUNT"
        echo "   Channels: $CHANNELS"
        
    - name: Commit and push changes
      run: |
        echo "ЁЯТ╛ Saving changes to repository..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Ayna.m3u
        
        # рж╢рзБржзрзБ changes ржерж╛ржХрж▓рзЗ commit ржХрж░рзБржи
        if git diff --staged --quiet; then
          echo "тЬЕ No changes detected - playlist is up to date"
        else
          git commit -m "ЁЯФД Ayna TV Auto Sync - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "ЁЯОЙ Successfully updated Ayna.m3u with Sirome TV branding!"
          echo "ЁЯХР Next auto-sync in 5 minutes"
        fi
        
    - name: Cleanup on success
      if: success()
      run: |
        echo "ЁЯз╣ Cleanup completed"
        echo "тЬЕ Ayna TV sync workflow finished successfully!"
