name: Ayna TV

on:
  schedule:
    # ржкрзНрж░рждрж┐ рзл ржорж┐ржирж┐ржЯ ржкрж░ ржкрж░ ржЖржкржбрзЗржЯ рж╣ржмрзЗ
    - cron: '*/5 * * * *'
  workflow_dispatch:  # ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓рж┐ рж░рж╛ржи ржХрж░рж╛рж░ ржЕржкрж╢ржи

permissions:
  contents: write

jobs:
  sync-ayna:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download original playlist
      run: |
        echo "ЁЯФД Starting Ayna TV playlist sync..."
        echo "ЁЯУе Downloading from secure source..."
        
        # рж╕рж┐ржХрзНрж░рзЗржЯ URL ржерзЗржХрзЗ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржбрж╛ржЙржирж▓рзЛржб
        curl -s -L -o original_playlist.m3u "${{ secrets.SIROMETV_AYNA }}"
        
        # ржбрж╛ржЙржирж▓рзЛржб рж╕ржлрж▓ рж╣рзЯрзЗржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ
        if [ ! -f "original_playlist.m3u" ] || [ ! -s "original_playlist.m3u" ]; then
          echo "тЭМ ERROR: Playlist download failed!"
          exit 1
        fi
        
        ORIGINAL_LINES=$(wc -l < original_playlist.m3u)
        echo "тЬЕ Download successful - $ORIGINAL_LINES lines"
        
    - name: Process and customize playlist
      run: |
        echo "ЁЯОи Customizing playlist with Sirome TV branding..."
        
        # ржЪрзНржпрж╛ржирзЗрж▓ ржХрж╛ржЙржирзНржЯ рж╕ржВржЧрзНрж░рж╣
        CHANNEL_COUNT=$(grep -c "#EXTINF:" original_playlist.m3u)
        CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
        
        # ржирждрзБржи ржХрж╛рж╕рзНржЯржо рж╣рзЗржбрж╛рж░ рждрзИрж░рж┐
        echo "#EXTM3U" > Ayna.m3u
        echo "# Sirome TV" >> Ayna.m3u
        echo "# Total channels: $CHANNEL_COUNT" >> Ayna.m3u
        echo "# Updated: $CURRENT_TIME" >> Ayna.m3u
        echo "# Auto-sync: Every 5 minutes" >> Ayna.m3u
        echo "" >> Ayna.m3u
        
        # ржорзВрж▓ ржХржирзНржЯрзЗржирзНржЯ ржпрзЛржЧ ржХрж░рзБржи (ржЕржирж╛ржХрж╛ржЩрзНржХрзНрж╖рж┐ржд рж╣рзЗржбрж╛рж░ ржмрж╛ржж ржжрж┐рзЯрзЗ)
        grep -v -E "(#EXTM3U|# Created by @AbuSaeedX|# Total channels:|# Generated:)" original_playlist.m3u >> Ayna.m3u
        
        # ржлрж▓рж╛ржлрж▓ ржЪрзЗржХ
        FINAL_LINES=$(wc -l < Ayna.m3u)
        LINES_REMOVED=$((ORIGINAL_LINES - FINAL_LINES + 5))  # 5 lines ржЖржорж░рж╛ ржирждрзБржи рж╣рзЗржбрж╛рж░ ржпрзЛржЧ ржХрж░рзЗржЫрж┐
        
        echo "тЬи Customization completed!"
        echo "ЁЯУК Statistics:"
        echo "   Original lines: $ORIGINAL_LINES"
        echo "   Final lines: $FINAL_LINES"
        echo "   Channels found: $CHANNEL_COUNT"
        echo "   Header lines replaced: $LINES_REMOVED"
        
        # рж╕рж╛ржорзНржкрзНрж▓ ржХржирзНржЯрзЗржирзНржЯ ржжрзЗржЦрж╛ржи
        echo "ЁЯФН Preview of customized playlist:"
        head -8 Ayna.m3u
        
        # ржЯрзЗржорзНржкрзЛрж░рж╛рж░рж┐ ржлрж╛ржЗрж▓ ржХрзНрж▓рж┐ржиржЖржк
        rm -f original_playlist.m3u
        
    - name: Verify processed file
      run: |
        echo "ЁЯФН Verifying processed playlist..."
        
        if [ ! -f "Ayna.m3u" ] || [ ! -s "Ayna.m3u" ]; then
          echo "тЭМ ERROR: Processed file is missing or empty!"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < Ayna.m3u)
        LINES_COUNT=$(wc -l < Ayna.m3u)
        CHANNELS=$(grep -c "#EXTINF:" Ayna.m3u)
        
        echo "тЬЕ File verification passed!"
        echo "ЁЯУЛ File details:"
        echo "   Size: $FILE_SIZE bytes"
        echo "   Lines: $LINES_COUNT"
        echo "   Channels: $CHANNELS"
        
    - name: Commit and push changes
      run: |
        echo "ЁЯТ╛ Saving changes to repository..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Ayna.m3u
        
        # рж╢рзБржзрзБ changes ржерж╛ржХрж▓рзЗ commit ржХрж░рзБржи
        if git diff --staged --quiet; then
          echo "тЬЕ No changes detected - playlist is up to date"
        else
          git commit -m "ЁЯФД Ayna TV Auto Sync - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "ЁЯОЙ Successfully updated Ayna.m3u with Sirome TV branding!"
          echo "ЁЯХР Next auto-sync in 5 minutes"
        fi
        
    - name: Cleanup on success
      if: success()
      run: |
        echo "ЁЯз╣ Cleanup completed"
        echo "тЬЕ Ayna TV sync workflow finished successfully!"
