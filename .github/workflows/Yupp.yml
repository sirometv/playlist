name: Yupp TV

on:
  schedule:
    # ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶™‡¶∞ ‡¶™‡¶∞ ‡¶∞‡¶æ‡¶® ‡¶π‡¶¨‡ßá
    - cron: '*/5 * * * *'
  workflow_dispatch:  # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶®

permissions:
  contents: write

jobs:
  sync-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Bangladesh timezone
      run: |
        echo "üåè Setting up Bangladesh timezone..."
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶ú‡ßã‡¶® ‡¶∏‡ßá‡¶ü ‡¶Ü‡¶™
        sudo timedatectl set-timezone Asia/Dhaka
        echo "‚úÖ Bangladesh timezone set: $(TZ='Asia/Dhaka' date)"
        
    - name: Download YuppTV playlist (Secure)
      run: |
        echo "üì• Downloading YuppTV playlist from secure source..."
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        BD_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
        echo "üïê Download started at: $BD_TIME_READABLE"
        
        curl -s -L -o Yupp.m3u "${{ secrets.YUPPTV_PLAYLIST_URL }}"
        
        # ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
        if [ -f "Yupp.m3u" ] && [ -s "Yupp.m3u" ]; then
          LINES_COUNT=$(wc -l < Yupp.m3u)
          CHANNEL_COUNT=$(grep -c "#EXTINF:" Yupp.m3u 2>/dev/null || echo "0")
          echo "‚úÖ Playlist downloaded successfully"
          echo "üìä File details:"
          echo "   - Total lines: $LINES_COUNT"
          echo "   - Channel count: $CHANNEL_COUNT"
          echo "   - Download time: $BD_TIME"
        else
          echo "‚ùå Error: Failed to download playlist"
          exit 1
        fi
        
    - name: Add Bangladesh time header to playlist
      run: |
        echo "üïê Adding Bangladesh time information to playlist..."
        
        if [ -f "Yupp.m3u" ] && [ -s "Yupp.m3u" ]; then
          # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
          BD_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
          BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
          CHANNEL_COUNT=$(grep -c "#EXTINF:" Yupp.m3u 2>/dev/null || echo "0")
          
          # ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
          TEMP_FILE=$(mktemp)
          
          # ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
          echo "#EXTM3U" > "$TEMP_FILE"
          echo "# Yupp TV Playlist" >> "$TEMP_FILE"
          echo "# Total Channels: $CHANNEL_COUNT" >> "$TEMP_FILE"
          echo "# Updated: $BD_TIME" >> "$TEMP_FILE"
          echo "# Local Time: $BD_TIME_READABLE" >> "$TEMP_FILE"
          echo "# Auto-synced every 5 minutes" >> "$TEMP_FILE"
          echo "# Powered By: Sirome TV üî¥ ‡¶è‡¶á ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶ï ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßá‡¶â ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ú‡¶æ‡¶®‡¶æ‡¶®‡•§ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ‡¶ï‡ßá ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶æ‡¶® ‡¶ï‡¶∞‡¶ø, ‡¶§‡¶æ‡¶á ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶™‡¶æ‡¶∞‡ßá ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡¶¨ ‡¶®‡¶æ‡•§ üî¥ All the links in this file are collected from public sources. If anyone wants to remove their source, please let us know. We respect your opinions and efforts, so we will not object to removing your source." >> "$TEMP_FILE"
          echo "" >> "$TEMP_FILE"
          
          # ‡¶Ü‡¶∏‡¶≤ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
          cat Yupp.m3u >> "$TEMP_FILE"
          
          # ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶Æ‡ßÇ‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
          mv "$TEMP_FILE" Yupp.m3u
          
          echo "‚úÖ Bangladesh time header added successfully"
          echo "üîç First 5 lines of updated playlist:"
          head -5 Yupp.m3u
        else
          echo "‚ùå Error: Yupp.m3u file not found or empty"
          exit 1
        fi
        
    - name: Check if playlist changed
      id: check_changes
      run: |
        changes_detected=false
        
        if [ -f "Yupp.m3u" ] && [ -s "Yupp.m3u" ]; then
          # ‡¶´‡¶æ‡¶á‡¶≤ ‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá changes ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
          if ! git diff --quiet Yupp.m3u; then
            changes_detected=true
            echo "üîÑ Changes detected in Yupp.m3u"
            
            # ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            echo "üìä Changes summary:"
            git diff --stat Yupp.m3u
          else
            echo "‚úÖ No content changes detected"
          fi
        else
          changes_detected=true
          echo "üìù New Yupp.m3u file will be created"
        fi
        
        echo "changes_detected=$changes_detected" >> $GITHUB_OUTPUT
        
    - name: Commit and push if changes
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
        COMMIT_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        COMMIT_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p')
        
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add Yupp.m3u
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶π commit message
        commit_msg="üîÑ Auto-update YuppTV playlist - $COMMIT_TIME_READABLE"
        git commit -m "$commit_msg"
        
        echo "üöÄ Pushing changes to repository..."
        git push
        echo "‚úÖ Playlist updated successfully!"
        echo "üïê Next auto-sync in 5 minutes"
        
    - name: No changes detected
      if: steps.check_changes.outputs.changes_detected == 'false'
      run: |
        BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
        echo "‚úÖ No changes detected in playlist"
        echo "üïê Last checked: $BD_TIME_READABLE"
        echo "‚è∞ Next check in 5 minutes"
        
    - name: Cleanup and final report
      if: always()
      run: |
        BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
        echo "üèÅ Workflow completed at: $BD_TIME_READABLE"
        
        if [ -f "Yupp.m3u" ]; then
          LINES_COUNT=$(wc -l < Yupp.m3u)
          CHANNEL_COUNT=$(grep -c "#EXTINF:" Yupp.m3u 2>/dev/null || echo "0")
          echo "üìä Final playlist status:"
          echo "   - Total lines: $LINES_COUNT"
          echo "   - Channel count: $CHANNEL_COUNT"
          echo "   - File size: $(wc -c < Yupp.m3u) bytes"
        fi
        echo "‚úÖ Yupp TV sync process finished!"
