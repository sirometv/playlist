name: Yupp TV

on:
  schedule:
    # ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶™‡¶∞ ‡¶™‡¶∞ ‡¶∞‡¶æ‡¶® ‡¶π‡¶¨‡ßá
    - cron: '*/5 * * * *'
  workflow_dispatch:  # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶®

permissions:
  contents: write

jobs:
  sync-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Bangladesh timezone
      run: |
        echo "üåè Setting up Bangladesh timezone..."
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶ú‡ßã‡¶® ‡¶∏‡ßá‡¶ü ‡¶Ü‡¶™
        sudo timedatectl set-timezone Asia/Dhaka
        echo "‚úÖ Bangladesh timezone set: $(TZ='Asia/Dhaka' date)"
        
    - name: Download YuppTV playlist (Secure)
      run: |
        echo "üì• Downloading YuppTV playlist from secure source..."
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        BD_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
        echo "üïê Download started at: $BD_TIME_READABLE"
        
        curl -s -L -o original_yupp.m3u "${{ secrets.YUPPTV_PLAYLIST_URL }}"
        
        # ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
        if [ -f "original_yupp.m3u" ] && [ -s "original_yupp.m3u" ]; then
          LINES_COUNT=$(wc -l < original_yupp.m3u)
          CHANNEL_COUNT=$(grep -c "#EXTINF:" original_yupp.m3u 2>/dev/null || echo "0")
          echo "‚úÖ Playlist downloaded successfully"
          echo "üìä File details:"
          echo "   - Total lines: $LINES_COUNT"
          echo "   - Channel count: $CHANNEL_COUNT"
          echo "   - Download time: $BD_TIME"
        else
          echo "‚ùå Error: Failed to download playlist"
          exit 1
        fi
        
    - name: Remove unwanted headers and add custom header
      run: |
        echo "üé® Processing playlist - removing unwanted headers..."
        
        if [ -f "original_yupp.m3u" ] && [ -s "original_yupp.m3u" ]; then
          # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
          BD_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
          BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
          CHANNEL_COUNT=$(grep -c "#EXTINF:" original_yupp.m3u 2>/dev/null || echo "0")
          
          echo "üîç Removing unwanted headers and comments..."
          
          # Python script ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá unwanted headers ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
          python3 - << 'EOF'
          import re
          
          # Unwanted patterns to remove
          unwanted_patterns = [
              "By Abu SAEEID X Noob",
              "Scrapped by @abusaeeidx", 
              "Scrapped on",
              "Credit must be given. Otherwise it will be closed"
          ]
          
          with open('original_yupp.m3u', 'r', encoding='utf-8') as f:
              lines = f.readlines()
          
          filtered_lines = []
          removed_count = 0
          
          for line in lines:
              line_stripped = line.strip()
              should_keep = True
              
              # Check if line contains any unwanted pattern
              for pattern in unwanted_patterns:
                  if pattern in line_stripped:
                      print(f"üö´ Removing line: {line_stripped}")
                      should_keep = False
                      removed_count += 1
                      break
              
              # Keep EXTINF and URL lines (actual content)
              if should_keep and (line_stripped.startswith("#EXTINF:") or 
                                 line_stripped.startswith("http") or 
                                 line_stripped == "#EXTM3U" or
                                 line_stripped == ""):
                  filtered_lines.append(line)
              elif should_keep and not line_stripped.startswith("#"):
                  # Non-comment lines (URLs) keep them
                  filtered_lines.append(line)
          
          print(f"‚úÖ Removed {removed_count} unwanted lines")
          print(f"üìä Keeping {len(filtered_lines)} lines")
          
          # ‡¶®‡¶§‡ßÅ‡¶® ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶∏‡¶π ‡¶´‡¶æ‡¶á‡¶≤ ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
          with open('Yupp.m3u', 'w', encoding='utf-8') as f:
              # ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
              f.write("#EXTM3U\n")
              f.write("# Yupp TV Playlist\n")
              f.write("# Total Channels: {}\n".format(CHANNEL_COUNT))
              f.write("# Updated: {}\n".format("$BD_TIME"))
              f.write("# Local Time: {}\n".format("$BD_TIME_READABLE"))
              f.write("# Auto-synced every 5 minutes\n")
              f.write("# Powered By: Sirome TV üî¥ ‡¶è‡¶á ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶ï ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßá‡¶â ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ú‡¶æ‡¶®‡¶æ‡¶®‡•§ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ‡¶ï‡ßá ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶æ‡¶® ‡¶ï‡¶∞‡¶ø, ‡¶§‡¶æ‡¶á ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶™‡¶æ‡¶∞‡ßá ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡¶¨ ‡¶®‡¶æ‡•§ üî¥ All the links in this file are collected from public sources. If anyone wants to remove their source, please let us know. We respect your opinions and efforts, so we will not object to removing your source.\n")
              f.write("\n")
              
              # ‡¶´‡¶ø‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡ßç‡¶° ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
              for line in filtered_lines:
                  # ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶Ü‡¶∏‡¶≤ #EXTM3U ‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶® (‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶á‡¶§‡¶ø‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá‡¶õ‡¶ø)
                  if line.strip() == "#EXTM3U":
                      continue
                  f.write(line)
          
          EOF
          
          echo "‚úÖ Playlist processing completed"
          echo "üîç First 10 lines of processed playlist:"
          head -10 Yupp.m3u
          
          # ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡ßç‡¶≤‡¶ø‡¶®‡¶Ü‡¶™
          rm -f original_yupp.m3u
          
        else
          echo "‚ùå Error: Original playlist file not found"
          exit 1
        fi
        
    - name: Verify processed playlist
      run: |
        echo "üîç Verifying processed playlist..."
        
        if [ ! -f "Yupp.m3u" ] || [ ! -s "Yupp.m3u" ]; then
          echo "‚ùå ERROR: Processed file is missing or empty!"
          exit 1
        fi
        
        # ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡¶¶‡¶ø unwanted content ‡¶è‡¶ñ‡¶®‡¶ì ‡¶Ü‡¶õ‡ßá
        if grep -q "By Abu SAEEID X Noob" Yupp.m3u; then
          echo "‚ùå ERROR: Unwanted content 'By Abu SAEEID X Noob' still exists!"
          exit 1
        fi
        
        if grep -q "Scrapped by @abusaeeidx" Yupp.m3u; then
          echo "‚ùå ERROR: Unwanted content 'Scrapped by @abusaeeidx' still exists!"
          exit 1
        fi
        
        if grep -q "Credit must be given" Yupp.m3u; then
          echo "‚ùå ERROR: Unwanted content 'Credit must be given' still exists!"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < Yupp.m3u)
        LINES_COUNT=$(wc -l < Yupp.m3u)
        CHANNELS=$(grep -c "#EXTINF:" Yupp.m3u 2>/dev/null || echo "0")
        
        echo "‚úÖ File verification passed!"
        echo "üìã Final file details:"
        echo "   - Size: $FILE_SIZE bytes"
        echo "   - Lines: $LINES_COUNT"
        echo "   - Channels: $CHANNELS"
        echo "‚úÖ All unwanted content successfully removed!"
        
    - name: Check if playlist changed
      id: check_changes
      run: |
        changes_detected=false
        
        if [ -f "Yupp.m3u" ] && [ -s "Yupp.m3u" ]; then
          # ‡¶´‡¶æ‡¶á‡¶≤ ‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡¶≤‡ßá changes ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
          if ! git diff --quiet Yupp.m3u; then
            changes_detected=true
            echo "üîÑ Changes detected in Yupp.m3u"
            
            # ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®‡ßá‡¶∞ ‡¶¨‡¶ø‡¶∏‡ßç‡¶§‡¶æ‡¶∞‡¶ø‡¶§ ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
            echo "üìä Changes summary:"
            git diff --stat Yupp.m3u
          else
            echo "‚úÖ No content changes detected"
          fi
        else
          changes_detected=true
          echo "üìù New Yupp.m3u file will be created"
        fi
        
        echo "changes_detected=$changes_detected" >> $GITHUB_OUTPUT
        
    - name: Commit and push if changes
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
        COMMIT_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        COMMIT_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p')
        
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add Yupp.m3u
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶π commit message
        commit_msg="üîÑ Auto-update YuppTV playlist - $COMMIT_TIME_READABLE"
        git commit -m "$commit_msg"
        
        echo "üöÄ Pushing changes to repository..."
        git push
        echo "‚úÖ Playlist updated successfully!"
        echo "üïê Next auto-sync in 5 minutes"
        
    - name: No changes detected
      if: steps.check_changes.outputs.changes_detected == 'false'
      run: |
        BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
        echo "‚úÖ No changes detected in playlist"
        echo "üïê Last checked: $BD_TIME_READABLE"
        echo "‚è∞ Next check in 5 minutes"
        
    - name: Cleanup and final report
      if: always()
      run: |
        BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
        echo "üèÅ Workflow completed at: $BD_TIME_READABLE"
        
        if [ -f "Yupp.m3u" ]; then
          LINES_COUNT=$(wc -l < Yupp.m3u)
          CHANNEL_COUNT=$(grep -c "#EXTINF:" Yupp.m3u 2>/dev/null || echo "0")
          echo "üìä Final playlist status:"
          echo "   - Total lines: $LINES_COUNT"
          echo "   - Channel count: $CHANNEL_COUNT"
          echo "   - File size: $(wc -c < Yupp.m3u) bytes"
        fi
        echo "‚úÖ Yupp TV sync process finished!"
