name: Ayna TV Auto Sync ЁЯХР

on:
  schedule:
    # ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рж┐ рж╕ржорзЯ ржЕржирзБржпрж╛рзЯрзА ржкрзНрж░рждрж┐ ржШржирзНржЯрж╛рж░ 08, 18, 28, 38, 48, 58 ржорж┐ржирж┐ржЯрзЗ
    - cron: '8,18,28,38,48,58 * * * *'
  workflow_dispatch:
    inputs:
      reason:
        description: 'ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓рж┐ рж░рж╛ржи ржХрж░рж╛рж░ ржХрж╛рж░ржг'
        required: false
        default: 'Manual trigger'

permissions:
  contents: write

jobs:
  update-playlist:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main
        
    - name: Setup environment
      run: |
        echo "ЁЯФз Setting up environment..."
        # ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ ржЯрж╛ржЗржоржЬрзЛржи рж╕рзЗржЯ ржХрж░рж┐
        sudo timedatectl set-timezone Asia/Dhaka
        # ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рж┐ рж╕ржорзЯ рж╕ржВржЧрзНрж░рж╣
        BD_FULL_TIME=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ рж╕ржорзЯ')
        BD_HOUR=$(TZ='Asia/Dhaka' date +'%I')
        BD_MINUTE=$(TZ='Asia/Dhaka' date +'%M')
        BD_AMPM=$(TZ='Asia/Dhaka' date +'%p')
        
        echo "ЁЯХР ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ рж╕ржорзЯ: $BD_FULL_TIME"
        echo "тП░ рж╕рж┐ржЩрзНржХ рж╕ржорзЯ: $BD_HOUR:$BD_MINUTE$BD_AMPM"
        echo "ЁЯФД ржкрж░ржмрж░рзНрждрзА рж╕рж┐ржЩрзНржХ: ржкрзНрж░рждрж┐ ржШржирзНржЯрж╛рж░ 08, 18, 28, 38, 48, 58 ржорж┐ржирж┐ржЯрзЗ"
        
        # ржкрж░рж┐ржмрзЗрж╢ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ рж╕рзЗржЯ ржХрж░рзБржи
        echo "BD_TIME=$BD_FULL_TIME" >> $GITHUB_ENV
        echo "SYNC_TIME=$BD_HOUR:$BD_MINUTE$BD_AMPM" >> $GITHUB_ENV
        echo "BD_HOUR=$BD_HOUR" >> $GITHUB_ENV
        echo "BD_MINUTE=$BD_MINUTE" >> $GITHUB_ENV
        echo "BD_AMPM=$BD_AMPM" >> $GITHUB_ENV
        
    - name: Download playlist from AYNA_STROWETV
      run: |
        echo "ЁЯУе ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..."
        
        # ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ ржерзЗржХрзЗ URL ржирж┐ржи
        PLAYLIST_URL="${{ vars.AYNA_STROWETV }}"
        
        if [ -z "$PLAYLIST_URL" ] || [ "$PLAYLIST_URL" = "" ]; then
          echo "тЭМ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ AYNA_STROWETV ржЦрж╛рж▓рж┐!"
          echo "ЁЯФз рж╕ржорж╛ржзрж╛ржи:"
          echo "  1. Repository-ржПрж░ Settings-ржП ржпрж╛ржи"
          echo "  2. Secrets and variables > Actions"
          echo "  3. Variables ржЯрзНржпрж╛ржм ржП ржХрзНрж▓рж┐ржХ ржХрж░рзБржи"
          echo "  4. AYNA_STROWETV ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ рж╕рзЗржЯ ржХрж░рзБржи"
          exit 1
        fi
        
        echo "ЁЯФЧ URL: $(echo $PLAYLIST_URL | cut -c1-60)..."
        
        # ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржи
        if curl -s -L "$PLAYLIST_URL" -o original.m3u --max-time 30; then
          echo "тЬЕ ржбрж╛ржЙржирж▓рзЛржб рж╕ржлрж▓"
        else
          echo "тЭМ ржбрж╛ржЙржирж▓рзЛржб ржмрзНржпрж░рзНрже, alternative ржЪрзЗрж╖рзНржЯрж╛ ржХрж░ржЫрж┐..."
          # Alternative download method
          wget -q -O original.m3u "$PLAYLIST_URL" || exit 1
        fi
        
        # ржлрж╛ржЗрж▓ ржЪрзЗржХ ржХрж░рзБржи
        if [ ! -f "original.m3u" ]; then
          echo "тЭМ ржлрж╛ржЗрж▓ рждрзИрж░рж┐ рж╣ржпрж╝ржирж┐!"
          exit 1
        fi
        
        if [ ! -s "original.m3u" ]; then
          echo "тЭМ ржлрж╛ржЗрж▓ ржЦрж╛рж▓рж┐!"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < original.m3u)
        LINE_COUNT=$(wc -l < original.m3u)
        CHANNEL_COUNT=$(grep -c "#EXTINF:" original.m3u)
        
        echo "ЁЯУК ржбрж╛ржЙржирж▓рзЛржб ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи:"
        echo "  ржлрж╛ржЗрж▓рзЗрж░ рж╕рж╛ржЗржЬ: $FILE_SIZE bytes"
        echo "  рж▓рж╛ржЗржирзЗрж░ рж╕ржВржЦрзНржпрж╛: $LINE_COUNT"
        echo "  ржЪрзНржпрж╛ржирзЗрж▓рзЗрж░ рж╕ржВржЦрзНржпрж╛: $CHANNEL_COUNT"
        
        # Temporary file рж╕рзЗржн ржХрж░рзБржи
        echo "CHANNEL_COUNT=$CHANNEL_COUNT" >> $GITHUB_ENV
        echo "ORIGINAL_LINES=$LINE_COUNT" >> $GITHUB_ENV
        
    - name: Process and clean playlist
      run: |
        echo "ЁЯз╣ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржкрж░рж┐рж╖рзНржХрж╛рж░ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..."
        
        # ржкрзНрж░ржержорзЗ рж╢рзБржзрзБ header рждрзИрж░рж┐ ржХрж░рзБржи
        cat > Ayna.m3u << HEADER
#EXTM3U
# Sirome TV Playlist
# Source: ${{ vars.AYNA_STROWETV }}
# Total Channels: ${{ env.CHANNEL_COUNT }}
# Updated: $(date +'%Y-%m-%d %H:%M:%S UTC')
# Bangladesh Time: ${{ env.BD_TIME }}
# Sync Time: ${{ env.SYNC_TIME }}
# Next Sync: Every hour at :08, :18, :28, :38, :48, :58 minutes
# 
# Powered-By: BDIX 
# ЁЯФ┤ ржПржЗ ржлрж╛ржЗрж▓рзЗрж░ рж╕ржорж╕рзНржд рж▓рж┐ржЩрзНржХ ржкрж╛ржмрж▓рж┐ржХ рж╕рзЛрж░рзНрж╕ ржерзЗржХрзЗ рж╕ржВржЧрзНрж░рж╣ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред 
# ЁЯФ┤ ржпржжрж┐ ржХрзЗржЙ рждрж╛ржжрзЗрж░ рж╕рзЛрж░рзНрж╕ ржорзБржЫрзЗ ржлрзЗрж▓рждрзЗ ржЪрж╛ржи, рждрж╛рж╣рж▓рзЗ ржжржпрж╝рж╛ ржХрж░рзЗ ржЖржорж╛ржжрзЗрж░ ржЬрж╛ржирж╛ржиред 
# ЁЯФ┤ ржЖржорж░рж╛ ржЖржкржирж╛рж░ ржорждрж╛ржоржд ржПржмржВ ржкрзНрж░ржЪрзЗрж╖рзНржЯрж╛ржХрзЗ рж╕ржорзНржорж╛ржи ржХрж░рж┐, рждрж╛ржЗ ржЖржкржирж╛рж░ рж╕рзЛрж░рзНрж╕ ржорзБржЫрзЗ ржлрзЗрж▓рж╛рж░ ржмрзНржпрж╛ржкрж╛рж░рзЗ ржЖржорж░рж╛ ржЖржкрждрзНрждрж┐ ржХрж░ржм ржирж╛ред 
# 
# ЁЯФ┤ All the links in this file are collected from public sources.
# ЁЯФ┤ If anyone wants to remove their source, please let us know.
# ЁЯФ┤ We respect your opinions and efforts, so we will not object to removing your source.
# 

HEADER
        
        # ржПржЦржи content ржпрзЛржЧ ржХрж░рзБржи (unwanted content ржмрж╛ржж ржжрж┐ржпрж╝рзЗ)
        echo "ЁЯФН Unwanted content ржлрж┐рж▓рзНржЯрж╛рж░ ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..."
        
        # grep ржжрж┐ржпрж╝рзЗ рж╕рж░рж╛рж╕рж░рж┐ ржлрж┐рж▓рзНржЯрж╛рж░ ржХрж░рзБржи
        grep -v "^#EXTM3U$" original.m3u | \
        grep -v "Created by @AbuSaeedX" | \
        grep -v "# Total channels:" | \
        grep -v "# Generated:" | \
        grep -v "X fire Flix" | \
        grep -v "byxfireflix/BY-X-FIRE-FLIX.mp4" | \
        grep -v "BY-X-FIRE-FLIX.mp4" >> Ayna.m3u
        
        echo "тЬЕ ржлрж┐рж▓рзНржЯрж╛рж░рж┐ржВ рж╕ржорзНржкржирзНржи"
        
        # ржлрж▓рж╛ржлрж▓ ржЪрзЗржХ ржХрж░рзБржи
        FINAL_LINES=$(wc -l < Ayna.m3u)
        FINAL_CHANNELS=$(grep -c "#EXTINF:" Ayna.m3u)
        
        echo "ЁЯУК ржкрзНрж░рж╕рзЗрж╕рж┐ржВ ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи:"
        echo "  ржорзВрж▓ рж▓рж╛ржЗржи: ${{ env.ORIGINAL_LINES }}"
        echo "  ржЪрзВржбрж╝рж╛ржирзНржд рж▓рж╛ржЗржи: $FINAL_LINES"
        echo "  ржорзВрж▓ ржЪрзНржпрж╛ржирзЗрж▓: ${{ env.CHANNEL_COUNT }}"
        echo "  ржЪрзВржбрж╝рж╛ржирзНржд ржЪрзНржпрж╛ржирзЗрж▓: $FINAL_CHANNELS"
        echo "  рж╕рж░рж╛ржирзЛ ржЪрзНржпрж╛ржирзЗрж▓: $((${{ env.CHANNEL_COUNT }} - $FINAL_CHANNELS))"
        
        # ржкрж░рж┐ржмрзЗрж╢ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ рж╕рзЗржЯ ржХрж░рзБржи
        echo "FINAL_CHANNELS=$FINAL_CHANNELS" >> $GITHUB_ENV
        echo "FINAL_LINES=$FINAL_LINES" >> $GITHUB_ENV
        
        # Temporary file ржорзБржЫрзБржи
        rm -f original.m3u
        
    - name: Verify processed file
      run: |
        echo "ЁЯФН ржлрж╛ржЗрж▓ ржнрзЗрж░рж┐ржлрж┐ржХрзЗрж╢ржи..."
        
        if [ ! -f "Ayna.m3u" ]; then
          echo "тЭМ Ayna.m3u ржлрж╛ржЗрж▓ ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐!"
          exit 1
        fi
        
        if [ ! -s "Ayna.m3u" ]; then
          echo "тЭМ Ayna.m3u ржлрж╛ржЗрж▓ ржЦрж╛рж▓рж┐!"
          exit 1
        fi
        
        # ржлрж╛ржЗрж▓ ржмрзИржзрждрж╛ ржкрж░рзАржХрзНрж╖рж╛ ржХрж░рзБржи
        if ! head -1 Ayna.m3u | grep -q "#EXTM3U"; then
          echo "тЭМ ржлрж╛ржЗрж▓ M3U ржлрж░ржорзНржпрж╛ржЯрзЗ ржирзЗржЗ!"
          exit 1
        fi
        
        # Unwanted content ржЪрзЗржХ ржХрж░рзБржи
        UNWANTED_FOUND=0
        
        if grep -q "Created by @AbuSaeedX" Ayna.m3u; then
          echo "тЪая╕П Warning: 'Created by @AbuSaeedX' found in file"
          UNWANTED_FOUND=1
        fi
        
        if grep -q "X fire Flix" Ayna.m3u; then
          echo "тЪая╕П Warning: 'X fire Flix' found in file"
          UNWANTED_FOUND=1
        fi
        
        if [ $UNWANTED_FOUND -eq 0 ]; then
          echo "тЬЕ ржХрзЛржи unwanted content ржкрж╛ржУржпрж╝рж╛ ржпрж╛ржпрж╝ржирж┐"
        fi
        
        # ржлрж╛ржЗрж▓ рждржерзНржп ржжрзЗржЦрж╛ржи
        echo "ЁЯУЛ ржлрж╛ржЗрж▓ ржмрж┐ржмрж░ржг:"
        echo "  ржлрж╛ржЗрж▓рзЗрж░ рж╕рж╛ржЗржЬ: $(wc -c < Ayna.m3u) bytes"
        echo "  рж▓рж╛ржЗржирзЗрж░ рж╕ржВржЦрзНржпрж╛: $(wc -l < Ayna.m3u)"
        echo "  ржЪрзНржпрж╛ржирзЗрж▓рзЗрж░ рж╕ржВржЦрзНржпрж╛: $(grep -c "#EXTINF:" Ayna.m3u)"
        
        # ржкрзНрж░ржержо ржХржпрж╝рзЗржХржЯрж┐ ржЪрзНржпрж╛ржирзЗрж▓ ржжрзЗржЦрж╛ржи
        echo "ЁЯФН ржкрзНрж░ржержо рзлржЯрж┐ ржЪрзНржпрж╛ржирзЗрж▓:"
        grep -A1 "#EXTINF:" Ayna.m3u | head -10
        
    - name: Commit and push changes
      run: |
        echo "ЁЯТ╛ ржкрж░рж┐ржмрж░рзНрждржиржЧрзБрж▓рж┐ рж╕ржВрж░ржХрзНрж╖ржг ржХрж░рж╛ рж╣ржЪрзНржЫрзЗ..."
        
        # Git ржХржиржлрж┐ржЧрж╛рж░ ржХрж░рзБржи
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # ржлрж╛ржЗрж▓ ржпрзЛржЧ ржХрж░рзБржи
        git add Ayna.m3u
        
        # ржкрж░рж┐ржмрж░рзНрждржиржЧрзБрж▓рж┐ ржЪрзЗржХ ржХрж░рзБржи
        if git diff --staged --quiet; then
          echo "тЬЕ ржХрзЛржи ржкрж░рж┐ржмрж░рзНрждржи ржирзЗржЗ - ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржЖржк ржЯрзБ ржбрзЗржЯ"
          echo "тП░ ржкрж░ржмрж░рзНрждрзА рж╕рж┐ржЩрзНржХ: $(TZ='Asia/Dhaka' date -d '+1 hour' +'%I:%M %p') ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ рж╕ржорзЯ"
        else
          # ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рж┐ рж╕ржорзЯрзЗ commit message рждрзИрж░рж┐ ржХрж░рзБржи
          COMMIT_TIME=$(TZ='Asia/Dhaka' date +'%I:%M %p ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ рж╕ржорзЯ')
          COMMIT_DATE=$(TZ='Asia/Dhaka' date +'%Y-%m-%d')
          
          # Commit ржХрж░рзБржи
          git commit -m "ЁЯФД Ayna TV Auto Update - $COMMIT_TIME" \
                     -m "ржЪрзНржпрж╛ржирзЗрж▓: ${{ env.FINAL_CHANNELS }}ржЯрж┐" \
                     -m "рж╕рж┐ржЩрзНржХ рж╕ржорзЯ: ${{ env.SYNC_TIME }}" \
                     -m "рждрж╛рж░рж┐ржЦ: $COMMIT_DATE" \
                     -m "ржкрж░ржмрж░рзНрждрзА рж╕рж┐ржЩрзНржХ: ржкрзНрж░рждрж┐ ржШржирзНржЯрж╛рж░ 08, 18, 28, 38, 48, 58 ржорж┐ржирж┐ржЯрзЗ"
          
          # Push ржХрж░рзБржи
          if git push; then
            echo "ЁЯОЙ рж╕ржлрж▓ржнрж╛ржмрзЗ ржЖржкржбрзЗржЯ ржХрж░рж╛ рж╣рзЯрзЗржЫрзЗ!"
            echo "ЁЯУК ржЖржкржбрзЗржЯ ржкрж░рж┐рж╕ржВржЦрзНржпрж╛ржи:"
            echo "  ржЪрзНржпрж╛ржирзЗрж▓: ${{ env.FINAL_CHANNELS }}ржЯрж┐"
            echo "  рж╕ржорзЯ: ${{ env.SYNC_TIME }} ржмрж╛ржВрж▓рж╛ржжрзЗрж╢"
            echo "тП░ ржкрж░ржмрж░рзНрждрзА рж╕рж┐ржЩрзНржХ: ржкрзНрж░рждрж┐ ржШржирзНржЯрж╛рж░ 08, 18, 28, 38, 48, 58 ржорж┐ржирж┐ржЯрзЗ"
            
            # Update time рж▓ржЧ ржХрж░рзБржи
            echo "LAST_UPDATE=$(date)" >> $GITHUB_ENV
          else
            echo "тЭМ Git push ржмрзНржпрж░рзНрже!"
            exit 1
          fi
        fi
        
    - name: Success notification
      if: success()
      run: |
        echo "========================================"
        echo "тЬЕ AYNA TV AUTO SYNC COMPLETED SUCCESSFULLY"
        echo "========================================"
        echo "ЁЯХР ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ рж╕ржорзЯ: ${{ env.BD_TIME }}"
        echo "тП░ рж╕рж┐ржЩрзНржХ рж╕ржорзЯ: ${{ env.SYNC_TIME }}"
        echo "ЁЯУК ржЪрзНржпрж╛ржирзЗрж▓ рж╕ржВржЦрзНржпрж╛: ${{ env.FINAL_CHANNELS }}ржЯрж┐"
        echo "ЁЯУБ ржлрж╛ржЗрж▓: https://github.com/${{ github.repository }}/blob/main/Ayna.m3u"
        echo "ЁЯФД ржкрж░ржмрж░рзНрждрзА рж╕рж┐ржЩрзНржХ: ржкрзНрж░рждрж┐ ржШржирзНржЯрж╛рж░ 08, 18, 28, 38, 48, 58 ржорж┐ржирж┐ржЯрзЗ"
        echo "========================================"
        
    - name: Failure notification
      if: failure()
      run: |
        echo "========================================"
        echo "тЭМ AYNA TV AUTO SYNC FAILED"
        echo "========================================"
        echo "ЁЯХР ржмрж╛ржВрж▓рж╛ржжрзЗрж╢ рж╕ржорзЯ: ${{ env.BD_TIME }}"
        echo "тЪая╕П Error detected in step: ${{ job.status }}"
        echo "ЁЯФз ржЯрзНрж░рж╛ржмрж▓рж╢рзБржЯрж┐ржВ:"
        echo "  1. AYNA_STROWETV ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓ ржЪрзЗржХ ржХрж░рзБржи"
        echo "  2. ржЗржирзНржЯрж╛рж░ржирзЗржЯ ржХрж╛ржирзЗржХрж╢ржи ржЪрзЗржХ ржХрж░рзБржи"
        echo "  3. URL accessibility ржЪрзЗржХ ржХрж░рзБржи"
        echo "========================================"
