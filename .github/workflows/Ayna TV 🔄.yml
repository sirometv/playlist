name: Ayna TV üîÑ 

on:
  schedule:
    # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡¶ø ‡¶∏‡¶Æ‡ßü ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡¶∞ 08, 18, 28, 38, 48, 58 ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá
    - cron: '8,18,28,38,48,58 * * * *'
  workflow_dispatch:  # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶®

permissions:
  contents: write

jobs:
  sync-ayna:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Bangladesh timezone
      run: |
        echo "üåè Setting up Bangladesh timezone..."
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶ú‡ßã‡¶® ‡¶∏‡ßá‡¶ü ‡¶Ü‡¶™
        sudo timedatectl set-timezone Asia/Dhaka
        echo "‚úÖ Bangladesh timezone set: $(date)"
        
    - name: Display current Bangladesh time
      run: |
        echo "üïê Current Bangladesh Time:"
        TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p'
        echo "‚úÖ Next runs will be at: xx:08, xx:18, xx:28, xx:38, xx:48, xx:58 (Bangladesh Time)"
        
    - name: Download original playlist
      run: |
        echo "üîÑ Starting Ayna TV playlist sync..."
        echo "üì• Downloading from secure source..."
        
        # AYNA_STROWETV variable ‡¶•‡ßá‡¶ï‡ßá URL ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
        echo "Using URL from AYNA_STROWETV variable"
        
        # ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü/Variable ‡¶•‡ßá‡¶ï‡ßá ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        curl -s -L -o original_playlist.m3u "${{ vars.AYNA_STROWETV }}"
        
        # ‡¶Ö‡¶≤‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü‡¶ø‡¶≠ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá secrets ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ (‡¶Ø‡¶¶‡¶ø variable ‡¶ï‡¶æ‡¶ú ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá)
        if [ ! -f "original_playlist.m3u" ] || [ ! -s "original_playlist.m3u" ]; then
          echo "‚ö†Ô∏è Trying alternative URL from secrets..."
          curl -s -L -o original_playlist.m3u "${{ secrets.SIROMETV_AYNA }}"
        fi
        
        # ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
        if [ ! -f "original_playlist.m3u" ] || [ ! -s "original_playlist.m3u" ]; then
          echo "‚ùå ERROR: Playlist download failed!"
          echo "Please check if AYNA_STROWETV variable is set correctly in repository settings"
          exit 1
        fi
        
        ORIGINAL_LINES=$(wc -l < original_playlist.m3u)
        echo "‚úÖ Download successful - $ORIGINAL_LINES lines"
        
    - name: Process and customize playlist
      run: |
        echo "üé® Customizing playlist with Sirome TV branding..."
        
        # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π (‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶∞‡¶ø‡¶Æ‡ßÅ‡¶≠ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ü‡¶ó‡ßá)
        CHANNEL_COUNT=$(grep -c "#EXTINF:" original_playlist.m3u)
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶≤‡ßã‡¶ï‡¶æ‡¶≤ ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
        CURRENT_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
        BD_HOUR=$(TZ='Asia/Dhaka' date +'%I')
        BD_MINUTE=$(TZ='Asia/Dhaka' date +'%M')
        BD_AMPM=$(TZ='Asia/Dhaka' date +'%p')
        
        echo "üïê Current Bangladesh Time: $BD_TIME_READABLE"
        echo "‚è∞ Sync time: $BD_HOUR:$BD_MINUTE$BD_AMPM"
        
        # ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶æ‡¶∏‡ßç‡¶ü‡¶Æ ‡¶π‡ßá‡¶°‡¶æ‡¶∞ ‡¶§‡ßà‡¶∞‡¶ø
        echo "#EXTM3U" > Ayna.m3u
        echo "# Sirome TV" >> Ayna.m3u
        echo "# Total channels: $CHANNEL_COUNT" >> Ayna.m3u
        echo "# Updated: $CURRENT_TIME" >> Ayna.m3u
        echo "# Local Time: $BD_TIME_READABLE" >> Ayna.m3u
        echo "# Sync Time: $BD_HOUR:$BD_MINUTE$BD_AMPM (Bangladesh)" >> Ayna.m3u
        echo "# Powered-By: BDIX üî¥ ‡¶è‡¶á ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶§ ‡¶≤‡¶ø‡¶ô‡ßç‡¶ï ‡¶™‡¶æ‡¶¨‡¶≤‡¶ø‡¶ï ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶æ ‡¶π‡¶Ø‡¶º‡ßá‡¶õ‡ßá‡•§ ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßá‡¶â ‡¶§‡¶æ‡¶¶‡ßá‡¶∞ ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶§‡ßá ‡¶ö‡¶æ‡¶®, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶¶‡¶Ø‡¶º‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ ‡¶ú‡¶æ‡¶®‡¶æ‡¶®‡•§ ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Æ‡¶§‡¶æ‡¶Æ‡¶§ ‡¶è‡¶¨‡¶Ç ‡¶™‡ßç‡¶∞‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ‡¶ï‡ßá ‡¶∏‡¶Æ‡ßç‡¶Æ‡¶æ‡¶® ‡¶ï‡¶∞‡¶ø, ‡¶§‡¶æ‡¶á ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶Æ‡ßÅ‡¶õ‡ßá ‡¶´‡ßá‡¶≤‡¶æ‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶™‡¶æ‡¶∞‡ßá ‡¶Ü‡¶Æ‡¶∞‡¶æ ‡¶Ü‡¶™‡¶§‡ßç‡¶§‡¶ø ‡¶ï‡¶∞‡¶¨ ‡¶®‡¶æ‡•§ üî¥ All the links in this file are collected from public sources. If anyone wants to remove their source, please let us know. We respect your opinions and efforts, so we will not object to removing your source." >> Ayna.m3u
        echo "" >> Ayna.m3u
        
        # Python script ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç
        python3 - << 'EOF'
        import base64
        
        # Base64 encoded patterns
        encoded_patterns = [
            "Q3JlYXRlZCBieSBAQWJ1U2FlZWRY",  # Created by @AbuSaeedX
            "IyBUb3RhbCBjaGFubmVsczo=",      # # Total channels:
            "IyBHZW5lcmF0ZWQ6",              # # Generated:
            "WCBmaXJlIEZsaXg=",              # X fire Flix
            "Ynl4ZmlyZWZsaXgvQlktWC1GSVJFLUZMSVgubXA0"  # byxfireflix/BY-X-FIRE-FLIX.mp4
        ]
        
        # Decode patterns
        patterns = [base64.b64decode(pattern.encode()).decode() for pattern in encoded_patterns]
        
        print("Patterns to remove:")
        for i, pattern in enumerate(patterns):
            print(f"  {i+1}. {pattern}")
        
        with open('original_playlist.m3u', 'r', encoding='utf-8') as f:
            lines = f.readlines()
        
        filtered_lines = []
        skip_next = False
        removed_count = 0
        
        for i, line in enumerate(lines):
            line_stripped = line.strip()
            
            # Skip #EXTM3U line from original (we already added our own)
            if line_stripped == "#EXTM3U":
                print("üö´ Removing original #EXTM3U")
                removed_count += 1
                continue
                
            # Check if this line should be skipped
            should_skip = False
            for pattern in patterns:
                if pattern in line_stripped:
                    print(f"üö´ Removing line: {line_stripped[:50]}...")
                    should_skip = True
                    removed_count += 1
                    
                    # If this is an EXTINF line, skip the next line (URL) too
                    if line_stripped.startswith("#EXTINF:"):
                        skip_next = True
                    break
            
            if should_skip:
                continue
                
            # Skip next line if previous was EXTINF that we removed
            if skip_next:
                print(f"üö´ Removing URL line: {line_stripped[:50]}...")
                skip_next = False
                removed_count += 1
                continue
            
            # Keep the line
            filtered_lines.append(line)
        
        # Add filtered content to our file (append mode)
        with open('Ayna.m3u', 'a', encoding='utf-8') as f:
            f.writelines(filtered_lines)
        
        print(f"‚úÖ Processing completed!")
        print(f"üìä Removed {removed_count} lines")
        print(f"üìä Kept {len(filtered_lines)} lines")
        EOF
        
        # ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶ö‡ßá‡¶ï
        FINAL_LINES=$(wc -l < Ayna.m3u)
        FINAL_CHANNELS=$(grep -c "#EXTINF:" Ayna.m3u)
        
        echo "‚ú® Customization completed!"
        echo "üìä Final Statistics:"
        echo "   Original lines: $ORIGINAL_LINES"
        echo "   Final lines: $FINAL_LINES"
        echo "   Original channels: $CHANNEL_COUNT"
        echo "   Final channels: $FINAL_CHANNELS"
        echo "   Removed channels: $((CHANNEL_COUNT - FINAL_CHANNELS))"
        
        # ‡¶∏‡¶æ‡¶Æ‡ßç‡¶™‡ßç‡¶≤ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        echo "üîç First 10 lines of processed playlist:"
        head -10 Ayna.m3u
        
        # ‡¶ü‡ßá‡¶Æ‡ßç‡¶™‡ßã‡¶∞‡¶æ‡¶∞‡¶ø ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ï‡ßç‡¶≤‡¶ø‡¶®‡¶Ü‡¶™
        rm -f original_playlist.m3u
        
    - name: Verify processed file
      run: |
        echo "üîç Verifying processed playlist..."
        
        if [ ! -f "Ayna.m3u" ] || [ ! -s "Ayna.m3u" ]; then
          echo "‚ùå ERROR: Processed file is missing or empty!"
          exit 1
        fi
        
        # ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡¶¶‡¶ø unwanted content ‡¶è‡¶ñ‡¶®‡¶ì ‡¶Ü‡¶õ‡ßá
        if grep -q "Created by @AbuSaeedX" Ayna.m3u; then
          echo "‚ùå ERROR: Unwanted content still exists!"
          exit 1
        fi
        
        if grep -q "X fire Flix" Ayna.m3u; then
          echo "‚ùå ERROR: X fire Flix still exists!"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < Ayna.m3u)
        LINES_COUNT=$(wc -l < Ayna.m3u)
        CHANNELS=$(grep -c "#EXTINF:" Ayna.m3u)
        
        echo "‚úÖ File verification passed!"
        echo "üìã File details:"
        echo "   Size: $FILE_SIZE bytes"
        echo "   Lines: $LINES_COUNT"
        echo "   Channels: $CHANNELS"
        echo "‚úÖ All unwanted content successfully removed!"
        
    - name: Commit and push changes
      run: |
        echo "üíæ Saving changes to repository..."
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶ü‡¶æ‡¶á‡¶Æ ‡¶¶‡¶ø‡¶Ø‡¶º‡ßá commit message ‡¶§‡ßà‡¶∞‡¶ø
        COMMIT_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        BD_HOUR=$(TZ='Asia/Dhaka' date +'%I')
        BD_MINUTE=$(TZ='Asia/Dhaka' date +'%M')
        BD_AMPM=$(TZ='Asia/Dhaka' date +'%p')
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add Ayna.m3u
        
        # ‡¶∂‡ßÅ‡¶ß‡ßÅ changes ‡¶•‡¶æ‡¶ï‡¶≤‡ßá commit ‡¶ï‡¶∞‡ßÅ‡¶®
        if git diff --staged --quiet; then
          echo "‚úÖ No changes detected - playlist is up to date"
          echo "‚è∞ Next auto-sync at: $BD_HOUR:08, $BD_HOUR:18, $BD_HOUR:28, $BD_HOUR:38, $BD_HOUR:48, $BD_HOUR:58$BD_AMPM (Bangladesh Time)"
        else
          git commit -m "üîÑ Ayna TV Auto Sync - $BD_HOUR:$BD_MINUTE$BD_AMPM Bangladesh Time"
          git push
          echo "üéâ Successfully updated Ayna.m3u with Sirome TV branding!"
          echo "‚è∞ Next auto-sync at: $BD_HOUR:08, $BD_HOUR:18, $BD_HOUR:28, $BD_HOUR:38, $BD_HOUR:48, $BD_HOUR:58$BD_AMPM (Bangladesh Time)"
        fi
        
    - name: Cleanup on success
      if: success()
      run: |
        echo "üßπ Cleanup completed"
        echo "‚úÖ Ayna TV sync workflow finished successfully!"
        echo "üîÑ This workflow runs every hour at:"
        echo "   08, 18, 28, 38, 48, 58 minutes past each hour"
