name: Sync Somoy TV Channel

on:
  schedule:
    # ржкрзНрж░рждрж┐ рзл ржорж┐ржирж┐ржЯ ржкрж░ ржкрж░ ржЖржкржбрзЗржЯ рж╣ржмрзЗ
    - cron: '*/5 * * * *'
  workflow_dispatch:  # ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓рж┐ рж░рж╛ржи ржХрж░рж╛рж░ ржЕржкрж╢ржи

permissions:
  contents: write

jobs:
  sync-somoy-tv:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download playlists
      run: |
        echo "ЁЯУе Downloading playlists..."
        
        # ржорзЗржЗржи ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржбрж╛ржЙржирж▓рзЛржб
        curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        
        # рж╕рзЛрж░рзНрж╕ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржбрж╛ржЙржирж▓рзЛржб
        curl -s -L -o source_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/Ayna.m3u"
        
        # ржбрж╛ржЙржирж▓рзЛржб рж╕ржлрж▓ рж╣рзЯрзЗржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ
        for file in main_playlist.m3u source_playlist.m3u; do
          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "тЭМ ERROR: $file download failed!"
            exit 1
          fi
          LINES=$(wc -l < "$file")
          echo "тЬЕ $file downloaded - $LINES lines"
        done
        
    - name: Update Somoy TV URL
      run: |
        echo "ЁЯФД Updating Somoy TV URL..."
        
        python3 - << 'EOF'
        import re
        
        def find_somoy_tv_url(source_file):
            """рж╕рзЛрж░рзНрж╕ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржерзЗржХрзЗ Somoy TV ржПрж░ URL ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рзЗ"""
            with open(source_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # "Somoy News TV" ржирж╛ржорзЗрж░ ржЪрзНржпрж╛ржирзЗрж▓ ржЦрзБржБржЬрзБржи
            pattern = r'#EXTINF:[^\n]*Somoy News TV[^\n]*\n(http[^\n]+)'
            match = re.search(pattern, content, re.IGNORECASE)
            
            if match:
                url = match.group(1).strip()
                print(f"тЬЕ Found Somoy News TV URL: {url}")
                return url
            else:
                print("тЭМ Somoy News TV not found in source playlist")
                return None
        
        def update_main_playlist(main_file, new_url):
            """ржорзЗржЗржи ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯрзЗ Somoy TV ржПрж░ URL ржЖржкржбрзЗржЯ ржХрж░рзЗ"""
            with open(main_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # "Somoy TV" ржЪрзНржпрж╛ржирзЗрж▓ ржЦрзБржБржЬрзБржи ржПржмржВ рждрж╛рж░ URL ржЖржкржбрзЗржЯ ржХрж░рзБржи
            pattern = r'(#EXTINF:[^\n]*Somoy TV[^\n]*\n)(http[^\n]+)'
            
            if re.search(pattern, content, re.IGNORECASE):
                # ржирждрзБржи URL ржжрж┐рзЯрзЗ рж░рж┐ржкрзНрж▓рзЗрж╕ ржХрж░рзБржи
                updated_content = re.sub(
                    pattern, 
                    r'\1' + new_url, 
                    content, 
                    flags=re.IGNORECASE
                )
                print("тЬЕ Successfully updated Somoy TV URL")
                return updated_content
            else:
                print("тЭМ Somoy TV not found in main playlist")
                return None
        
        # рж╕рзЛрж░рзНрж╕ ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржерзЗржХрзЗ Somoy TV URL ржЦрзБржБржЬрзБржи
        new_url = find_somoy_tv_url('source_playlist.m3u')
        
        if new_url:
            # ржорзЗржЗржи ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржЖржкржбрзЗржЯ ржХрж░рзБржи
            updated_content = update_main_playlist('main_playlist.m3u', new_url)
            
            if updated_content:
                # ржЖржкржбрзЗржЯ ржХрж░рж╛ ржХржирзНржЯрзЗржирзНржЯ рж╕рзЗржн ржХрж░рзБржи
                with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
                    f.write(updated_content)
                print("ЁЯОЙ Playlist updated successfully!")
            else:
                print("тЪая╕П Could not update playlist, keeping original")
                # ржорзЗржЗржи ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржХржкрж┐ ржХрж░рзБржи
                with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
                    with open('main_playlist.m3u', 'r', encoding='utf-8') as original:
                        f.write(original.read())
        else:
            print("тЪая╕П No Somoy TV URL found, keeping original playlist")
            # ржорзЗржЗржи ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯ ржХржкрж┐ ржХрж░рзБржи
            with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
                with open('main_playlist.m3u', 'r', encoding='utf-8') as original:
                    f.write(original.read())
        
        EOF
        
    - name: Verify and replace playlist
      run: |
        echo "ЁЯФН Verifying updated playlist..."
        
        if [ ! -f "sirometv_updated.m3u" ] || [ ! -s "sirometv_updated.m3u" ]; then
          echo "тЭМ ERROR: Updated playlist is missing or empty!"
          exit 1
        fi
        
        # ржорзЗржЗржи ржкрзНрж▓рзЗрж▓рж┐рж╕рзНржЯрзЗ Somoy TV ржЖржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзБржи
        if ! grep -q 'Somoy TV' sirometv_updated.m3u; then
          echo "тЭМ ERROR: Somoy TV channel not found in updated playlist!"
          exit 1
        fi
        
        # ржирждрзБржи ржлрж╛ржЗрж▓ржЯрж┐ ржорзВрж▓ ржлрж╛ржЗрж▓ рж░рж┐ржкрзНрж▓рзЗрж╕ ржХрж░рзБржи
        mv sirometv_updated.m3u sirometv.m3u
        
        # Somoy TV ржПрж░ URL ржжрзЗржЦрж╛ржи
        echo "ЁЯФН Somoy TV section:"
        grep -A 1 'Somoy TV' sirometv.m3u
        
    - name: Commit and push changes
      run: |
        echo "ЁЯТ╛ Saving changes to repository..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add sirometv.m3u
        
        # рж╢рзБржзрзБ changes ржерж╛ржХрж▓рзЗ commit ржХрж░рзБржи
        if git diff --staged --quiet; then
          echo "тЬЕ No changes detected - playlist is up to date"
        else
          git commit -m "ЁЯФД Auto Update Somoy TV URL - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "ЁЯОЙ Successfully updated Somoy TV URL!"
          echo "ЁЯХР Next auto-sync in 5 minutes"
        fi
        
    - name: Cleanup
      run: |
        echo "ЁЯз╣ Cleaning up temporary files..."
        rm -f main_playlist.m3u source_playlist.m3u
        echo "тЬЕ Cleanup completed!"
