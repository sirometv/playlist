name: Yupp TV ЁЯЖХ

on:
  schedule:
    # ржкрзНрж░рждрж┐ рзл ржорж┐ржирж┐ржЯ ржкрж░ ржкрж░ рж░рж╛ржи рж╣ржмрзЗ
    - cron: '*/5 * * * *'
  workflow_dispatch:  # ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓рж┐ рж░рж╛ржи ржХрж░рж╛рж░ ржЕржкрж╢ржи

permissions:
  contents: write

jobs:
  sync-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Bangladesh timezone
      run: |
        echo "ЁЯМП Setting up Bangladesh timezone..."
        # ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рзЗрж░ ржЯрж╛ржЗржоржЬрзЛржи рж╕рзЗржЯ ржЖржк
        sudo timedatectl set-timezone Asia/Dhaka
        echo "тЬЕ Bangladesh timezone set: $(TZ='Asia/Dhaka' date)"
        
    - name: Download YuppTV playlist (Secure)
      run: |
        echo "ЁЯУе Downloading YuppTV playlist from secure source..."
        
        # ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рзЗрж░ рж╕ржорзЯ ржжрзЗржЦрж╛ржи
        BD_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
        echo "ЁЯХР Download started at: $BD_TIME_READABLE"
        
        curl -s -L -o Yupp.m3u "${{ secrets.YUPPTV_PLAYLIST_URL }}"
        
        # ржлрж╛ржЗрж▓ ржбрж╛ржЙржирж▓рзЛржб рж╣рзЯрзЗржЫрзЗ ржХрж┐ржирж╛ ржЪрзЗржХ ржХрж░рзБржи
        if [ -f "Yupp.m3u" ] && [ -s "Yupp.m3u" ]; then
          LINES_COUNT=$(wc -l < Yupp.m3u)
          CHANNEL_COUNT=$(grep -c "#EXTINF:" Yupp.m3u 2>/dev/null || echo "0")
          echo "тЬЕ Playlist downloaded successfully"
          echo "ЁЯУК File details:"
          echo "   - Total lines: $LINES_COUNT"
          echo "   - Channel count: $CHANNEL_COUNT"
          echo "   - Download time: $BD_TIME"
        else
          echo "тЭМ Error: Failed to download playlist"
          exit 1
        fi
        
    - name: Add Bangladesh time header to playlist
      run: |
        echo "ЁЯХР Adding Bangladesh time information to playlist..."
        
        if [ -f "Yupp.m3u" ] && [ -s "Yupp.m3u" ]; then
          # ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рзЗрж░ рж╕ржорзЯ рж╕ржВржЧрзНрж░рж╣
          BD_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
          BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
          CHANNEL_COUNT=$(grep -c "#EXTINF:" Yupp.m3u 2>/dev/null || echo "0")
          
          # ржЯрзЗржорзНржкрзЛрж░рж╛рж░рж┐ ржлрж╛ржЗрж▓ рждрзИрж░рж┐ ржХрж░рзБржи
          TEMP_FILE=$(mktemp)
          
          # рж╣рзЗржбрж╛рж░ ржпрзЛржЧ ржХрж░рзБржи
          echo "#EXTM3U" > "$TEMP_FILE"
          echo "# Yupp TV Playlist" >> "$TEMP_FILE"
          echo "# Total Channels: $CHANNEL_COUNT" >> "$TEMP_FILE"
          echo "# Updated: $BD_TIME" >> "$TEMP_FILE"
          echo "# Local Time: $BD_TIME_READABLE" >> "$TEMP_FILE"
          echo "# Auto-synced every 5 minutes" >> "$TEMP_FILE"
          echo "# Powered By: Sirome TV ЁЯФ┤ ржПржЗ ржлрж╛ржЗрж▓рзЗрж░ рж╕ржорж╕рзНржд рж▓рж┐ржЩрзНржХ ржкрж╛ржмрж▓рж┐ржХ рж╕рзЛрж░рзНрж╕ ржерзЗржХрзЗ рж╕ржВржЧрзНрж░рж╣ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗред ржпржжрж┐ ржХрзЗржЙ рждрж╛ржжрзЗрж░ рж╕рзЛрж░рзНрж╕ ржорзБржЫрзЗ ржлрзЗрж▓рждрзЗ ржЪрж╛ржи, рждрж╛рж╣рж▓рзЗ ржжржпрж╝рж╛ ржХрж░рзЗ ржЖржорж╛ржжрзЗрж░ ржЬрж╛ржирж╛ржиред ржЖржорж░рж╛ ржЖржкржирж╛рж░ ржорждрж╛ржоржд ржПржмржВ ржкрзНрж░ржЪрзЗрж╖рзНржЯрж╛ржХрзЗ рж╕ржорзНржорж╛ржи ржХрж░рж┐, рждрж╛ржЗ ржЖржкржирж╛рж░ рж╕рзЛрж░рзНрж╕ ржорзБржЫрзЗ ржлрзЗрж▓рж╛рж░ ржмрзНржпрж╛ржкрж╛рж░рзЗ ржЖржорж░рж╛ ржЖржкрждрзНрждрж┐ ржХрж░ржм ржирж╛ред ЁЯФ┤ All the links in this file are collected from public sources. If anyone wants to remove their source, please let us know. We respect your opinions and efforts, so we will not object to removing your source." >> "$TEMP_FILE"
          echo "" >> "$TEMP_FILE"
          
          # ржЖрж╕рж▓ ржХржирзНржЯрзЗржирзНржЯ ржпрзЛржЧ ржХрж░рзБржи
          cat Yupp.m3u >> "$TEMP_FILE"
          
          # ржЯрзЗржорзНржкрзЛрж░рж╛рж░рж┐ ржлрж╛ржЗрж▓ржЯрж┐ ржорзВрж▓ ржлрж╛ржЗрж▓рзЗ ржорзБржн ржХрж░рзБржи
          mv "$TEMP_FILE" Yupp.m3u
          
          echo "тЬЕ Bangladesh time header added successfully"
          echo "ЁЯФН First 5 lines of updated playlist:"
          head -5 Yupp.m3u
        else
          echo "тЭМ Error: Yupp.m3u file not found or empty"
          exit 1
        fi
        
    - name: Check if playlist changed
      id: check_changes
      run: |
        changes_detected=false
        
        if [ -f "Yupp.m3u" ] && [ -s "Yupp.m3u" ]; then
          # ржлрж╛ржЗрж▓ ржПржХрзНрж╕рж┐рж╕рзНржЯ ржХрж░рж▓рзЗ changes ржЪрзЗржХ ржХрж░рзБржи
          if ! git diff --quiet Yupp.m3u; then
            changes_detected=true
            echo "ЁЯФД Changes detected in Yupp.m3u"
            
            # ржкрж░рж┐ржмрж░рзНрждржирзЗрж░ ржмрж┐рж╕рзНрждрж╛рж░рж┐ржд ржжрзЗржЦрж╛ржи
            echo "ЁЯУК Changes summary:"
            git diff --stat Yupp.m3u
          else
            echo "тЬЕ No content changes detected"
          fi
        else
          changes_detected=true
          echo "ЁЯУЭ New Yupp.m3u file will be created"
        fi
        
        echo "changes_detected=$changes_detected" >> $GITHUB_OUTPUT
        
    - name: Commit and push if changes
      if: steps.check_changes.outputs.changes_detected == 'true'
      run: |
        # ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рзЗрж░ рж╕ржорзЯ рж╕ржВржЧрзНрж░рж╣
        COMMIT_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        COMMIT_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p')
        
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add Yupp.m3u
        
        # ржмрж╛ржВрж▓рж╛ржжрзЗрж╢рзЗрж░ рж╕ржорзЯ рж╕рж╣ commit message
        commit_msg="ЁЯФД Auto-update YuppTV playlist - $COMMIT_TIME_READABLE"
        git commit -m "$commit_msg"
        
        echo "ЁЯЪА Pushing changes to repository..."
        git push
        echo "тЬЕ Playlist updated successfully!"
        echo "ЁЯХР Next auto-sync in 5 minutes"
        
    - name: No changes detected
      if: steps.check_changes.outputs.changes_detected == 'false'
      run: |
        BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
        echo "тЬЕ No changes detected in playlist"
        echo "ЁЯХР Last checked: $BD_TIME_READABLE"
        echo "тП░ Next check in 5 minutes"
        
    - name: Cleanup and final report
      if: always()
      run: |
        BD_TIME_READABLE=$(TZ='Asia/Dhaka' date +'%A, %d %B %Y, %I:%M:%S %p Bangladesh Time')
        echo "ЁЯПБ Workflow completed at: $BD_TIME_READABLE"
        
        if [ -f "Yupp.m3u" ]; then
          LINES_COUNT=$(wc -l < Yupp.m3u)
          CHANNEL_COUNT=$(grep -c "#EXTINF:" Yupp.m3u 2>/dev/null || echo "0")
          echo "ЁЯУК Final playlist status:"
          echo "   - Total lines: $LINES_COUNT"
          echo "   - Channel count: $CHANNEL_COUNT"
          echo "   - File size: $(wc -c < Yupp.m3u) bytes"
        fi
        echo "тЬЕ Yupp TV sync process finished!"
