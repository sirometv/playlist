name: Fancode JSON Data ‚úîÔ∏è

on:
  schedule:
    # ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡¶ò‡¶®‡ßç‡¶ü‡¶æ‡¶∞ 07,17,27,37,47,57 ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá ‡¶∞‡¶æ‡¶® ‡¶π‡¶¨‡ßá
    - cron: '7,17,27,37,47,57 * * * *'
  workflow_dispatch: # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡ßü‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶®

permissions:
  contents: write

jobs:
  update-json:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: pip install requests pytz

    - name: Download and update JSON
      env:
        SECRET_URL: ${{ secrets.Fancode_Sirome_TV }}
      run: |
        import requests
        import json
        from datetime import datetime
        import pytz
        
        print("Starting JSON update process...")
        
        # ‡¶∏‡¶ø‡¶ï‡ßç‡¶∞‡ßá‡¶ü ‡¶•‡ßá‡¶ï‡ßá JSON ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        print(f"Fetching data from secret URL...")
        try:
            response = requests.get("$SECRET_URL")
            response.raise_for_status()
            original_data = response.json()
            print("Successfully fetched JSON data")
        except Exception as e:
            print(f"Error fetching JSON: {e}")
            exit(1)
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂ ‡¶ü‡¶æ‡¶á‡¶Æ‡¶ú‡ßã‡¶® ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ
        bd_timezone = pytz.timezone('Asia/Dhaka')
        current_time = datetime.now(bd_timezone)
        
        # ‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶∏‡¶Æ‡ßü
        formatted_time = current_time.strftime("%I:%M:%S %p %d-%m-%Y")
        print(f"Bangladesh time: {formatted_time}")
        
        # ‡¶®‡¶§‡ßÅ‡¶® JSON ‡¶§‡ßà‡¶∞‡¶ø
        updated_data = {
            "name": "Fancode Live Matches Data in Json",
            "telegram": "https://t.me/sirometv",
            "last update time": formatted_time,
            "webtv": "https://sirometv-tv.vercel.app",
            "matches": original_data.get("matches", [])
        }
        
        # JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡¶æ
        with open('fancode.json', 'w', encoding='utf-8') as f:
            json.dump(updated_data, f, indent=4, ensure_ascii=False)
        
        print(f"JSON updated successfully: {formatted_time}")
        
        # ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ ‡¶Ø‡ßá ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá
        import os
        if os.path.exists('fancode.json'):
            file_size = os.path.getsize('fancode.json')
            print(f"File created successfully. Size: {file_size} bytes")
        else:
            print("Error: File not created!")
            exit(1)
      shell: python

    - name: Check file changes
      run: |
        echo "Checking git status..."
        git status
        echo "File content preview:"
        head -20 fancode.json

    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add fancode.json
        
        # ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "ü§ñ Auto-update JSON at $(date +'%I:%M:%S %p %d-%m-%Y')"
          git push
          echo "Changes committed and pushed successfully"
        fi
