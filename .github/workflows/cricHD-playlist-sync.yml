name: Sync CricHD Playlist with Logo Protection

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Download and process both files with custom logos
        run: |
          python -c "
          import requests
          import re
          import json
          
          # Custom logo mapping - M3U ‡¶è‡¶¨‡¶Ç JSON ‡¶â‡¶≠‡¶Ø‡¶º‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø
          CUSTOM_LOGOS = {
              'STAR SPORTS 1': 'https://i.postimg.cc/Sx4trrVy/image.jpg',
              'STAR SPORTS 1 HINDI': 'https://i.postimg.cc/85zmvH5B/image.jpg',
              'PTV Sports': 'https://i.postimg.cc/0QDHtZxg/image.jpg',
              'Willow HD': 'https://i.postimg.cc/1RwSzp4q/image.jpg',
              'Willow HD 2': 'https://i.postimg.cc/1RwSzp4q/image.jpg',
              'Ten Sports': 'https://i.postimg.cc/1tRmw0C2/image.jpg',
              'A Sports HD': 'https://i.postimg.cc/rytcs49Y/image.jpg',
              'Sky Sports Cricket': 'https://i.postimg.cc/1RwSzp4q/image.jpg',
              'Willow HD': 'https://i.postimg.cc/1RwSzp4q/image.jpg',
              # ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶≤‡ßã‡¶ó‡ßã ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
          }
          
          print('=== Processing M3U Playlist ===')
          # ‡ßß. M3U ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç
          new_playlist_url = 'https://raw.githubusercontent.com/abusaeeidx/CricHd-playlists-Auto-Update-permanent/main/ALL.m3u'
          new_m3u_content = requests.get(new_playlist_url).text
          
          # ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® M3U ‡¶•‡ßá‡¶ï‡ßá existing logos ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®
          try:
              with open('CricHd.m3u', 'r', encoding='utf-8') as f:
                  old_m3u_content = f.read()
          except FileNotFoundError:
              old_m3u_content = ''
          
          # ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã M3U ‡¶•‡ßá‡¶ï‡ßá logo-map ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
          m3u_logo_map = {}
          old_lines = old_m3u_content.split('\\n')
          i = 0
          while i < len(old_lines):
              if old_lines[i].startswith('#EXTINF:-1'):
                  extinf_line = old_lines[i]
                  channel_name = old_lines[i + 1] if i + 1 < len(old_lines) else ''
                  logo_match = re.search(r'tvg-logo=\"([^\"]*)\"', extinf_line)
                  if logo_match and logo_match.group(1):
                      m3u_logo_map[channel_name.upper()] = logo_match.group(1)
                  i += 2
              else:
                  i += 1
          
          # Custom logos ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (M3U ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
          for channel, logo in CUSTOM_LOGOS.items():
              m3u_logo_map[channel.upper()] = logo
          
          # ‡¶®‡¶§‡ßÅ‡¶® M3U ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶® - ‡¶∂‡ßÅ‡¶ß‡ßÅ URLs ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá, logos ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
          new_lines = new_m3u_content.split('\\n')
          final_m3u_lines = []
          i = 0
          while i < len(new_lines):
              line = new_lines[i]
              if line.startswith('#EXTINF:-1'):
                  channel_name = new_lines[i + 1] if i + 1 < len(new_lines) else ''
                  channel_name_upper = channel_name.upper()
                  
                  # ‡¶è‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø custom logo ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                  current_logo = None
                  for stored_channel, logo_url in m3u_logo_map.items():
                      if stored_channel and channel_name_upper and stored_channel in channel_name_upper:
                          current_logo = logo_url
                          break
                  
                  # LINE ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                  if current_logo:
                      if 'tvg-logo=' in line:
                          line = re.sub(r'tvg-logo=\"[^\"]*\"', f'tvg-logo=\"{current_logo}\"', line)
                      else:
                          line = line.replace('#EXTINF:-1', f'#EXTINF:-1 tvg-logo=\"{current_logo}\"')
                  
                  final_m3u_lines.append(line)
                  # Channel name line ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                  if i + 1 < len(new_lines):
                      final_m3u_lines.append(new_lines[i + 1])
                  i += 2
              elif line.startswith('http'):
                  # Stream URL - ‡¶è‡¶ü‡¶ø ‡¶®‡¶§‡ßÅ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶¨‡ßá (‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá)
                  final_m3u_lines.append(line)
                  i += 1
              else:
                  # ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø ‡¶≤‡¶æ‡¶á‡¶® (EXTM3U, ‡¶á‡¶§‡ßç‡¶Ø‡¶æ‡¶¶‡¶ø)
                  final_m3u_lines.append(line)
                  i += 1
          
          # Final M3U ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
          with open('CricHd.m3u', 'w', encoding='utf-8') as f:
              f.write('\\n'.join(final_m3u_lines))
          
          print(f'‚úÖ M3U processed: {len(m3u_logo_map)} custom logos applied')
          
          print('=== Processing JSON File ===')
          # ‡ß®. JSON ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç
          json_url = 'https://raw.githubusercontent.com/abusaeeidx/CricHd-playlists-Auto-Update-permanent/main/api.json'
          new_json_data = requests.get(json_url).json()
          
          # ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® JSON ‡¶•‡ßá‡¶ï‡ßá existing data ‡¶™‡¶°‡¶º‡ßÅ‡¶® (‡¶Ø‡¶¶‡¶ø ‡¶•‡¶æ‡¶ï‡ßá)
          try:
              with open('api.json', 'r', encoding='utf-8') as f:
                  old_json_data = json.load(f)
              # ‡¶™‡ßÅ‡¶∞‡¶æ‡¶®‡ßã JSON ‡¶•‡ßá‡¶ï‡ßá logo-map ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
              json_logo_map = {}
              for item in old_json_data:
                  if 'name' in item and 'logo' in item:
                      json_logo_map[item['name'].upper()] = item['logo']
          except FileNotFoundError:
              json_logo_map = {}
          
          # Custom logos ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® (JSON ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø)
          for channel, logo in CUSTOM_LOGOS.items():
              json_logo_map[channel.upper()] = logo
          
          # ‡¶®‡¶§‡ßÅ‡¶® JSON ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶® - ‡¶∂‡ßÅ‡¶ß‡ßÅ link ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá, logos ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶ø‡¶§ ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
          for item in new_json_data:
              if 'name' in item:
                  channel_name_upper = item['name'].upper()
                  
                  # Custom logo ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                  for custom_channel, logo_url in json_logo_map.items():
                      if custom_channel in channel_name_upper:
                          item['logo'] = logo_url  # Custom logo ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                          break
                  
                  # 'link' field ‡¶®‡¶§‡ßÅ‡¶® JSON ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶¨‡ßá (‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá)
                  # ‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø fields (id, referer, origin) ‡¶®‡¶§‡ßÅ‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡ßá‡¶ì‡¶Ø‡¶º‡¶æ ‡¶π‡¶¨‡ßá
                  # ‡¶∂‡ßÅ‡¶ß‡ßÅ logo ‡¶Ü‡¶Æ‡¶æ‡¶¶‡ßá‡¶∞ custom ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
          
          # Final JSON ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
          with open('api.json', 'w', encoding='utf-8') as f:
              json.dump(new_json_data, f, indent=2, ensure_ascii=False)
          
          print('‚úÖ JSON processed: Custom logos applied, links updated')
          print('üéâ Both M3U and JSON updated successfully!')
          print('üì∫ Stream links updated from second account')
          print('üñºÔ∏è  Custom logos preserved in both files')
          "

      - name: Check for changes
        id: check_changes
        run: |
          changes=false
          if ! git diff --exit-code CricHd.m3u; then
            changes=true
            echo "M3U file changed"
          fi
          if ! git diff --exit-code api.json; then
            changes=true
            echo "JSON file changed"
          fi
          echo "changes=$changes" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CricHd.m3u api.json
          git commit -m "üîÑ Smart Sync: URLs updated + custom logos - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "Sync completed successfully!"
