name: Sync CricHD Playlist - Custom Logos & Names

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Python dependencies
        run: pip install requests

      - name: Create and run Python script
        run: |
          cat > sync_script.py << 'EOF'
          import requests
          import re
          import json
          
          # à¦†à¦ªà¦¨à¦¾à¦° PERMANENT custom logos à¦à¦¬à¦‚ channel names
          # à¦à¦—à§à¦²à§‹ à¦•à¦–à¦¨à¦“ change à¦¹à¦¬à§‡ à¦¨à¦¾
          CUSTOM_CHANNELS = {
              # Format: 'ORIGINAL_CHANNEL_NAME': {'logo': 'YOUR_LOGO', 'name': 'YOUR_CUSTOM_NAME'}
              
              # Star Sports Channels
              'STAR SPORTS 1': {
                  'logo': 'https://i.postimg.cc/Sx4trrVy/image.jpg',
                  'name': 'Star Sports 1'
              },
              'STAR SPORTS 1 HD': {
                  'logo': 'https://i.postimg.cc/Sx4trrVy/image.jpg', 
                  'name': 'Star Sports 1 HD'
              },
              'STAR SPORTS 1 HINDI': {
                  'logo': 'https://i.postimg.cc/85zmvH5B/image.jpg',
                  'name': 'Star Sports 1 Hindi'
              },
              'STAR SPORTS 1 HINDI HD': {
                  'logo': 'https://i.postimg.cc/85zmvH5B/image.jpg',
                  'name': 'Star Sports 1 Hindi HD'
              },
              'STAR SPORTS 2': {
                  'logo': 'https://i.postimg.cc/Sx4trrVy/image.jpg',
                  'name': 'Star Sports 2'
              },
              'STAR SPORTS 2 HD': {
                  'logo': 'https://i.postimg.cc/Sx4trrVy/image.jpg',
                  'name': 'Star Sports 2 HD'
              },
              
              # Willow Channels
              'WILLOW HD': {
                  'logo': 'https://i.postimg.cc/1RwSzp4q/image.jpg',
                  'name': 'Willow HD'
              },
              'WILLOW HD 2': {
                  'logo': 'https://i.postimg.cc/1RwSzp4q/image.jpg',
                  'name': 'Willow HD 2'
              },
              
              # PTV Sports
              'PTV SPORTS': {
                  'logo': 'https://i.postimg.cc/0QDHtZxg/image.jpg',
                  'name': 'PTV Sports'
              },
              'PTV SPORTS HD': {
                  'logo': 'https://i.postimg.cc/0QDHtZxg/image.jpg',
                  'name': 'PTV Sports HD'
              },
              
              # Ten Sports
              'TEN SPORTS': {
                  'logo': 'https://i.postimg.cc/1tRmw0C2/image.jpg',
                  'name': 'Ten Sports'
              },
              
              # A Sports
              'A SPORTS HD': {
                  'logo': 'https://i.postimg.cc/rytcs49Y/image.jpg',
                  'name': 'A Sports HD'
              },
              
              # Sky Sports
              'SKY SPORTS CRICKET': {
                  'logo': 'https://i.postimg.cc/1RwSzp4q/image.jpg',
                  'name': 'Sky Sports Cricket'
              },
              
              # Add more channels as needed...
          }
          
          print("=== STARTING SYNC (CUSTOM LOGOS & NAMES) ===")
          
          # 1. M3U à¦«à¦¾à¦‡à¦² à¦ªà§à¦°à¦¸à§‡à¦¸à¦¿à¦‚
          print("ðŸ“º Processing M3U file...")
          m3u_url = "https://raw.githubusercontent.com/abusaeeidx/CricHd-playlists-Auto-Update-permanent/main/ALL.m3u"
          m3u_response = requests.get(m3u_url)
          m3u_content = m3u_response.text
          
          lines = m3u_content.split('\n')
          output_lines = []
          i = 0
          channels_processed = 0
          custom_channels_used = 0
          
          # à¦ªà§à¦°à¦¥à¦®à§‡ M3U à¦¥à§‡à¦•à§‡ channel names à¦à¦¬à¦‚ à¦¤à¦¾à¦¦à§‡à¦° streaming URLs map à¦•à¦°à¦¿
          channel_url_map = {}
          temp_i = 0
          while temp_i < len(lines):
              if lines[temp_i].startswith('#EXTINF:-1'):
                  channel_name = lines[temp_i + 1] if temp_i + 1 < len(lines) else ''
                  stream_url = lines[temp_i + 2] if temp_i + 2 < len(lines) else ''
                  if channel_name and stream_url.startswith('http'):
                      channel_url_map[channel_name.upper()] = stream_url
                  temp_i += 2
              else:
                  temp_i += 1
          
          print(f"ðŸ“Š Found {len(channel_url_map)} channels with streaming URLs")
          
          # à¦à¦–à¦¨ à¦†à¦®à¦¾à¦¦à§‡à¦° custom M3U à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¿
          print("\nðŸ”„ Creating custom M3U with permanent logos & names...")
          
          # M3U header
          output_lines.append("#EXTM3U")
          
          # à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ custom channel à¦à¦° à¦œà¦¨à§à¦¯ entry à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¿
          for original_channel, custom_data in CUSTOM_CHANNELS.items():
              custom_logo = custom_data['logo']
              custom_name = custom_data['name']
              
              # à¦à¦‡ channel à¦à¦° streaming URL à¦–à§à¦à¦œà§‡ à¦¬à§‡à¦° à¦•à¦°à¦¿
              stream_url = None
              for channel_in_m3u, url in channel_url_map.items():
                  if original_channel in channel_in_m3u:
                      stream_url = url
                      break
              
              if stream_url:
                  # Custom EXTINF line à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¿
                  extinf_line = f'#EXTINF:-1 tvg-logo="{custom_logo}",{custom_name}'
                  output_lines.append(extinf_line)
                  output_lines.append(stream_url)
                  
                  custom_channels_used += 1
                  print(f"âœ… {custom_name} -> {stream_url[:50]}...")
              else:
                  print(f"âš ï¸  No stream URL found for: {original_channel}")
          
          # Final M3U à¦¸à§‡à¦­ à¦•à¦°à§à¦¨
          with open('CricHd.m3u', 'w', encoding='utf-8') as f:
              f.write('\n'.join(output_lines))
          
          print(f"\nðŸ“Š M3U Processing Summary:")
          print(f"âœ… Custom channels processed: {custom_channels_used}")
          print(f"ðŸ“º Total streams found: {len(channel_url_map)}")
          
          # 2. JSON à¦«à¦¾à¦‡à¦² à¦ªà§à¦°à¦¸à§‡à¦¸à¦¿à¦‚ - à¦¶à§à¦§à§ streaming links à¦†à¦ªà¦¡à§‡à¦Ÿ, logos à¦à¦¬à¦‚ names custom
          print("\nðŸ“„ Processing JSON file...")
          json_url = "https://raw.githubusercontent.com/abusaeeidx/CricHd-playlists-Auto-Update-permanent/main/api.json"
          json_response = requests.get(json_url)
          json_data = json_response.json()
          
          # à¦¨à¦¤à§à¦¨ JSON data à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¿ à¦¶à§à¦§à§ à¦†à¦®à¦¾à¦¦à§‡à¦° custom channels à¦¦à¦¿à¦¯à¦¼à§‡
          custom_json_data = []
          json_updated = 0
          
          for original_channel, custom_data in CUSTOM_CHANNELS.items():
              custom_logo = custom_data['logo']
              custom_name = custom_data['name']
              
              # à¦à¦‡ channel à¦à¦° streaming URL à¦–à§à¦à¦œà§‡ à¦¬à§‡à¦° à¦•à¦°à¦¿ JSON à¦¥à§‡à¦•à§‡
              stream_data = None
              for item in json_data:
                  if 'name' in item and original_channel in item['name'].upper():
                      stream_data = item
                      break
              
              if stream_data:
                  # Custom JSON entry à¦¤à§ˆà¦°à¦¿ à¦•à¦°à¦¿
                  custom_entry = {
                      'name': custom_name,
                      'id': stream_data.get('id', ''),
                      'logo': custom_logo,  # à¦†à¦®à¦¾à¦¦à§‡à¦° custom logo
                      'link': stream_data.get('link', ''),  # à¦¶à§à¦§à§ stream link à¦†à¦ªà¦¡à§‡à¦Ÿ
                      'referer': stream_data.get('referer', ''),
                      'origin': stream_data.get('origin', '')
                  }
                  custom_json_data.append(custom_entry)
                  json_updated += 1
                  print(f"âœ… JSON: {custom_name}")
          
          # Custom JSON à¦¸à§‡à¦­ à¦•à¦°à§à¦¨
          with open('api.json', 'w', encoding='utf-8') as f:
              json.dump(custom_json_data, f, indent=2, ensure_ascii=False)
          
          print(f"ðŸ“Š JSON: {json_updated} custom entries created")
          print("\nðŸŽ‰ SYNC COMPLETED SUCCESSFULLY!")
          print("âœ¨ Features:")
          print("   âœ… Only streaming links updated from second account")
          print("   âœ… Logos and names are PERMANENTLY custom")
          print("   âœ… Full control over channel presentation")
          EOF
          
          python sync_script.py

      - name: Check for changes
        id: check_changes
        run: |
          changes=false
          if ! git diff --quiet CricHd.m3u 2>/dev/null; then
            changes=true
            echo "M3U file changed"
          fi
          if ! git diff --quiet api.json 2>/dev/null; then
            changes=true
            echo "JSON file changed"
          fi
          echo "changes=$changes" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        if: steps.check_changes.outputs.changes == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add CricHd.m3u api.json
          git commit -m "ðŸ”„ Auto-sync: Streams updated + Permanent custom logos/names"
          git push
          echo "Sync completed successfully!"
