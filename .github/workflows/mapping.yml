name: Mapping

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download playlists
      run: |
        echo "üì• Downloading playlists..."
        curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        curl -s -L -o source_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/Ayna.m3u"
        
        for file in main_playlist.m3u source_playlist.m3u; do
          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "‚ùå ERROR: $file download failed!"
            exit 1
          fi
          LINES=$(wc -l < "$file")
          echo "‚úÖ $file downloaded - $LINES lines"
        done
        
    - name: Update All Channel
      run: |
        echo "üîÑ Updating All Channel..."
        
        python3 - << 'EOF'
        import re
        from datetime import datetime
        import pytz
        import os
        
        # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡¶ø‡¶Ç - ‡¶Æ‡ßá‡¶á‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ : [‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ exact keywords]
        CHANNEL_MAPPING = {
            "T Sports": ["T Sports HD", "A Sports", "PTV Sports"],
            "BTV National": ["BTV NATIONAL HD", "BTV World"],
            "BTV CTG": ["BTV CTG"],
            "Channel 9": ["Channel 9"],
            "Channel I": ["Channel I"],
            "Bangla Vision": ["Bangla Vision"],
            "News 24": ["News 24 BD"], 
            "Boishakhi TV": ["Boishakhi TV"],
            "Bijoy TV": ["Bijoy TV"],
            "ATN Bangla": ["ATN Bangla"],
            "ATN-Bangla News": ["ATN News"],
            "DBC News": ["DBC News"],
            "Independent TV": ["Independent TV"],
            "Bangla TV": ["Bangla TV"],
            "Desh TV": ["Desh TV"],
            "RTV": ["RTV"],
            "My TV": ["My TV"],
        }
        
        def get_bangladesh_time():
            """‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡ßá"""
            bangladesh_tz = pytz.timezone('Asia/Dhaka')
            now = datetime.now(bangladesh_tz)
            return now.strftime("%Y-%m-%d %I:%M:%S%p BD Time")
        
        def find_channel_urls(source_file, keywords):
            """‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ URL ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá"""
            with open(source_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            urls = []
            
            # ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶≠‡¶æ‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
            lines = content.split('\n')
            i = 0
            
            while i < len(lines):
                line = lines[i]
                # EXTINF ‡¶≤‡¶æ‡¶á‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
                if line.startswith('#EXTINF:'):
                    extinf_line = line
                    channel_name_part = extinf_line.split(',', 1)[1] if ',' in extinf_line else ""
                    
                    # ‡¶™‡¶∞‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶® URL ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá
                    if i + 1 < len(lines) and lines[i + 1].startswith('http'):
                        url_line = lines[i + 1]
                        
                        # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø keyword ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                        for keyword in keywords:
                            # Exact match ‡¶ö‡ßá‡¶ï - keyword ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá exact match ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá
                            pattern = r'\b' + re.escape(keyword) + r'\b'
                            if re.search(pattern, channel_name_part, re.IGNORECASE):
                                print(f"‚úÖ Exact match found: '{keyword}' in '{channel_name_part}'")
                                urls.append(url_line.strip())
                                break
                        i += 2
                    else:
                        i += 1
                else:
                    i += 1
            
            # ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã URL ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü, ‡¶§‡¶æ‡¶π‡¶≤‡ßá backup method ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
            if not urls:
                for keyword in keywords:
                    pattern = rf'#EXTINF:-1[^,]*,[^,]*\b{re.escape(keyword)}\b[^\n]*\n(http[^\n]+)'
                    match = re.search(pattern, content, re.IGNORECASE)
                    if match:
                        url = match.group(1).strip()
                        print(f"‚úÖ Backup method found: '{keyword}' -> {url[:80]}...")
                        urls.append(url)
            
            if urls:
                print(f"‚úÖ Total URLs found: {len(urls)}")
            else:
                print(f"‚ùå No URLs found for keywords: {keywords}")
            
            return urls
        
        def find_existing_auto_updated_block(lines, main_extinf_idx, channel_name):
            """‡¶Æ‡ßÇ‡¶≤ EXTINF ‡¶è‡¶∞ ‡¶†‡¶ø‡¶ï ‡ß® ‡¶≤‡¶æ‡¶á‡¶® ‡¶â‡¶™‡¶∞‡ßá AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá"""
            # ‡¶Æ‡ßÇ‡¶≤ EXTINF ‡¶•‡ßá‡¶ï‡ßá ‡ß® ‡¶≤‡¶æ‡¶á‡¶® ‡¶â‡¶™‡¶∞‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßá ‡ßß‡ß¶ ‡¶≤‡¶æ‡¶á‡¶® ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶ø
            search_start = max(0, main_extinf_idx - 15)
            
            for i in range(search_start, main_extinf_idx):
                if lines[i].startswith('#EXTINF:') and channel_name in lines[i]:
                    # ‡¶™‡¶∞‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶® AUTO-UPDATED ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                    if i + 1 < len(lines) and '#AUTO-UPDATED' in lines[i + 1]:
                        # ‡¶è‡¶á ‡¶¨‡ßç‡¶≤‡¶ï‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶ø
                        block_end = i + 1  # EXTINF ‡¶è‡¶¨‡¶Ç AUTO-UPDATED ‡¶≤‡¶æ‡¶á‡¶®
                        # ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶ø
                        for j in range(i + 2, len(lines)):
                            if j >= main_extinf_idx:  # ‡¶Æ‡ßÇ‡¶≤ EXTINF ‡¶è‡¶∞ ‡¶ï‡¶æ‡¶õ‡¶æ‡¶ï‡¶æ‡¶õ‡¶ø ‡¶ö‡¶≤‡ßá ‡¶ó‡ßá‡¶≤‡ßá
                                break
                            if lines[j].startswith('http'):
                                block_end = j
                            else:
                                break
                        return i, block_end
            return -1, -1
        
        def insert_auto_updated_block(lines, main_extinf_idx, channel_name, new_urls, original_extinf_line):
            """‡¶Æ‡ßÇ‡¶≤ EXTINF ‡¶è‡¶∞ ‡¶†‡¶ø‡¶ï ‡ß® ‡¶≤‡¶æ‡¶á‡¶® ‡¶â‡¶™‡¶∞‡ßá ‡¶®‡¶§‡ßÅ‡¶® AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßá"""
            new_lines = []
            
            # ‡¶Æ‡ßÇ‡¶≤ EXTINF ‡¶è‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Ö‡¶Ç‡¶∂ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø
            for j in range(0, main_extinf_idx):
                new_lines.append(lines[j])
            
            # ‡ß® ‡¶≤‡¶æ‡¶á‡¶® ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ (‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ö‡¶æ‡¶π‡¶ø‡¶¶‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡ßü‡ßÄ)
            new_lines.append("")
            new_lines.append("")
            
            # EXTINF ‡¶≤‡¶æ‡¶á‡¶® ‡¶ï‡¶™‡¶ø ‡¶ï‡¶∞‡¶ø (‡¶Æ‡ßÇ‡¶≤ EXTINF ‡¶•‡ßá‡¶ï‡ßá ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶ï‡¶™‡¶ø)
            new_lines.append(original_extinf_line)
            
            # AUTO-UPDATED ‡¶≤‡¶æ‡¶á‡¶®
            timestamp = get_bangladesh_time()
            refresh_emoji = "üîÑ" * len(new_urls)
            new_lines.append(f"#AUTO-UPDATED üî¥ - {channel_name} - {timestamp} {refresh_emoji}")
            
            # ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ø‡¶Ç‡¶ï
            for url in new_urls:
                new_lines.append(url)
            
            # ‡¶¨‡¶æ‡¶ï‡¶ø ‡¶Ö‡¶Ç‡¶∂ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø (‡¶Æ‡ßÇ‡¶≤ EXTINF ‡¶∏‡¶π)
            for j in range(main_extinf_idx, len(lines)):
                new_lines.append(lines[j])
            
            return new_lines
        
        def update_existing_auto_updated_block(lines, auto_start, auto_end, channel_name, new_urls):
            """‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï‡ßá‡¶∞ ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡ßá"""
            new_lines = []
            
            # AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï‡ßá‡¶∞ ‡¶Ü‡¶ó‡ßá‡¶∞ ‡¶Ö‡¶Ç‡¶∂ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø
            for j in range(0, auto_start):
                new_lines.append(lines[j])
            
            # EXTINF ‡¶≤‡¶æ‡¶á‡¶® (‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§)
            new_lines.append(lines[auto_start])
            
            # ‡¶®‡¶§‡ßÅ‡¶® AUTO-UPDATED ‡¶≤‡¶æ‡¶á‡¶®
            timestamp = get_bangladesh_time()
            refresh_emoji = "üîÑ" * len(new_urls)
            new_lines.append(f"#AUTO-UPDATED üî¥ - {channel_name} - {timestamp} {refresh_emoji}")
            
            # ‡¶®‡¶§‡ßÅ‡¶® ‡¶≤‡¶ø‡¶Ç‡¶ï
            for url in new_urls:
                new_lines.append(url)
            
            # AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï‡ßá‡¶∞ ‡¶™‡¶∞‡ßá‡¶∞ ‡¶Ö‡¶Ç‡¶∂ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø (‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡ßü‡ßá)
            # auto_end ‡¶è‡¶∞ ‡¶™‡¶∞ ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡¶ø
            for j in range(auto_end + 1, len(lines)):
                new_lines.append(lines[j])
            
            return new_lines
        
        # ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        with open('main_playlist.m3u', 'r', encoding='utf-8') as f:
            main_content = f.read()
        
        lines = main_content.split('\n')
        
        # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶ø
        for channel_name in CHANNEL_MAPPING.keys():
            print(f"\n{'='*50}")
            print(f"üîç Processing channel: {channel_name}")
            
            # ‡¶è‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶∏‡¶¨ EXTINF ‡¶™‡¶ú‡¶ø‡¶∂‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶ø
            channel_positions = []
            for idx, line in enumerate(lines):
                if line.startswith('#EXTINF:') and channel_name in line:
                    channel_positions.append(idx)
            
            if not channel_positions:
                print(f"‚ö†Ô∏è Channel '{channel_name}' not found in main playlist")
                continue
            
            print(f"‚úÖ Found {len(channel_positions)} occurrences of '{channel_name}'")
            
            # ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶§‡ßÅ‡¶® URL ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶ø
            new_urls = find_channel_urls('source_playlist.m3u', CHANNEL_MAPPING[channel_name])
            
            if not new_urls:
                print(f"‚ö†Ô∏è No URLs found for '{channel_name}', skipping...")
                continue
            
            # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶™‡¶æ‡¶ì‡¶ú‡¶ø‡¶∂‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶ï‡¶∞‡¶ø
            for pos_idx, main_extinf_idx in enumerate(channel_positions):
                print(f"   Processing occurrence {pos_idx+1} at line {main_extinf_idx+1}")
                
                # ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
                auto_start, auto_end = find_existing_auto_updated_block(lines, main_extinf_idx, channel_name)
                
                if auto_start != -1:
                    print(f"   ‚úÖ Existing AUTO-UPDATED block found at lines {auto_start+1}-{auto_end+1}")
                    print(f"   üîÑ Replacing {auto_end - auto_start - 1} old links with {len(new_urls)} new links")
                    
                    # ‡¶¨‡¶ø‡¶¶‡ßç‡¶Ø‡¶Æ‡¶æ‡¶® ‡¶¨‡ßç‡¶≤‡¶ï ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                    lines = update_existing_auto_updated_block(
                        lines, auto_start, auto_end, channel_name, new_urls
                    )
                    
                    # channel_positions ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø (‡¶≤‡¶æ‡¶á‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá)
                    shift = len(new_urls) - (auto_end - auto_start - 1)
                    if shift != 0:
                        for i in range(pos_idx + 1, len(channel_positions)):
                            channel_positions[i] += shift
                        main_extinf_idx += shift
                
                else:
                    print(f"   üÜï No AUTO-UPDATED block found, creating new one 2 lines above main EXTINF")
                    
                    # ‡¶®‡¶§‡ßÅ‡¶® AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶ø
                    original_extinf_line = lines[main_extinf_idx]
                    lines = insert_auto_updated_block(
                        lines, main_extinf_idx, channel_name, new_urls, original_extinf_line
                    )
                    
                    # channel_positions ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø (‡¶≤‡¶æ‡¶á‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶π‡ßü‡ßá‡¶õ‡ßá)
                    shift = 3 + len(new_urls)  # ‡ß® ‡¶´‡¶æ‡¶Å‡¶ï‡¶æ ‡¶≤‡¶æ‡¶á‡¶® + EXTINF + AUTO-UPDATED + ‡¶≤‡¶ø‡¶Ç‡¶ï
                    for i in range(pos_idx, len(channel_positions)):
                        channel_positions[i] += shift
        
        # ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶ø
        updated_content = '\n'.join(lines)
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
        
        # ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®
        print(f"\n{'='*50}")
        print(f"üéâ Update Summary:")
        
        # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∏ ‡¶ö‡ßá‡¶ï
        print(f"\nüîç Channel Status:")
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶° ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶≤‡ßã‡¶°
        updated_lines = updated_content.split('\n')
        
        for channel_name in CHANNEL_MAPPING.keys():
            # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ EXTINF ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
            extinf_count = sum(1 for line in updated_lines if line.startswith('#EXTINF:') and channel_name in line)
            
            # AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
            auto_blocks = 0
            for idx, line in enumerate(updated_lines):
                if line.startswith('#EXTINF:') and channel_name in line:
                    if idx + 1 < len(updated_lines) and '#AUTO-UPDATED' in updated_lines[idx + 1]:
                        auto_blocks += 1
            
            print(f"   {channel_name}: {extinf_count} EXTINF entries, {auto_blocks} AUTO-UPDATED blocks")
        
        # ‡¶ü‡ßá‡¶∏‡ßç‡¶ü: BTV CTG ‡¶è‡¶∞ ‡¶ó‡¶†‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        print(f"\nüîç Example structure for BTV CTG:")
        found = False
        for idx, line in enumerate(updated_lines):
            if 'BTV CTG' in line and line.startswith('#EXTINF:'):
                if not found:
                    print(f"   Line {idx+1}: {line}")
                    # ‡¶™‡¶∞‡ßá‡¶∞ ‡ßß‡ß¶ ‡¶≤‡¶æ‡¶á‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
                    for j in range(idx + 1, min(idx + 11, len(updated_lines))):
                        if updated_lines[j].startswith('#EXTINF:'):
                            break
                        print(f"   Line {j+1}: {updated_lines[j]}")
                    print()
                    found = True
        
        print(f"\n{'='*50}")
        print(f"‚úÖ Processing completed successfully!")
        EOF
        
    - name: Verify and replace playlist
      run: |
        echo "üîç Verifying updated playlist..."
        
        if [ ! -f "sirometv_updated.m3u" ] || [ ! -s "sirometv_updated.m3u" ]; then
          echo "‚ùå ERROR: Updated playlist is missing or empty!"
          exit 1
        fi
        
        echo "‚úÖ Updated playlist created successfully"
        
        # ‡¶Ü‡¶∏‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶° ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ
        echo ""
        echo "üîç File comparison:"
        
        # ‡¶Ü‡¶∏‡¶≤ EXTINF ‡¶è‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
        ORIG_EXTINF=$(grep -c "^#EXTINF:" main_playlist.m3u)
        UPD_EXTINF=$(grep -c "^#EXTINF:" sirometv_updated.m3u)
        
        echo "   Original #EXTINF entries: $ORIG_EXTINF"
        echo "   Updated #EXTINF entries:  $UPD_EXTINF"
        
        # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡ßá‡¶ï
        echo ""
        echo "üîç Checking each mapped channel:"
        
        for channel in "T Sports" "BTV National" "BTV CTG" "Channel 9" "Channel I" "Bangla Vision" "News 24" "Boishakhi TV" "Bijoy TV" "ATN Bangla" "ATN-Bangla News" "DBC News" "Independent TV" "Bangla TV" "Desh TV" "RTV" "My TV"; do
          # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ EXTINF ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ (‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶°‡ßá)
          CHANNEL_EXTINF=$(grep "^#EXTINF:" sirometv_updated.m3u | grep -c "$channel")
          
          # ‡¶Ü‡¶∏‡¶≤‡ßá ‡¶è‡¶á ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ EXTINF ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
          ORIG_CHANNEL_EXTINF=$(grep "^#EXTINF:" main_playlist.m3u | grep -c "$channel")
          
          # AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
          AUTO_BLOCKS=$(grep -B1 "#AUTO-UPDATED.*$channel" sirometv_updated.m3u | grep -c "^#EXTINF:")
          
          if [ "$CHANNEL_EXTINF" -gt 0 ]; then
            if [ "$CHANNEL_EXTINF" -ge "$((ORIG_CHANNEL_EXTINF * 2))" ]; then
              echo "   ‚úÖ $channel: $CHANNEL_EXTINF EXTINF ($AUTO_BLOCKS auto-updated)"
            else
              echo "   ‚ö†Ô∏è  $channel: $CHANNEL_EXTINF EXTINF (expected at least $((ORIG_CHANNEL_EXTINF * 2)))"
            fi
          fi
        done
        
        # BTV CTG ‡¶è‡¶∞ ‡¶â‡¶¶‡¶æ‡¶π‡¶∞‡¶£ ‡¶ó‡¶†‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        echo ""
        echo "üîç Example structure for BTV CTG:"
        grep -n -B2 -A5 "BTV CTG" sirometv_updated.m3u | head -15 | while read line; do
          echo "   $line"
        done
        
        # ‡¶Æ‡ßÇ‡¶≤ EXTINF ‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ö‡ßá‡¶ï
        echo ""
        echo "üîç Checking original EXTINF preservation:"
        
        # ‡¶Ü‡¶∏‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡ß´‡¶ü‡¶ø EXTINF ‡¶ö‡ßá‡¶ï
        echo "   First 5 original EXTINF lines:"
        grep "^#EXTINF:" main_playlist.m3u | head -5 | while read line; do
          if grep -Fq "$line" sirometv_updated.m3u; then
            echo "     ‚úÖ Preserved: ${line:0:60}..."
          else
            echo "     ‚ùå Missing: ${line:0:60}..."
          fi
        done
        
        # AUTO-UPDATED ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
        AUTO_COUNT=$(grep -c "#AUTO-UPDATED" sirometv_updated.m3u)
        echo ""
        echo "üìä Total AUTO-UPDATED sections: $AUTO_COUNT"
        
        mv sirometv_updated.m3u sirometv.m3u
        
    - name: Commit and push changes
      run: |
        echo "üíæ Saving changes to repository..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add sirometv.m3u
        
        if git diff --staged --quiet; then
          echo "‚úÖ No changes detected - playlist is up to date"
        else
          # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶®‡ßá‡¶ì‡ßü‡¶æ
          BANGLADESH_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %I:%M:%S%p BD Time')
          
          # Check if manual or scheduled run
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            git commit -m "üîÑ Manual Update: AUTO-UPDATED sections added/updated - $BANGLADESH_TIME"
          else
            git commit -m "üîÑ Scheduled Update: AUTO-UPDATED links replaced - $BANGLADESH_TIME"
          fi
          git push
          echo "üéâ Successfully updated playlist!"
        fi
        
    - name: Cleanup
      run: |
        rm -f main_playlist.m3u source_playlist.m3u
        echo "‚úÖ Cleanup completed!"
