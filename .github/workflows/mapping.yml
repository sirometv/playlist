name: Mapping

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download playlists
      run: |
        echo "üì• Downloading playlists..."
        curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        curl -s -L -o source_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/Ayna.m3u"
        
        for file in main_playlist.m3u source_playlist.m3u; do
          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "‚ùå ERROR: $file download failed!"
            exit 1
          fi
          LINES=$(wc -l < "$file")
          echo "‚úÖ $file downloaded - $LINES lines"
        done
        
    - name: Update All Channel
      run: |
        echo "üîÑ Updating All Channel..."
        
        python3 - << 'EOF'
        import re
        from datetime import datetime
        import pytz
        
        # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡¶ø‡¶Ç - ‡¶Æ‡ßá‡¶á‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ : [‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ exact keywords]
        CHANNEL_MAPPING = {
            "T Sports": ["T Sports HD", "A Sports", "PTV Sports"],
            "BTV National": ["BTV NATIONAL HD", "BTV World"],
            "BTV CTG": ["BTV CTG"],
            "Channel 9": ["Channel 9"],
            "Channel I": ["Channel I"],
            "Bangla Vision": ["Bangla Vision"],
            "News 24": ["News 24 BD"], 
            "Boishakhi TV": ["Boishakhi TV"],
            "Bijoy TV": ["Bijoy TV"],
            "ATN Bangla": ["ATN Bangla"],
            "ATN-Bangla News": ["ATN News"],
            "DBC News": ["DBC News"],
            "Independent TV": ["Independent TV"],
            "Bangla TV": ["Bangla TV"],
            "Desh TV": ["Desh TV"],
            "RTV": ["RTV"],
            "My TV": ["My TV"],
            # "Somoy TV": ["Somoy News TV", "Somoy TV"],
            # ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶∞‡ßã ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®
            # "Channel Name in Main": ["exact_keyword1", "exact_keyword2", "exact_keyword3"]
        }
        
        def get_bangladesh_time():
            """‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡ßá"""
            bangladesh_tz = pytz.timezone('Asia/Dhaka')
            now = datetime.now(bangladesh_tz)
            return now.strftime("%Y-%m-%d %I:%M:%S%p BD Time")
        
        def find_channel_urls(source_file, keywords):
            """‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ URL ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá"""
            with open(source_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            urls = []
            
            # ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡¶ï‡ßá ‡¶≤‡¶æ‡¶á‡¶®‡ßá ‡¶≠‡¶æ‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
            lines = content.split('\n')
            i = 0
            
            while i < len(lines):
                line = lines[i]
                # EXTINF ‡¶≤‡¶æ‡¶á‡¶® ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
                if line.startswith('#EXTINF:'):
                    extinf_line = line
                    channel_name_part = extinf_line.split(',', 1)[1] if ',' in extinf_line else ""
                    
                    # ‡¶™‡¶∞‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶® URL ‡¶π‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá
                    if i + 1 < len(lines) and lines[i + 1].startswith('http'):
                        url_line = lines[i + 1]
                        
                        # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø keyword ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                        for keyword in keywords:
                            # Exact match ‡¶ö‡ßá‡¶ï - keyword ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá exact match ‡¶π‡¶§‡ßá ‡¶π‡¶¨‡ßá
                            # Case insensitive match
                            pattern = r'\b' + re.escape(keyword) + r'\b'
                            if re.search(pattern, channel_name_part, re.IGNORECASE):
                                print(f"‚úÖ Exact match found: '{keyword}' in '{channel_name_part}'")
                                urls.append(url_line.strip())
                                break  # ‡¶è‡¶ï‡¶¨‡¶æ‡¶∞ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶™‡ßá‡¶≤‡ßá ‡¶™‡¶∞‡ßá‡¶∞ keyword ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞ ‡¶®‡ßá‡¶á
                        i += 2  # EXTINF ‡¶è‡¶¨‡¶Ç URL ‡¶≤‡¶æ‡¶á‡¶® ‡¶∏‡ßç‡¶ï‡¶ø‡¶™ ‡¶ï‡¶∞‡ßÅ‡¶®
                    else:
                        i += 1
                else:
                    i += 1
            
            # ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã URL ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü, ‡¶§‡¶æ‡¶π‡¶≤‡ßá backup method ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
            if not urls:
                for keyword in keywords:
                    # Backup regex method
                    pattern = rf'#EXTINF:-1[^,]*,[^,]*\b{re.escape(keyword)}\b[^\n]*\n(http[^\n]+)'
                    match = re.search(pattern, content, re.IGNORECASE)
                    if match:
                        url = match.group(1).strip()
                        print(f"‚úÖ Backup method found: '{keyword}' -> {url[:80]}...")
                        urls.append(url)
            
            if urls:
                print(f"‚úÖ Total URLs found: {len(urls)}")
            else:
                print(f"‚ùå No URLs found for keywords: {keywords}")
            
            return urls
        
        def find_original_channel_block(lines, start_idx, channel_name):
            """‡¶Æ‡ßÇ‡¶≤ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá"""
            # ‡¶™‡ßç‡¶∞‡¶•‡¶Æ EXTINF ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶ø (‡¶è‡¶ü‡¶æ ‡¶π‡¶¨‡ßá ‡¶Æ‡ßÇ‡¶≤ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ EXTINF)
            for i in range(start_idx, len(lines)):
                if lines[i].startswith('#EXTINF:') and channel_name in lines[i]:
                    block_start = i
                    # ‡¶¨‡ßç‡¶≤‡¶ï‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶ø
                    for j in range(i + 1, len(lines)):
                        if lines[j].startswith('#EXTINF:'):
                            block_end = j - 1
                            return lines[block_start:block_end + 1]
                    # ‡¶Ø‡¶¶‡¶ø ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶∂‡ßá‡¶∑ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶ï‡ßã‡¶®‡ßã EXTINF ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
                    return lines[block_start:]
            return None
        
        def insert_auto_updated_channel(lines, channel_name, original_extinf_line, new_urls):
            """‡¶®‡¶§‡ßÅ‡¶® AUTO-UPDATED ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá"""
            # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶è‡¶¨‡¶Ç ‡¶á‡¶Æ‡ßã‡¶ú‡¶ø
            timestamp = get_bangladesh_time()
            refresh_emoji = "üîÑ" * len(new_urls)
            
            # ‡¶®‡¶§‡ßÅ‡¶® AUTO-UPDATED ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶§‡ßà‡¶∞‡¶ø
            new_block = []
            new_block.append("")
            new_block.append("")
            new_block.append(original_extinf_line)  # ‡¶Æ‡ßÇ‡¶≤ EXTINF ‡¶≤‡¶æ‡¶á‡¶® ‡¶ï‡¶™‡¶ø
            new_block.append(f"#AUTO-UPDATED üî¥ - {channel_name} - {timestamp} {refresh_emoji}")
            for url in new_urls:
                new_block.append(url)
            
            return new_block
        
        # ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        with open('main_playlist.m3u', 'r', encoding='utf-8') as f:
            main_content = f.read()
        
        # Check if manual run or scheduled
        import os
        is_manual_run = os.environ.get('GITHUB_EVENT_NAME') == 'workflow_dispatch'
        
        print(f"üìä Run type: {'Manual' if is_manual_run else 'Scheduled'}")
        print(f"üìä Total channels in mapping: {len(CHANNEL_MAPPING)}")
        
        # ‡¶™‡ßÅ‡¶∞‡ßã ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶®‡¶ó‡ßÅ‡¶≤‡¶ø
        lines = main_content.split('\n')
        new_lines = []
        i = 0
        channels_processed = 0
        
        while i < len(lines):
            line = lines[i]
            
            # ‡¶Ø‡¶¶‡¶ø EXTINF ‡¶≤‡¶æ‡¶á‡¶® ‡¶π‡ßü
            if line.startswith('#EXTINF:'):
                # ‡¶ï‡ßã‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡¶õ‡¶ø
                current_channel = None
                for channel_name in CHANNEL_MAPPING.keys():
                    if channel_name in line:
                        current_channel = channel_name
                        break
                
                if current_channel:
                    print(f"\n{'='*50}")
                    print(f"üîç Processing mapped channel: {current_channel} at line {i+1}")
                    
                    # ‡ßß. ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶™‡ßÅ‡¶∞‡ßã ‡¶Æ‡ßÇ‡¶≤ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶ø
                    original_block = find_original_channel_block(lines, i, current_channel)
                    
                    # ‡ß®. ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶§‡ßÅ‡¶® URL ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶ø
                    new_urls = find_channel_urls('source_playlist.m3u', CHANNEL_MAPPING[current_channel])
                    
                    if new_urls:
                        # ‡ß©. ‡¶®‡¶§‡ßÅ‡¶® AUTO-UPDATED ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶ø
                        auto_updated_block = insert_auto_updated_channel(
                            lines, current_channel, line, new_urls
                        )
                        
                        # ‡ß™. ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡ßá ‡¶®‡¶§‡ßÅ‡¶® AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø
                        new_lines.extend(auto_updated_block)
                        
                        # ‡ß´. ‡¶§‡¶æ‡¶∞‡¶™‡¶∞ ‡¶Æ‡ßÇ‡¶≤ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø
                        if original_block:
                            new_lines.append("")
                            new_lines.append("")
                            new_lines.extend(original_block)
                        else:
                            # ‡¶Ø‡¶¶‡¶ø ‡¶ï‡ßã‡¶®‡ßã ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü
                            # ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶≤‡¶æ‡¶á‡¶® ‡¶•‡ßá‡¶ï‡ßá ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßá ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ EXTINF ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø
                            new_lines.append("")
                            new_lines.append("")
                            new_lines.append(line)
                            # ‡¶™‡¶∞‡ßá‡¶∞ ‡¶≤‡¶æ‡¶á‡¶®‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø ‡¶Ø‡¶§‡¶ï‡ßç‡¶∑‡¶£ ‡¶®‡¶æ ‡¶™‡¶∞‡¶¨‡¶∞‡ßç‡¶§‡ßÄ EXTINF ‡¶™‡¶æ‡¶á
                            j = i + 1
                            while j < len(lines) and not lines[j].startswith('#EXTINF:'):
                                new_lines.append(lines[j])
                                j += 1
                            # i ‡¶ï‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                            i = j - 1
                        
                        channels_processed += 1
                        print(f"‚úÖ Added AUTO-UPDATED section for {current_channel} with {len(new_urls)} URLs")
                        print(f"   Original block preserved with {len(original_block) if original_block else 'unknown'} lines")
                    else:
                        print(f"‚ö†Ô∏è No new URLs found for {current_channel}, keeping original only")
                        # ‡¶®‡¶§‡ßÅ‡¶® URL ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶Æ‡ßÇ‡¶≤ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø
                        if original_block:
                            new_lines.extend(original_block)
                        else:
                            new_lines.append(line)
                        # i ‡¶ï‡ßá ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶ø
                        if original_block:
                            i += len(original_block) - 1
                
                else:
                    # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ï‡¶∞‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø
                    new_lines.append(line)
            else:
                # EXTINF ‡¶≤‡¶æ‡¶á‡¶® ‡¶®‡¶æ ‡¶π‡¶≤‡ßá ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶ø
                new_lines.append(line)
            
            i += 1
        
        # ‡¶®‡¶§‡ßÅ‡¶® ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶ø
        updated_content = '\n'.join(new_lines)
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
        
        # ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®
        print(f"\n{'='*50}")
        print(f"üéâ Update Summary:")
        print(f"   Run type: {'Manual' if is_manual_run else 'Scheduled'}")
        print(f"   Total mapped channels: {len(CHANNEL_MAPPING)}")
        print(f"   Channels processed: {channels_processed}")
        
        # ‡¶Ü‡¶∏‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶° ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ
        original_lines = main_content.split('\n')
        updated_lines = updated_content.split('\n')
        
        print(f"\nüìä File Comparison:")
        print(f"   Original lines: {len(original_lines)}")
        print(f"   Updated lines:  {len(updated_lines)}")
        
        # T Sports ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶ö‡ßá‡¶ï
        print(f"\nüîç Verifying T Sports section:")
        
        # ‡¶Ü‡¶∏‡¶≤ T Sports ‡¶∏‡ßá‡¶ï‡¶∂‡¶®‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
        original_t_sports_count = sum(1 for line in original_lines if 'T Sports' in line and line.startswith('#EXTINF:'))
        updated_t_sports_count = sum(1 for line in updated_lines if 'T Sports' in line and line.startswith('#EXTINF:'))
        
        print(f"   Original #EXTINF lines for T Sports: {original_t_sports_count}")
        print(f"   Updated #EXTINF lines for T Sports: {updated_t_sports_count}")
        
        if updated_t_sports_count >= original_t_sports_count * 2:
            print(f"   ‚úÖ SUCCESS: Each T Sports now has 2 EXTINF entries (original + auto-updated)")
        else:
            print(f"   ‚ùå ERROR: Expected at least {original_t_sports_count * 2} EXTINF entries for T Sports")
        
        # AUTO-UPDATED ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶ö‡ßá‡¶ï
        auto_updated_count = sum(1 for line in updated_lines if '#AUTO-UPDATED' in line)
        print(f"   AUTO-UPDATED sections: {auto_updated_count}")
        
        # T Sports ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        print(f"\nüìã T Sports sections in updated file:")
        found_sections = 0
        
        for idx, line in enumerate(updated_lines):
            if 'T Sports' in line and line.startswith('#EXTINF:'):
                found_sections += 1
                print(f"\n   Section {found_sections}:")
                print(f"   Line {idx+1}: {line}")
                
                # ‡¶™‡¶∞‡ßá‡¶∞ ‡ß´ ‡¶≤‡¶æ‡¶á‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
                for j in range(idx + 1, min(idx + 6, len(updated_lines))):
                    if updated_lines[j].startswith('#EXTINF:'):
                        break
                    if updated_lines[j]:
                        print(f"   Line {j+1}: {updated_lines[j]}")
        
        print(f"\n{'='*50}")
        print(f"‚úÖ Processing completed successfully!")
        EOF
        
    - name: Verify and replace playlist
      run: |
        echo "üîç Verifying updated playlist..."
        
        if [ ! -f "sirometv_updated.m3u" ] || [ ! -s "sirometv_updated.m3u" ]; then
          echo "‚ùå ERROR: Updated playlist is missing or empty!"
          exit 1
        fi
        
        # ‡¶Ü‡¶∏‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶° ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ
        echo "üîç Comparing original vs updated:"
        
        # ‡¶Ü‡¶∏‡¶≤ EXTINF ‡¶è‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
        ORIG_EXTINF=$(grep -c "^#EXTINF:" main_playlist.m3u)
        UPD_EXTINF=$(grep -c "^#EXTINF:" sirometv_updated.m3u)
        
        echo "   Original #EXTINF entries: $ORIG_EXTINF"
        echo "   Updated #EXTINF entries:  $UPD_EXTINF"
        
        # T Sports ‡¶è‡¶∞ ‡¶ï‡ßç‡¶∑‡ßá‡¶§‡ßç‡¶∞‡ßá
        echo ""
        echo "üîç T Sports specific check:"
        
        # ‡¶Ü‡¶∏‡¶≤ T Sports EXTINF
        ORIG_TS_EXTINF=$(grep "^#EXTINF:" main_playlist.m3u | grep -c "T Sports")
        UPD_TS_EXTINF=$(grep "^#EXTINF:" sirometv_updated.m3u | grep -c "T Sports")
        
        echo "   Original T Sports #EXTINF: $ORIG_TS_EXTINF"
        echo "   Updated T Sports #EXTINF:  $UPD_TS_EXTINF"
        
        # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø T Sports ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ï‡¶Æ‡¶™‡¶ï‡ßç‡¶∑‡ßá 2‡¶ü‡¶ø EXTINF ‡¶•‡¶æ‡¶ï‡¶æ ‡¶â‡¶ö‡¶ø‡¶§
        EXPECTED_MIN=$((ORIG_TS_EXTINF * 2))
        if [ "$UPD_TS_EXTINF" -ge "$EXPECTED_MIN" ]; then
          echo "   ‚úÖ SUCCESS: Each T Sports has original + auto-updated EXTINF"
        else
          echo "   ‚ùå ERROR: Expected at least $EXPECTED_MIN EXTINF entries for T Sports"
        fi
        
        # AUTO-UPDATED ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶ö‡ßá‡¶ï
        AUTO_COUNT=$(grep -c "#AUTO-UPDATED" sirometv_updated.m3u || true)
        echo ""
        echo "üìä AUTO-UPDATED sections: $AUTO_COUNT"
        
        # T Sports ‡¶è‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ AUTO-UPDATED ‡¶∏‡ßá‡¶ï‡¶∂‡¶® ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        echo ""
        echo "üîç First AUTO-UPDATED section for T Sports:"
        grep -A 10 "#AUTO-UPDATED.*T Sports" sirometv_updated.m3u | head -15
        
        # ‡¶Ü‡¶∏‡¶≤ ‡¶è‡¶¨‡¶Ç ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶° T Sports ‡¶≤‡¶ø‡¶Ç‡¶ï‡ßá‡¶∞ ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ
        ORIG_TS_LINKS=$(awk '/T Sports/{p=1} p&&/^#EXTINF:/&&!/T Sports/{p=0} p&&/^http/{count++} END{print count}' main_playlist.m3u)
        UPD_TS_LINKS=$(awk '/T Sports/{p=1} p&&/^#EXTINF:/&&!/T Sports/{p=0} p&&/^http/{count++} END{print count}' sirometv_updated.m3u)
        
        echo ""
        echo "üìä T Sports link count comparison:"
        echo "   Original T Sports links: $ORIG_TS_LINKS"
        echo "   Updated T Sports links (total): $UPD_TS_LINKS"
        
        # ‡¶Ü‡¶∏‡¶≤ ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
        echo ""
        echo "üîç Checking if original links are preserved:"
        
        # ‡¶Ü‡¶∏‡¶≤ T Sports ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ó‡ßÅ‡¶≤‡¶ø‡¶∞ ‡¶è‡¶ï‡¶ü‡¶ø ‡¶∏‡ßá‡¶ü ‡¶§‡ßà‡¶∞‡¶ø
        ORIG_LINKS_FILE=$(mktemp)
        awk '/T Sports/{p=1} p&&/^#EXTINF:/&&!/T Sports/{p=0} p&&/^http/{print $0}' main_playlist.m3u | sort -u > "$ORIG_LINKS_FILE"
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶° ‡¶´‡¶æ‡¶á‡¶≤‡ßá ‡¶è‡¶á ‡¶≤‡¶ø‡¶Ç‡¶ï‡¶ó‡ßÅ‡¶≤‡¶ø ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
        ALL_FOUND=true
        while IFS= read -r orig_link; do
          if [ -n "$orig_link" ]; then
            if ! grep -Fq "$orig_link" sirometv_updated.m3u; then
              echo "   ‚ùå Missing original link: ${orig_link:0:60}..."
              ALL_FOUND=false
            fi
          fi
        done < "$ORIG_LINKS_FILE"
        
        rm "$ORIG_LINKS_FILE"
        
        if [ "$ALL_FOUND" = true ]; then
          echo "   ‚úÖ All original T Sports links are preserved!"
        else
          echo "   ‚ö†Ô∏è Some original links may be missing"
        fi
        
        # Show file structure around T Sports
        echo ""
        echo "üîç Updated file structure around first T Sports:"
        grep -n -B2 -A 10 "T Sports" sirometv_updated.m3u | head -30
        
        mv sirometv_updated.m3u sirometv.m3u
        
    - name: Commit and push changes
      run: |
        echo "üíæ Saving changes to repository..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add sirometv.m3u
        
        if git diff --staged --quiet; then
          echo "‚úÖ No changes detected - playlist is up to date"
        else
          # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶®‡ßá‡¶ì‡ßü‡¶æ (BD Time format)
          BANGLADESH_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %I:%M:%S%p BD Time')
          
          # Check if manual or scheduled run
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            git commit -m "üîÑ Manual Update: Added AUTO-UPDATED sections while preserving originals - $BANGLADESH_TIME"
          else
            git commit -m "üîÑ Scheduled Update: Added AUTO-UPDATED sections while preserving originals - $BANGLADESH_TIME"
          fi
          git push
          echo "üéâ Successfully updated playlist with AUTO-UPDATED sections!"
        fi
        
    - name: Cleanup
      run: |
        rm -f main_playlist.m3u source_playlist.m3u
        echo "‚úÖ Cleanup completed!"
