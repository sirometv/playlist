name: Mapping

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download playlists
      run: |
        echo "üì• Downloading playlists..."
        curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        curl -s -L -o source_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/Ayna.m3u"
        
        for file in main_playlist.m3u source_playlist.m3u; do
          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "‚ùå ERROR: $file download failed!"
            exit 1
          fi
          LINES=$(wc -l < "$file")
          echo "‚úÖ $file downloaded - $LINES lines"
        done
        
    - name: Update All Channel
      run: |
        echo "üîÑ Updating All Channel..."
        
        python3 - << 'EOF'
        import re
        from datetime import datetime
        import pytz
        
        # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡¶ø‡¶Ç - ‡¶Æ‡ßá‡¶á‡¶® ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ : [‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ exact keywords]
        CHANNEL_MAPPING = {
            "T Sports": ["T Sports HD", "A Sports", "PTV Sports"],
            "BTV National": ["BTV NATIONAL HD", "BTV World"],
            "BTV CTG": ["BTV CTG"],
            "Channel 9": ["Channel 9"],
            "Channel I": ["Channel I"],
            "Bangla Vision": ["Bangla Vision"],
            "News 24": ["News 24 BD"], 
            "Boishakhi TV": ["Boishakhi TV"],
            "Bijoy TV": ["Bijoy TV"],
            "ATN Bangla": ["ATN Bangla"],
            "ATN-Bangla News": ["ATN News"],
            "DBC News": ["DBC News"],
            "Independent TV": ["Independent TV"],
            "Bangla TV": ["Bangla TV"],
            "Desh TV": ["Desh TV"],
            "RTV": ["RTV"],
            "My TV": ["My TV"],
            # "Somoy TV": ["Somoy News TV", "Somoy TV"],
            # ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶∞‡ßã ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡¶¨‡ßá‡¶®
            # "Channel Name in Main": ["exact_keyword1", "exact_keyword2", "exact_keyword3"]
        }
        
        def get_bangladesh_time():
            """‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶¨‡¶∞‡ßç‡¶§‡¶Æ‡¶æ‡¶® ‡¶∏‡¶Æ‡¶Ø‡¶º ‡¶∞‡¶ø‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶ï‡¶∞‡ßá"""
            bangladesh_tz = pytz.timezone('Asia/Dhaka')
            now = datetime.now(bangladesh_tz)
            return now.strftime("%Y-%m-%d %I:%M:%S%p BD Time") + " üîÑ"
        
        def find_channel_urls(source_file, keywords):
            """‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ URL ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá"""
            with open(source_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            urls = []
            
            # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø exact keyword ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
            for keyword in keywords:
                # Exact match ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø pattern
                # ‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ #EXTINF ‡¶≤‡¶æ‡¶á‡¶®‡ßá exact keyword ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶ö ‡¶ï‡¶∞‡¶¨‡ßá
                pattern = r'#EXTINF:-1[^,]*,[^,]*(?:\s+|^){}[^,\n]*\n(http[^\n]+)'.format(re.escape(keyword))
                matches = re.finditer(pattern, content, re.IGNORECASE)
                
                found = False
                for match in matches:
                    # Exact match ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶® - keyword ‡¶™‡ßÅ‡¶∞‡ßã ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßá ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶π‡¶¨‡ßá
                    extinf_line = match.group(0).split('\n')[0]
                    channel_name_part = extinf_line.split(',', 1)[1] if ',' in extinf_line else ""
                    
                    # Exact match verification - keyword should appear as a whole word
                    if re.search(rf'\b{re.escape(keyword)}\b', channel_name_part, re.IGNORECASE):
                        url = match.group(1).strip()
                        print(f"‚úÖ Found exact match for keyword '{keyword}': {url[:80]}...")
                        urls.append((keyword, url))
                        found = True
                        break  # ‡¶∂‡ßÅ‡¶ß‡ßÅ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ exact match ‡¶®‡¶ø‡¶®
                
                if not found:
                    print(f"‚ùå No exact match found for keyword: '{keyword}'")
            
            return urls
        
        def update_channel_urls(main_content, channel_name, channel_urls, is_manual_run=False):
            """‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï URL ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßá"""
            if not channel_urls:
                return main_content
            
            timestamp = get_bangladesh_time()
            
            # Pattern: #EXTINF ‡¶≤‡¶æ‡¶á‡¶® ‡¶Ø‡ßá‡¶ñ‡¶æ‡¶®‡ßá channel_name ‡¶Ü‡¶õ‡ßá
            pattern_extinf = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)'.format(re.escape(channel_name))
            
            match = re.search(pattern_extinf, main_content, re.IGNORECASE)
            if not match:
                print(f"‚ùå {channel_name} not found in main playlist")
                return main_content
            
            extinf_line = match.group(1)
            
            # URL ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ ‡¶Ö‡¶®‡ßÅ‡¶Ø‡¶æ‡¶Ø‡¶º‡ßÄ üîÑ ‡¶á‡¶Æ‡ßã‡¶ú‡¶ø ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
            refresh_emoji = "üîÑ" * len(channel_urls)
            
            # ‡¶ü‡¶æ‡¶á‡¶Æ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶Æ‡ßç‡¶™‡ßá ‡¶á‡¶Æ‡ßã‡¶ú‡¶ø ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
            timestamp_with_emoji = f"{timestamp.split(' üîÑ')[0]} {refresh_emoji}"
            
            # ‡¶®‡¶§‡ßÅ‡¶® AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
            auto_updated_block = f"#AUTO-UPDATED - {channel_name} - {timestamp_with_emoji}\n"
            
            # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø URL ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
            for keyword, url in channel_urls:
                auto_updated_block += f"{url}\n"
            
            if is_manual_run:
                # Manual run: ‡¶®‡¶§‡ßÅ‡¶® AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá
                pattern = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)(#AUTO-UPDATED[^\n]*\n(?:http[^\n]*\n)*)'.format(re.escape(channel_name))
                
                if re.search(pattern, main_content, re.IGNORECASE):
                    # ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶®
                    def replacement(match):
                        return match.group(1) + auto_updated_block
                    
                    updated_content = re.sub(pattern, replacement, main_content, flags=re.IGNORECASE)
                    print(f"‚úÖ Manual run: Replaced {len(channel_urls)} links for {channel_name}")
                else:
                    # ‡¶®‡¶§‡ßÅ‡¶® AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                    pattern_extinf_only = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)'.format(re.escape(channel_name))
                    
                    def add_auto_updated(match):
                        return match.group(1) + auto_updated_block
                    
                    updated_content = re.sub(pattern_extinf_only, add_auto_updated, main_content, flags=re.IGNORECASE)
                    print(f"‚úÖ Manual run: Added {len(channel_urls)} new links for {channel_name}")
                
                return updated_content
            else:
                # Scheduled run: ‡¶∂‡ßÅ‡¶ß‡ßÅ AUTO-UPDATED ‡¶¨‡ßç‡¶≤‡¶ï ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡¶¨‡ßá
                pattern = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)(#AUTO-UPDATED[^\n]*\n(?:http[^\n]*\n)*)'.format(re.escape(channel_name))
                
                def replacement(match):
                    return match.group(1) + auto_updated_block
                
                if re.search(pattern, main_content, re.IGNORECASE):
                    updated_content = re.sub(pattern, replacement, main_content, flags=re.IGNORECASE)
                    print(f"‚úÖ Scheduled run: Replaced {len(channel_urls)} links for {channel_name}")
                    return updated_content
                else:
                    # ‡¶Ø‡¶¶‡¶ø AUTO-UPDATED ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá, ‡¶ï‡¶ø‡¶®‡ßç‡¶§‡ßÅ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶®‡¶§‡ßÅ‡¶® ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡¶¨‡ßá
                    pattern_extinf_only = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)'.format(re.escape(channel_name))
                    
                    def add_auto_updated(match):
                        return match.group(1) + auto_updated_block
                    
                    updated_content = re.sub(pattern_extinf_only, add_auto_updated, main_content, flags=re.IGNORECASE)
                    print(f"‚úÖ Scheduled run: Added {len(channel_urls)} new links for {channel_name}")
                    return updated_content
        
        # ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        with open('main_playlist.m3u', 'r', encoding='utf-8') as f:
            main_content = f.read()
        
        # Check if manual run or scheduled
        import os
        is_manual_run = os.environ.get('GITHUB_EVENT_NAME') == 'workflow_dispatch'
        
        updated_content = main_content
        update_count = 0
        
        # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        for main_channel, search_keywords in CHANNEL_MAPPING.items():
            print(f"\nüîç Processing: {main_channel}")
            print(f"   Run type: {'Manual' if is_manual_run else 'Scheduled'}")
            print(f"   Searching for exact keywords: {search_keywords}")
            
            # ‡¶è‡¶ï‡¶æ‡¶ß‡¶ø‡¶ï URL ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®
            channel_urls = find_channel_urls('source_playlist.m3u', search_keywords)
            
            if channel_urls:
                print(f"   Found {len(channel_urls)} URLs: {[keyword for keyword, _ in channel_urls]}")
                updated_content = update_channel_urls(updated_content, main_channel, channel_urls, is_manual_run)
                update_count += len(channel_urls)
            else:
                print(f"‚ö†Ô∏è Skipping {main_channel} - no URLs found for exact keywords")
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
        
        print(f"\nüéâ Update Summary:")
        print(f"   Run type: {'Manual' if is_manual_run else 'Scheduled'}")
        print(f"   Total channels to process: {len(CHANNEL_MAPPING)}")
        print(f"   Total URLs successfully updated: {update_count}")
        
        EOF
        
    - name: Verify and replace playlist
      run: |
        echo "üîç Verifying updated playlist..."
        
        if [ ! -f "sirometv_updated.m3u" ] || [ ! -s "sirometv_updated.m3u" ]; then
          echo "‚ùå ERROR: Updated playlist is missing or empty!"
          exit 1
        fi
        
        mv sirometv_updated.m3u sirometv.m3u
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        echo "üîç Updated channels preview:"
        echo "=== T Sports ==="
        grep -A 5 "T Sports" sirometv.m3u | head -10 || echo "No matching channels found"
        
    - name: Commit and push changes
      run: |
        echo "üíæ Saving changes to repository..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add sirometv.m3u
        
        if git diff --staged --quiet; then
          echo "‚úÖ No changes detected - playlist is up to date"
        else
          # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶®‡ßá‡¶ì‡ßü‡¶æ (BD Time format)
          BANGLADESH_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %I:%M:%S%p BD Time')
          
          # Check if manual or scheduled run
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            git commit -m "üîÑ Manual Update: Multiple Channel Links - $BANGLADESH_TIME"
          else
            git commit -m "üîÑ Scheduled Update: Multiple Channel Links - $BANGLADESH_TIME"
          fi
          git push
          echo "üéâ Successfully updated channels with multiple links!"
        fi
        
    - name: Cleanup
      run: |
        rm -f main_playlist.m3u source_playlist.m3u
        echo "‚úÖ Cleanup completed!"
