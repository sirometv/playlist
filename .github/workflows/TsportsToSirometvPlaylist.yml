name: Tsports To Sirometv Playlist

on:
  schedule:
    # ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶™‡¶∞ ‡¶™‡¶∞ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶π‡¶¨‡ßá
    - cron: '*/5 * * * *'
  workflow_dispatch:  # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶®

permissions:
  contents: write

jobs:
  sync-playlist:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download all playlists
      run: |
        echo "üì• Downloading all playlists..."
        
        # ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/gh-pages/sirometv.m3u"
        
        # ‡¶∏‡ßç‡¶™‡ßã‡¶∞‡ßç‡¶ü‡¶∏ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        curl -s -L -o sports_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/gh-pages/sports.m3u"
        
        # T-Sports ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        curl -s -L -o tsports_playlist.m3u "https://raw.githubusercontent.com/abusaeeidx/T-Sports-Playlist-Auto-Update/refs/heads/main/combine_playlist.m3u"
        
        # ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶∏‡¶´‡¶≤ ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï
        for file in main_playlist.m3u sports_playlist.m3u tsports_playlist.m3u; do
          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "‚ùå ERROR: $file download failed!"
            exit 1
          fi
          LINES=$(wc -l < "$file")
          echo "‚úÖ $file downloaded - $LINES lines"
        done
        
    - name: Extract and update T Sports channels
      run: |
        echo "üîÑ Processing T Sports channels..."
        
        # Python script ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏‡¶ø‡¶Ç
        python3 - << 'EOF'
        import re
        from datetime import datetime
        
        # ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶™‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡ßç‡¶®
        target_patterns = [
            "T Sports Live 01",
            "T Sports HD üáßüá© üì∫ (1)",
            "T Sports HD üáßüá© üì∫ (2)", 
            "T Sports HD (3)",
            "T Sports (720p) (4)",
            "T Sports HD (5)",
            "A Sports",
            "G Sports"
        ]
        
        def extract_channels_from_playlist(playlist_file, patterns):
            """‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßá"""
            channels = {}
            
            with open(playlist_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶Ü‡¶≤‡¶æ‡¶¶‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
            blocks = content.split('#EXTINF:')
            
            for block in blocks[1:]:  # ‡¶™‡ßç‡¶∞‡¶•‡¶Æ‡¶ü‡¶ø ‡¶ñ‡¶æ‡¶≤‡¶ø ‡¶•‡¶æ‡¶ï‡¶§‡ßá ‡¶™‡¶æ‡¶∞‡ßá
                lines = block.strip().split('\n')
                if len(lines) < 2:
                    continue
                    
                extinf_line = '#EXTINF:' + lines[0]
                url_line = lines[1].strip()
                
                # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
                channel_name_match = re.search(r',([^,\n]+)$', extinf_line)
                if not channel_name_match:
                    continue
                    
                channel_name = channel_name_match.group(1).strip()
                
                # ‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü ‡¶™‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡ßç‡¶®‡ßá‡¶∞ ‡¶∏‡¶æ‡¶•‡ßá ‡¶Æ‡¶ø‡¶≤‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
                for pattern in patterns:
                    if pattern in channel_name:
                        if pattern not in channels:
                            channels[pattern] = []
                        channels[pattern].append({
                            'extinf': extinf_line,
                            'url': url_line
                        })
                        print(f"‚úÖ Found: {channel_name}")
                        break
            
            return channels
        
        def update_main_playlist(main_file, channels_data):
            """‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®"""
            with open(main_file, 'r', encoding='utf-8') as f:
                main_content = f.read()
            
            # T Sports ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®
            tsports_pattern = r'(#EXTINF:-1 tvg-logo="[^"]+" group-title="[^"]+",T Sports\n)([^\n]+\n)'
            
            match = re.search(tsports_pattern, main_content)
            if not match:
                print("‚ùå T Sports channel not found in main playlist")
                return main_content
            
            # ‡¶®‡¶§‡ßÅ‡¶® URLs ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
            new_urls = []
            for pattern_name in target_patterns:
                if pattern_name in channels_data:
                    for channel in channels_data[pattern_name]:
                        new_urls.append(channel['url'])
                        print(f"üîó Adding URL for: {pattern_name}")
            
            if not new_urls:
                print("‚ö†Ô∏è No new URLs found to update")
                return main_content
            
            # T Sports ‡¶¨‡ßç‡¶≤‡¶ï ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶®
            replacement = match.group(1) + '\n'.join(new_urls) + '\n'
            updated_content = main_content[:match.start()] + replacement + main_content[match.end():]
            
            print(f"‚úÖ Updated T Sports with {len(new_urls)} URLs")
            return updated_content
        
        # ‡¶∏‡¶¨ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        all_channels = {}
        
        # sports playlist ‡¶•‡ßá‡¶ï‡ßá
        sports_channels = extract_channels_from_playlist('sports_playlist.m3u', target_patterns)
        for key, value in sports_channels.items():
            if key not in all_channels:
                all_channels[key] = []
            all_channels[key].extend(value)
        
        # tsports playlist ‡¶•‡ßá‡¶ï‡ßá  
        tsports_channels = extract_channels_from_playlist('tsports_playlist.m3u', target_patterns)
        for key, value in tsports_channels.items():
            if key not in all_channels:
                all_channels[key] = []
            all_channels[key].extend(value)
        
        print(f"üìä Total channels found: {sum(len(v) for v in all_channels.values())}")
        
        # ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        updated_content = update_main_playlist('main_playlist.m3u', all_channels)
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
        
        # ‡¶∏‡ßç‡¶ü‡ßç‡¶Ø‡¶æ‡¶ü‡¶ø‡¶∏‡ßç‡¶ü‡¶ø‡¶ï‡ßç‡¶∏
        original_lines = len(open('main_playlist.m3u', encoding='utf-8').readlines())
        updated_lines = len(updated_content.split('\n'))
        
        print(f"üìà Original lines: {original_lines}")
        print(f"üìà Updated lines: {updated_lines}")
        print("‚úÖ Processing completed!")
        
        EOF
        
    - name: Verify and replace playlist
      run: |
        echo "üîç Verifying updated playlist..."
        
        if [ ! -f "sirometv_updated.m3u" ] || [ ! -s "sirometv_updated.m3u" ]; then
          echo "‚ùå ERROR: Updated playlist is missing or empty!"
          exit 1
        fi
        
        # ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá T Sports ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
        if ! grep -q 'group-title="Bangladeshi",T Sports' sirometv_updated.m3u; then
          echo "‚ùå ERROR: T Sports channel not found in updated playlist!"
          exit 1
        fi
        
        # ‡¶®‡¶§‡ßÅ‡¶® ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶Æ‡ßÇ‡¶≤ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶®
        mv sirometv_updated.m3u sirometv.m3u
        
        # ‡¶´‡¶≤‡¶æ‡¶´‡¶≤ ‡¶ö‡ßá‡¶ï
        FINAL_LINES=$(wc -l < sirometv.m3u)
        FINAL_CHANNELS=$(grep -c "#EXTINF:" sirometv.m3u)
        
        echo "‚úÖ Verification passed!"
        echo "üìä Final Statistics:"
        echo "   Total lines: $FINAL_LINES"
        echo "   Total channels: $FINAL_CHANNELS"
        
        # T Sports ‡¶è‡¶∞ ‡¶®‡¶ø‡¶ö‡ßá‡¶∞ URLs ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        echo "üîç URLs under T Sports:"
        grep -A 10 'group-title="Bangladeshi",T Sports' sirometv.m3u
        
    - name: Commit and push changes
      run: |
        echo "üíæ Saving changes to repository..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add sirometv.m3u
        
        # ‡¶∂‡ßÅ‡¶ß‡ßÅ changes ‡¶•‡¶æ‡¶ï‡¶≤‡ßá commit ‡¶ï‡¶∞‡ßÅ‡¶®
        if git diff --staged --quiet; then
          echo "‚úÖ No changes detected - playlist is up to date"
        else
          git commit -m "üîÑ Auto Sync T Sports Channels - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "üéâ Successfully updated T Sports channels!"
          echo "üïê Next auto-sync in 5 minutes"
        fi
        
    - name: Cleanup
      run: |
        echo "üßπ Cleaning up temporary files..."
        rm -f main_playlist.m3u sports_playlist.m3u tsports_playlist.m3u
        echo "‚úÖ Cleanup completed!"
