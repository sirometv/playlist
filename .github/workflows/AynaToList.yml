name: Ayna To Listing

on:
  schedule:
    - cron: '*/5 * * * *'  # ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ß´ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶™‡¶∞‡¶™‡¶∞
  workflow_dispatch:  # ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßÅ‡¶Ø‡¶º‡¶æ‡¶≤‡¶ø ‡¶∞‡¶æ‡¶® ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶™‡¶∂‡¶®

permissions:
  contents: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Bangladesh timezone
      run: |
        echo "üåè Setting up Bangladesh timezone..."
        sudo timedatectl set-timezone Asia/Dhaka
        echo "‚úÖ Bangladesh timezone set: $(TZ='Asia/Dhaka' date)"
        
    - name: Download playlists
      run: |
        echo "üì• Downloading playlists..."
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        BD_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S')
        echo "üïê Download started at: $BD_TIME (Bangladesh Time)"
        
        # ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶è‡¶¨‡¶Ç ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶°
        curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        curl -s -L -o source_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/Ayna.m3u"
        
        # ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶≠‡ßá‡¶∞‡¶ø‡¶´‡¶ø‡¶ï‡ßá‡¶∂‡¶®
        for file in main_playlist.m3u source_playlist.m3u; do
          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "‚ùå ERROR: $file download failed!"
            exit 1
          fi
          LINES=$(wc -l < "$file")
          CHANNELS=$(grep -c "#EXTINF:" "$file" 2>/dev/null || echo "0")
          echo "‚úÖ $file downloaded - $LINES lines, $CHANNELS channels"
        done
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Update multiple channels
      run: |
        echo "üîÑ Updating multiple channels..."
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
        BD_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        echo "üïê Update process started at: $BD_TIME"
        
        python3 - << 'EOF'
        import re
        from datetime import datetime
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
        current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S Bangladesh Time')
        
        # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡¶ø‡¶Ç - ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§ ‡¶≠‡¶æ‡¶∞‡ßç‡¶∏‡¶®
        CHANNEL_MAPPING = {
            "BTV National": ["BTV NATIONAL HD", "BTV World"],
            "BTV CTG": ["BTV CTG"],
            "Somoy TV": ["Somoy News TV", "Somoy TV", "SOMOY TV", "somoy tv", "Somoy", "SOMOY"],
            "Jamuna TV": ["Jamuna TV", "JAMUNA"],
            "NTV BD": ["NTV", "NTV HD"],
            "Ekushey TV": ["Ekushey TV", "Ekushey TV HD"],
            "Channel 24": ["Channel 24", "Channel 24 HD"],
            "Deen TV": ["Deen TV"],
            "SA TV": ["SA TV"],
            "GTV": ["Gazi TV", "GTV HD", "GTV Sports"],  # ‡¶∏‡¶Ç‡¶∂‡ßã‡¶ß‡¶ø‡¶§
            "T Sports": ["T Sports HD", "TSports", "Tsports", "TSPORTS", "T Sports", "T SPORTS HD", "tsportshd"],
            "Channel 9": ["Channel 9", "Channel 9 HD"],
            "Channel I": ["Channel I", "CHANNEL I", "channel i HD", "Channel-I", "CHANNEL I HD"],
            "Bangla Vision": ["Bangla Vision", "Bangla Vision HD"],
            "ATN Bangla": ["ATN Bangla", "ATN BANGLA", "atn bangla", "ATN", "atn"],
            "RTV": ["RTV", "rtv", "Rtv"],
            "Peace TV Bangla": ["Peace TV Bangla HD"],
            "Rongeen TV": ["Rongeen TV"],
            "Gaan Bangla": ["Gaan Bangla", "GAAN BANGLA", "gaan bangla", "Gaan", "GAAN"],
            "Star Jalsha": ["Star Jalsha HD", "Star Jalsha"],
            "Star Jalsha Movies": ["Star Jalsha Movies HD"],
            "Zee Bangla": ["Zee Bangla International", "Zee Bangla"],
            "Zee Bangla Cinema": ["Zee Bangla Cinema"],
        }
        
        def find_channel_urls(source_file, keywords):
            """‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶∏‡¶ï‡¶≤ URL ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá"""
            try:
                with open(source_file, 'r', encoding='utf-8') as f:
                    content = f.read()
            except:
                with open(source_file, 'r', encoding='latin-1') as f:
                    content = f.read()
            
            found_urls = []
            
            # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø keyword ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
            for keyword in keywords:
                try:
                    # Flexible matching - keyword ‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßá‡¶∞ ‡¶Æ‡¶ß‡ßç‡¶Ø‡ßá ‡¶Ü‡¶õ‡ßá ‡¶ï‡¶ø‡¶®‡¶æ
                    pattern = r'#EXTINF:[^\n]*{}[^\n]*\n(http[^\s]+)'.format(re.escape(keyword))
                    matches = re.findall(pattern, content, re.IGNORECASE)
                    
                    for url in matches:
                        clean_url = url.strip()
                        if clean_url and clean_url not in found_urls:
                            found_urls.append(clean_url)
                            print(f"‚úÖ Found URL for keyword '{keyword}': {clean_url}")
                except Exception as e:
                    print(f"‚ö† Error searching for '{keyword}': {e}")
                    continue
            
            return found_urls
        
        def update_channel_urls(main_content, channel_name, new_urls):
            """‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ URL ‡¶ó‡ßÅ‡¶≤‡ßã ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßá"""
            if not new_urls:
                print(f"‚ö† No URLs found for {channel_name}, skipping update")
                return main_content
            
            # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶¨‡ßç‡¶≤‡¶ï ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® (EXTINF ‡¶≤‡¶æ‡¶á‡¶® ‡¶è‡¶¨‡¶Ç ‡¶™‡¶∞‡ßá‡¶∞ URL ‡¶≤‡¶æ‡¶á‡¶®)
            pattern = r'(#EXTINF:[^\n]*{}[^\n]*\n)(?:http[^\n]*\n)*'.format(re.escape(channel_name))
            match = re.search(pattern, main_content, re.IGNORECASE)
            
            if match:
                # ‡¶®‡¶§‡ßÅ‡¶® URL ‡¶¨‡ßç‡¶≤‡¶ï ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
                new_url_block = match.group(1) + '\n'.join(new_urls) + '\n'
                
                # ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶¨‡ßç‡¶≤‡¶ï ‡¶∞‡¶ø‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶ï‡¶∞‡ßÅ‡¶®
                updated_content = re.sub(
                    pattern, 
                    new_url_block, 
                    main_content, 
                    flags=re.IGNORECASE
                )
                
                print(f"‚úÖ Successfully updated {channel_name} with {len(new_urls)} URLs")
                return updated_content
            else:
                print(f"‚ùå {channel_name} not found in main playlist")
                return main_content
        
        try:
            # ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
            with open('main_playlist.m3u', 'r', encoding='utf-8') as f:
                main_content = f.read()
        except:
            with open('main_playlist.m3u', 'r', encoding='latin-1') as f:
                main_content = f.read()
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶™‡ßç‡¶∞‡¶∏‡ßá‡¶∏ ‡¶∂‡ßÅ‡¶∞‡ßÅ
        updated_content = main_content
        update_count = 0
        successful_updates = []
        failed_updates = []
        
        # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        for main_channel, search_keywords in CHANNEL_MAPPING.items():
            print(f"\nüîç Processing: {main_channel}")
            new_urls = find_channel_urls('source_playlist.m3u', search_keywords)
            
            if new_urls:
                updated_content = update_channel_urls(updated_content, main_channel, new_urls)
                update_count += 1
                successful_updates.append(main_channel)
            else:
                print(f"‚ö† Skipping {main_channel} - no URL found")
                failed_updates.append(main_channel)
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶° ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
        
        print(f"\nüéâ Update Summary:")
        print(f"   Total channels processed: {len(CHANNEL_MAPPING)}")
        print(f"   Successfully updated: {update_count}")
        print(f"   Failed: {len(failed_updates)}")
        
        EOF
        
    - name: Verify and replace playlist
      run: |
        echo "üîç Verifying updated playlist..."
        
        if [ ! -f "sirometv_updated.m3u" ] || [ ! -s "sirometv_updated.m3u" ]; then
          echo "‚ùå ERROR: Updated playlist is missing or empty!"
          exit 1
        fi
        
        # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
        OLD_CHANNELS=$(grep -c "#EXTINF:" main_playlist.m3u 2>/dev/null || echo "0")
        NEW_CHANNELS=$(grep -c "#EXTINF:" sirometv_updated.m3u 2>/dev/null || echo "0")
        
        echo "üìä Channel Count:"
        echo "   Before: $OLD_CHANNELS channels"
        echo "   After: $NEW_CHANNELS channels"
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        echo "üîç Sample updated channels:"
        for channel in "T Sports" "Somoy TV" "Channel I" "SA TV" "NTV BD"; do
          echo "--- $channel ---"
          grep -A 2 "$channel" sirometv_updated.m3u | head -3 || echo "Not found"
        done
        
        mv sirometv_updated.m3u sirometv.m3u
        
    - name: Commit and push changes
      run: |
        echo "üíæ Saving changes to repository..."
        
        # ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡¶¶‡ßá‡¶∂‡ßá‡¶∞ ‡¶∏‡¶Æ‡ßü ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π
        COMMIT_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add sirometv.m3u
        
        if git diff --staged --quiet; then
          echo "‚úÖ No changes detected - playlist is up to date"
        else
          git commit -m "üîÑ Auto Update Channels from Ayna - $COMMIT_TIME"
          git push
          echo "üéâ Successfully updated channels from Ayna playlist!"
        fi
        
    - name: Cleanup
      run: |
        rm -f main_playlist.m3u source_playlist.m3u
        echo "‚úÖ Cleanup completed!"
        echo "üèÅ Ayna to Listing workflow finished successfully!"
