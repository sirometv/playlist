name: Ayna To Listing

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download playlists
      run: |
        echo "üì• Downloading playlists..."
        curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        curl -s -L -o source_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/Ayna.m3u"
        
        for file in main_playlist.m3u source_playlist.m3u; do
          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "‚ùå ERROR: $file download failed!"
            exit 1
          fi
          LINES=$(wc -l < "$file")
          echo "‚úÖ $file downloaded - $LINES lines"
        done
        
    - name: Update multiple channels
      run: |
        echo "üîÑ Updating multiple channels..."
        
        python3 - << 'EOF'
        import re
        
        # ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡¶ø‡¶Ç - ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶•‡¶Æ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ : ‡¶∏‡ßá‡¶ï‡ßá‡¶®‡ßç‡¶° ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶ñ‡ßÅ‡¶Å‡¶ú‡¶¨‡ßá ‡¶è‡¶Æ‡¶® keywords
        CHANNEL_MAPPING = {
    "T Sports": ["T Sports HD", "TSports", "Tsports", "TSPORTS", "T Sports", "T SPORTS HD", "tsportshd", "T Sports HD"],
    "Somoy TV": ["Somoy News TV", "Somoy TV", "SOMOY TV", "somoy tv", "Somoy", "SOMOY"],
    "Channel I": ["Channel I", "CHANNEL I", "channel i", "Channel-I", "CHANNEL-I"],
    "ATN Bangla": ["ATN Bangla", "ATN BANGLA", "atn bangla", "ATN", "atn"],
    "NTV": ["NTV", "ntv", "Ntv", "N TV"],
    "RTV": ["RTV", "rtv", "Rtv"],
    "BTV": ["BTV", "btv", "Bangladesh Television", "BTV HD"],
    "Gaan Bangla": ["Gaan Bangla", "GAAN BANGLA", "gaan bangla", "Gaan", "GAAN"],
    "Boishakhi TV": ["Boishakhi TV", "BOISHAKHI TV", "boishakhi tv", "Boishakhi", "BOISHAKHI"],
    "Independent TV": ["Independent TV", "INDEPENDENT TV", "independent tv", "Independent", "INDEPENDENT"],
    "News24": ["News24", "NEWS24", "news24"],
    "Ekattor TV": ["Ekattor TV", "EKATTOR TV", "ekattor tv", "Ekattor", "EKATTOR"],
    "SATV": ["SATV", "satv", "Sa TV", "SA TV"],
    "Duronto TV": ["Duronto TV", "DURONTO TV", "duronto tv", "Duronto", "DURONTO"],
    "Deal TV": ["Deal TV", "DEAL TV", "deal tv", "Deal", "DEAL"],
    "Channel 9": ["Channel 9", "CHANNEL 9", "channel 9", "Channel9", "CHANNEL9"],
    "Bangla TV": ["Bangla TV", "BANGLA TV", "bangla tv", "Bangla", "BANGLA"],
    "Sangsad TV": ["Sangsad TV", "SANGSAD TV", "sangsad tv", "Sangsad", "SANGSAD"],
    "My TV": ["My TV", "MY TV", "my tv", "My", "MY"],
    "Mohona TV": ["Mohona TV", "MOHONA TV", "mohona tv", "Mohona", "MOHONA"],
    "Jamuna TV": ["Jamuna TV", "JAMUNA TV", "jamuna tv", "Jamuna", "JAMUNA"],
    "Asian TV": ["Asian TV", "ASIAN TV", "asian tv", "Asian", "ASIAN"],
    "Machranga TV": ["Machranga TV", "MACHRANGA TV", "machranga tv", "Machranga", "MACHRANGA"],
    "DBC News": ["DBC News", "DBC NEWS", "dbc news", "DBC", "dbc"],
    
    # Indian Channels
    "Star Jalsha": ["Star Jalsha", "STAR JALSHA", "star jalsha", "Jalsha", "JALSHA"],
    "Zee Bangla": ["Zee Bangla", "ZEE BANGLA", "zee bangla", "Zee", "ZEE"],
    "Colors Bangla": ["Colors Bangla", "COLORS BANGLA", "colors bangla", "Colors", "COLORS"],
    "Sony Aath": ["Sony Aath", "SONY AATH", "sony aath", "Aath", "AATH"],
    "Star Plus": ["Star Plus", "STAR PLUS", "star plus", "Star", "STAR"],
    "Zee TV": ["Zee TV", "ZEE TV", "zee tv", "Zee", "ZEE"],
    "Sony TV": ["Sony TV", "SONY TV", "sony tv", "Sony", "SONY"],
    "Colors TV": ["Colors TV", "COLORS TV", "colors tv", "Colors", "COLORS"],
    
    # Sports Channels
    "Star Sports": ["Star Sports", "STAR SPORTS", "star sports", "Star Sports 1", "Star Sports 2"],
    "Sony Ten": ["Sony Ten", "SONY TEN", "sony ten", "Sony Ten 1", "Sony Ten 2"],
    "ESPN": ["ESPN", "espn", "ESPN HD"],
    
    # News Channels
    "CNN": ["CNN", "cnn", "CNN International", "CNN INT"],
    "BBC World": ["BBC World", "BBC WORLD", "bbc world", "BBC", "bbc"],
    "Al Jazeera": ["Al Jazeera", "AL JAZEERA", "al jazeera", "Aljazeera"],
    
    # Movie Channels
    "HBO": ["HBO", "hbo", "HBO HD", "HBO Signature"],
    "Star Movies": ["Star Movies", "STAR MOVIES", "star movies", "Star Movie"],
    "Zee Cinema": ["Zee Cinema", "ZEE CINEMA", "zee cinema", "Z Cinema"],
    
    # Music Channels
    "MTV": ["MTV", "mtv", "MTV HD"],
    "VH1": ["VH1", "vh1", "VH1 HD"],
    
    # Kids Channels
    "Cartoon Network": ["Cartoon Network", "CARTOON NETWORK", "cartoon network", "CN", "cn"],
    "Pogo": ["Pogo", "POGO", "pogo", "POGO TV"],
    "Disney": ["Disney", "DISNEY", "disney", "Disney Channel"]
}
        
        def find_channel_url(source_file, keywords):
            """‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶•‡ßá‡¶ï‡ßá ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤ URL ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡ßá"""
            with open(source_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # ‡¶∏‡¶¨ keywords ‡¶è‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶ö‡ßá‡¶∑‡ßç‡¶ü‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®
            for keyword in keywords:
                pattern = r'#EXTINF:[^\n]*{}[^\n]*\n(http[^\n]+)'.format(re.escape(keyword))
                match = re.search(pattern, content, re.IGNORECASE)
                
                if match:
                    url = match.group(1).strip()
                    print(f"‚úÖ Found URL for keyword '{keyword}': {url}")
                    return url
            
            print(f"‚ùå No URL found for keywords: {keywords}")
            return None
        
        def update_channel_url(main_content, channel_name, new_url):
            """‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü‡ßá ‡¶®‡¶ø‡¶∞‡ßç‡¶¶‡¶ø‡¶∑‡ßç‡¶ü ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ URL ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßá"""
            pattern = r'(#EXTINF:[^\n]*{}[^\n]*\n)(http[^\n]+)'.format(re.escape(channel_name))
            
            if re.search(pattern, main_content, re.IGNORECASE):
                updated_content = re.sub(
                    pattern, 
                    r'\1' + new_url, 
                    main_content, 
                    flags=re.IGNORECASE
                )
                print(f"‚úÖ Successfully updated {channel_name} URL")
                return updated_content
            else:
                print(f"‚ùå {channel_name} not found in main playlist")
                return main_content
        
        # ‡¶Æ‡ßá‡¶á‡¶® ‡¶™‡ßç‡¶≤‡ßá‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
        with open('main_playlist.m3u', 'r', encoding='utf-8') as f:
            main_content = f.read()
        
        updated_content = main_content
        update_count = 0
        
        # ‡¶™‡ßç‡¶∞‡¶§‡¶ø‡¶ü‡¶ø ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
        for main_channel, search_keywords in CHANNEL_MAPPING.items():
            print(f"\nüîç Processing: {main_channel}")
            new_url = find_channel_url('source_playlist.m3u', search_keywords)
            
            if new_url:
                updated_content = update_channel_url(updated_content, main_channel, new_url)
                update_count += 1
            else:
                print(f"‚ö†Ô∏è Skipping {main_channel} - no URL found")
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶ï‡¶®‡ßç‡¶ü‡ßá‡¶®‡ßç‡¶ü ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
        with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
        
        print(f"\nüéâ Update Summary:")
        print(f"   Total channels processed: {len(CHANNEL_MAPPING)}")
        print(f"   Successfully updated: {update_count}")
        print(f"   Failed: {len(CHANNEL_MAPPING) - update_count}")
        
        EOF
        
    - name: Verify and replace playlist
      run: |
        echo "üîç Verifying updated playlist..."
        
        if [ ! -f "sirometv_updated.m3u" ] || [ ! -s "sirometv_updated.m3u" ]; then
          echo "‚ùå ERROR: Updated playlist is missing or empty!"
          exit 1
        fi
        
        mv sirometv_updated.m3u sirometv.m3u
        
        # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶ö‡ßç‡¶Ø‡¶æ‡¶®‡ßá‡¶≤‡¶ó‡ßÅ‡¶≤‡ßã ‡¶¶‡ßá‡¶ñ‡¶æ‡¶®
        echo "üîç Updated channels:"
        grep -A 1 -E "Somoy TV|T Sports" sirometv.m3u || echo "No matching channels found"
        
    - name: Commit and push changes
      run: |
        echo "üíæ Saving changes to repository..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add sirometv.m3u
        
        if git diff --staged --quiet; then
          echo "‚úÖ No changes detected - playlist is up to date"
        else
          git commit -m "üîÑ Auto Update Multiple Channels - $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "üéâ Successfully updated channels!"
        fi
        
    - name: Cleanup
      run: |
        rm -f main_playlist.m3u source_playlist.m3u
        echo "‚úÖ Cleanup completed!"
