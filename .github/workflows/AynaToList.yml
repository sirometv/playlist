name: Ayna To Listing

on:
  schedule:
    - cron: '*/5 * * * *'  # à¦ªà§à¦°à¦¤à¦¿ à§« à¦®à¦¿à¦¨à¦¿à¦Ÿ à¦ªà¦°à¦ªà¦°
  workflow_dispatch:  # à¦®à§à¦¯à¦¾à¦¨à§à¦¯à¦¼à¦¾à¦²à¦¿ à¦°à¦¾à¦¨ à¦•à¦°à¦¾à¦° à¦…à¦ªà¦¶à¦¨

permissions:
  contents: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Bangladesh timezone
      run: |
        echo "ğŸŒ Setting up Bangladesh timezone..."
        sudo timedatectl set-timezone Asia/Dhaka
        echo "âœ… Bangladesh timezone set: $(TZ='Asia/Dhaka' date)"
        
    - name: Download playlists
      run: |
        echo "ğŸ“¥ Downloading playlists..."
        
        # à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶à§‡à¦° à¦¸à¦®à§Ÿ à¦¦à§‡à¦–à¦¾à¦¨
        BD_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S')
        echo "ğŸ• Download started at: $BD_TIME (Bangladesh Time)"
        
        # à¦®à§‡à¦‡à¦¨ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿ à¦à¦¬à¦‚ à¦¸à§‹à¦°à§à¦¸ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿ à¦¡à¦¾à¦‰à¦¨à¦²à§‹à¦¡
        curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        curl -s -L -o source_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/Ayna.m3u"
        
        # à¦¡à¦¾à¦‰à¦¨à¦²à§‹à¦¡ à¦­à§‡à¦°à¦¿à¦«à¦¿à¦•à§‡à¦¶à¦¨
        for file in main_playlist.m3u source_playlist.m3u; do
          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "âŒ ERROR: $file download failed!"
            exit 1
          fi
          LINES=$(wc -l < "$file")
          CHANNELS=$(grep -c "#EXTINF:" "$file" 2>/dev/null || echo "0")
          echo "âœ… $file downloaded - $LINES lines, $CHANNELS channels"
        done
        
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
        
    - name: Update multiple channels
      run: |
        echo "ğŸ”„ Updating multiple channels..."
        
        # à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶à§‡à¦° à¦¸à¦®à§Ÿ à¦¸à¦‚à¦—à§à¦°à¦¹
        BD_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        echo "ğŸ• Update process started at: $BD_TIME"
        
        python3 - << 'EOF'
        import re
        from datetime import datetime
        
        # à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶à§‡à¦° à¦¸à¦®à§Ÿ à¦¸à¦‚à¦—à§à¦°à¦¹
        current_time = datetime.now().strftime('%Y-%m-%d %H:%M:%S Bangladesh Time')
        
        # à¦šà§à¦¯à¦¾à¦¨à§‡à¦² à¦®à§à¦¯à¦¾à¦ªà¦¿à¦‚ - à¦¶à§à¦§à§ Exact Match à¦¹à¦¬à§‡
        CHANNEL_MAPPING = {
            "BTV National": ["BTV NATIONAL HD", "BTV World"],
            "BTV CTG": ["BTV CTG"],
            "Somoy TV": ["Somoy TV"],
            "Jamuna TV": ["Jamuna TV"],
            "NTV BD": ["NTV"],
            "NTV-Europe": ["NTV Europe"],
            "Ekushey TV": ["Ekushey TV"],
            "Channel 24": ["Channel 24"],
            "Deen TV": ["Deen TV"],
            "SATV": ["SA TV"],
            "GTV": ["GTV"],
            "T Sports": ["T Sports HD"],
            "Channel 9": ["Channel 9"],
            "Channel I": ["Channel I"],
            "News 24": ["News 24 BD"],
            "Bangla Vision": ["Bangla Vision"],
            "ATN Bangla": ["ATN Bangla"],
            "ATN-Bangla News": ["ATN News"],
            "Asian TV": ["Asian TV"],
            "RTV": ["RTV"],
            "Ekhon TV": ["Ekhon TV"],
            "Duronto": ["Duronto TV"],
            "Deepto TV": ["Deepto TV"],
            "Mohona TV": ["Mohona TV"],
            "Ananda TV": ["Ananda TV"],
            "Bijoy TV": ["Bijoy TV"],
            "Boishakhi TV": ["Boishakhi TV"],
            "DBC News": ["DBC News"],
            "Independent TV": ["Independent TV"],
            "Bangla TV": ["Bangla TV"],
            "Desh TV": ["Desh TV"],
            "My TV": ["My TV"],
            "Ekattor TV": ["Ekattor TV"],
            "Peace TV Bangla": ["Peace TV Bangla HD"],
            "Rongeen TV": ["Rongeen TV"],
            "Gaan Bangla": ["Gaan Bangla"],
            "Star Jalsha": ["Star Jalsha"],
            "Star-Jalsha Movies": ["Star Jalsha Movies HD"],
            "Zee Bangla": ["Zee Bangla"],
            "Zee-Bangla Cinema": ["Zee Bangla Cinema"],
        }
        
        def find_exact_channel_urls(source_file, keywords):
            """à¦¸à§‹à¦°à§à¦¸ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿ à¦¥à§‡à¦•à§‡ à¦¶à§à¦§à§ Exact Match à¦šà§à¦¯à¦¾à¦¨à§‡à¦²à§‡à¦° URL à¦–à§à¦à¦œà§‡ à¦¬à§‡à¦° à¦•à¦°à§‡"""
            try:
                with open(source_file, 'r', encoding='utf-8') as f:
                    content = f.read()
            except:
                with open(source_file, 'r', encoding='latin-1') as f:
                    content = f.read()
            
            found_urls = []
            
            # à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ keyword à¦à¦° à¦œà¦¨à§à¦¯ Exact Match à¦•à¦°à§à¦¨
            for keyword in keywords:
                try:
                    # Exact matching - à¦¶à§à¦§à§ à¦¸à§‡à¦‡ à¦šà§à¦¯à¦¾à¦¨à§‡à¦²à¦—à§à¦²à§‹ à¦¨à¦¿à¦¨ à¦¯à§‡à¦–à¦¾à¦¨à§‡ keyword à¦Ÿà¦¿ exact match
                    pattern = r'#EXTINF:[^\n]*\b{}\b[^\n]*\n(http[^\s]+)'.format(re.escape(keyword))
                    matches = re.findall(pattern, content, re.IGNORECASE)
                    
                    for url in matches:
                        clean_url = url.strip()
                        if clean_url and clean_url not in found_urls:
                            found_urls.append(clean_url)
                            print(f"âœ… Found exact match URL for keyword '{keyword}': {clean_url}")
                            
                except Exception as e:
                    print(f"âš  Error searching for '{keyword}': {e}")
                    continue
            
            return found_urls
        
        def update_channel_safely(main_content, channel_name, new_urls):
            """à¦®à§‡à¦‡à¦¨ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿà§‡ à¦šà§à¦¯à¦¾à¦¨à§‡à¦² à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à§‡ - Manual URLs à¦¸à¦®à§à¦ªà§‚à¦°à§à¦£ à¦¸à§à¦°à¦•à§à¦·à¦¿à¦¤"""
            if not new_urls:
                print(f"âš  No URLs found for {channel_name}, skipping update")
                return main_content
            
            # à¦šà§à¦¯à¦¾à¦¨à§‡à¦²à§‡à¦° à¦¸à¦®à§à¦ªà§‚à¦°à§à¦£ à¦¬à§à¦²à¦• à¦–à§à¦à¦œà§‡ à¦¬à§‡à¦° à¦•à¦°à§à¦¨
            pattern = r'(#EXTINF:[^\n]*{}[^\n]*\n)((?:#AUTO-UPDATED[^\n]*\n)?(?:http[^\n]*\n)*)'.format(re.escape(channel_name))
            match = re.search(pattern, main_content, re.IGNORECASE)
            
            if not match:
                print(f"âŒ {channel_name} not found in main playlist")
                return main_content
            
            extinf_line = match.group(1)
            existing_block = match.group(2)
            
            # Manual URLs à¦†à¦²à¦¾à¦¦à¦¾ à¦•à¦°à§à¦¨ (à¦¯à§‡à¦—à§à¦²à§‹ #AUTO-UPDATED à¦•à¦®à§‡à¦¨à§à¦Ÿà§‡à¦° à¦¸à¦¾à¦¥à§‡ à¦¨à§‡à¦‡)
            manual_urls = []
            lines = existing_block.split('\n')
            
            i = 0
            in_auto_section = False
            
            while i < len(lines):
                line = lines[i].strip()
                if not line:
                    i += 1
                    continue
                    
                if line.startswith('#AUTO-UPDATED'):
                    in_auto_section = True
                    i += 1
                    # Skip all URLs after AUTO-UPDATED comment
                    while i < len(lines) and lines[i].strip().startswith('http'):
                        i += 1
                    continue
                elif line.startswith('http'):
                    if not in_auto_section:
                        manual_urls.append(line)
                    i += 1
                else:
                    i += 1
            
            print(f"ğŸ“Š Found {len(manual_urls)} manual URLs for {channel_name}")
            
            # à¦¨à¦¤à§à¦¨ AUTO-UPDATED à¦¬à§à¦²à¦• à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨
            new_auto_block = f"#AUTO-UPDATED - {current_time}\\n"
            for url in new_urls:
                new_auto_block += url + "\\n"
            
            # Manual URLs à¦¬à§à¦²à¦•
            manual_block = ""
            if manual_urls:
                manual_block = "\\n".join(manual_urls) + "\\n"
            
            # à¦¸à¦®à§à¦ªà§‚à¦°à§à¦£ à¦¨à¦¤à§à¦¨ à¦¬à§à¦²à¦• à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨
            new_complete_block = extinf_line + new_auto_block + manual_block
            
            # Simple String Replacement à¦¬à§à¦¯à¦¬à¦¹à¦¾à¦° à¦•à¦°à§à¦¨
            updated_content = main_content.replace(match.group(0), new_complete_block)
            
            print(f"âœ… Successfully updated {channel_name}")
            print(f"   Auto URLs added: {len(new_urls)}")
            print(f"   Manual URLs preserved: {len(manual_urls)}")
            
            return updated_content
        
        try:
            # à¦®à§‡à¦‡à¦¨ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿ à¦²à§‹à¦¡ à¦•à¦°à§à¦¨
            with open('main_playlist.m3u', 'r', encoding='utf-8') as f:
                main_content = f.read()
        except:
            with open('main_playlist.m3u', 'r', encoding='latin-1') as f:
                main_content = f.read()
        
        # Backup manual content
        original_content = main_content
        
        # à¦†à¦ªà¦¡à§‡à¦Ÿ à¦ªà§à¦°à¦¸à§‡à¦¸ à¦¶à§à¦°à§
        updated_content = main_content
        update_count = 0
        successful_updates = []
        failed_updates = []
        
        # à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦šà§à¦¯à¦¾à¦¨à§‡à¦²à§‡à¦° à¦œà¦¨à§à¦¯ à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à§à¦¨
        for main_channel, search_keywords in CHANNEL_MAPPING.items():
            print(f"\\nğŸ” Processing: {main_channel}")
            print(f"   Searching for exact matches: {search_keywords}")
            
            # à¦¶à§à¦§à§ Exact Match URLs à¦¨à¦¿à¦¨
            new_urls = find_exact_channel_urls('source_playlist.m3u', search_keywords)
            
            if new_urls:
                updated_content = update_channel_safely(updated_content, main_channel, new_urls)
                update_count += 1
                successful_updates.append(main_channel)
            else:
                print(f"âš  No exact matches found for {main_channel}")
                failed_updates.append(main_channel)
        
        # Manual URLs Safety Check
        original_manual_count = len(re.findall(r'^http[^\n]*\n', original_content, re.MULTILINE))
        updated_manual_count = len(re.findall(r'^http[^\n]*\n', updated_content, re.MULTILINE))
        
        print(f"\\nğŸ”’ Manual URLs Safety Check:")
        print(f"   Before update: {original_manual_count} URLs")
        print(f"   After update: {updated_manual_count} URLs")
        
        if original_manual_count > updated_manual_count:
            print("âŒ WARNING: Some manual URLs may have been lost!")
            # Restore from backup if URLs are lost
            updated_content = original_content
            print("ğŸ”„ Restored original content to protect manual URLs")
        else:
            print("âœ… Manual URLs are safe!")
        
        # à¦†à¦ªà¦¡à§‡à¦Ÿà§‡à¦¡ à¦Ÿà¦¾à¦‡à¦® à¦¸à¦¹ à¦¹à§‡à¦¡à¦¾à¦° à¦¯à§‹à¦— à¦•à¦°à§à¦¨
        header_comment = f"\\n# Auto-updated from Ayna.m3u\\n# Last Updated: {current_time}\\n# Total Channels Updated: {update_count}\\n# Manual URLs are preserved, Auto URLs are on top\\n"
        
        # à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦•à¦¨à§à¦Ÿà§‡à¦¨à§à¦Ÿ à¦¸à§‡à¦­ à¦•à¦°à§à¦¨
        with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
            f.write(header_comment)
        
        print(f"\\nğŸ‰ Update Summary:")
        print(f"   Total channels processed: {len(CHANNEL_MAPPING)}")
        print(f"   Successfully updated: {update_count}")
        print(f"   Failed: {len(failed_updates)}")
        if successful_updates:
            print(f"   Updated channels: {', '.join(successful_updates)}")
        if failed_updates:
            print(f"   No matches found for: {', '.join(failed_updates)}")
        
        EOF
        
    - name: Verify and replace playlist
      run: |
        echo "ğŸ” Verifying updated playlist..."
        
        if [ ! -f "sirometv_updated.m3u" ] || [ ! -s "sirometv_updated.m3u" ]; then
          echo "âŒ ERROR: Updated playlist is missing or empty!"
          exit 1
        fi
        
        # à¦šà§à¦¯à¦¾à¦¨à§‡à¦² à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦šà§‡à¦• à¦•à¦°à§à¦¨
        OLD_CHANNELS=$(grep -c "#EXTINF:" main_playlist.m3u 2>/dev/null || echo "0")
        NEW_CHANNELS=$(grep -c "#EXTINF:" sirometv_updated.m3u 2>/dev/null || echo "0")
        
        echo "ğŸ“Š Channel Count:"
        echo "   Before: $OLD_CHANNELS channels"
        echo "   After: $NEW_CHANNELS channels"
        
        # Verification Step - URL à¦•à¦¾à¦‰à¦¨à§à¦Ÿ à¦šà§‡à¦• à¦•à¦°à§à¦¨
        OLD_URLS=$(grep -c "^http" main_playlist.m3u 2>/dev/null || echo "0")
        NEW_URLS=$(grep -c "^http" sirometv_updated.m3u 2>/dev/null || echo "0")
        
        echo "ğŸ“Š URL Count Verification:"
        echo "   Before: $OLD_URLS URLs"
        echo "   After: $NEW_URLS URLs"
        
        if [ "$OLD_URLS" -gt "$NEW_URLS" ]; then
          echo "âŒ WARNING: Some URLs were lost! Manual URLs may be affected."
        else
          echo "âœ… URL count is safe"
        fi
        
        # AUTO-UPDATED à¦•à¦®à§‡à¦¨à§à¦Ÿ à¦—à§à¦²à§‹ à¦¦à§‡à¦–à¦¾à¦¨
        AUTO_COUNT=$(grep -c "#AUTO-UPDATED" sirometv_updated.m3u 2>/dev/null || echo "0")
        echo "ğŸ”„ Auto-updated channels: $AUTO_COUNT"
        
        # à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦šà§à¦¯à¦¾à¦¨à§‡à¦²à¦—à§à¦²à§‹ à¦¦à§‡à¦–à¦¾à¦¨
        echo "ğŸ” Sample updated channels structure:"
        for channel in "Mohona TV" "Bangla TV" "SATV"; do
          echo "--- $channel ---"
          grep -A 10 "$channel" sirometv_updated.m3u | head -11 || echo "Not found"
          echo ""
        done
        
        mv sirometv_updated.m3u sirometv.m3u
        
    - name: Commit and push changes
      run: |
        echo "ğŸ’¾ Saving changes to repository..."
        
        # à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶à§‡à¦° à¦¸à¦®à§Ÿ à¦¸à¦‚à¦—à§à¦°à¦¹
        COMMIT_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %H:%M:%S Bangladesh Time')
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add sirometv.m3u
        
        if git diff --staged --quiet; then
          echo "âœ… No changes detected - playlist is up to date"
        else
          git commit -m "ğŸ”„ Auto Update Channels from Ayna - $COMMIT_TIME"
          git push
          echo "ğŸ‰ Successfully updated channels from Ayna playlist!"
          echo "ğŸ”’ Manual URLs are completely safe!"
          echo "ğŸ” Only exact matches updated"
        fi
        
    - name: Cleanup
      run: |
        rm -f main_playlist.m3u source_playlist.m3u
        echo "âœ… Cleanup completed!"
        echo "ğŸ Ayna to Listing workflow finished successfully!"
