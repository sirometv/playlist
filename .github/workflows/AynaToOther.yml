name: Ayna To Other

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Download playlists
      run: |
        echo "ğŸ“¥ Downloading playlists..."
        curl -s -L -o main_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/sirometv.m3u"
        curl -s -L -o source_playlist.m3u "https://raw.githubusercontent.com/sirometv/playlist/main/Ayna.m3u"
        
        for file in main_playlist.m3u source_playlist.m3u; do
          if [ ! -f "$file" ] || [ ! -s "$file" ]; then
            echo "âŒ ERROR: $file download failed!"
            exit 1
          fi
          LINES=$(wc -l < "$file")
          echo "âœ… $file downloaded - $LINES lines"
        done
        
    - name: Update Channels
      run: |
        echo "ğŸ”„ Updating Channels..."
        
        python3 - << 'EOF'
        import re
        from datetime import datetime
        import pytz
        import os
        
        # à¦šà§à¦¯à¦¾à¦¨à§‡à¦² à¦®à§à¦¯à¦¾à¦ªà¦¿à¦‚ - à¦†à¦ªà¦¨à¦¾à¦° à¦ªà§à¦°à¦¥à¦® à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿà§‡à¦° à¦¨à¦¾à¦® : à¦¸à§‡à¦•à§‡à¦¨à§à¦¡ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿà§‡ à¦–à§à¦à¦œà¦¬à§‡ à¦à¦®à¦¨ exact keywords
        CHANNEL_MAPPING = {
            "T Sports": ["T Sports HD", "A Sports", "PTV Sports"],
            "BTV National": ["BTV NATIONAL HD", "BTV World"],
            "BTV CTG": ["BTV CTG"],
            "Channel 9": ["Channel 9"],
            "Channel I": ["Channel I"],
            "Bangla Vision": ["Bangla Vision"],
            "News 24": ["News 24 BD"], 
            "Boishakhi TV": ["Boishakhi TV"],
            "Bijoy TV": ["Bijoy TV"],
            "ATN Bangla": ["ATN Bangla"],
            "ATN-Bangla News": ["ATN News"],
            "DBC News": ["DBC News"],
            "Independent TV": ["Independent TV"],
            "Bangla TV": ["Bangla TV"],
            "Desh TV": ["Desh TV"],
            "RTV": ["RTV"],
            "My TV": ["My TV"],
        }
        
        def get_bangladesh_time():
            """à¦¬à¦¾à¦‚à¦²à¦¾à¦¦à§‡à¦¶à§‡à¦° à¦¬à¦°à§à¦¤à¦®à¦¾à¦¨ à¦¸à¦®à¦¯à¦¼ à¦°à¦¿à¦Ÿà¦¾à¦°à§à¦¨ à¦•à¦°à§‡"""
            bangladesh_tz = pytz.timezone('Asia/Dhaka')
            now = datetime.now(bangladesh_tz)
            return now.strftime("%Y-%m-%d %I:%M:%S%p BD Time")
        
        def find_channel_urls(source_file, keywords):
            """à¦¸à§‹à¦°à§à¦¸ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿ à¦¥à§‡à¦•à§‡ à¦šà§à¦¯à¦¾à¦¨à§‡à¦² URLs à¦–à§à¦à¦œà§‡ à¦¬à§‡à¦° à¦•à¦°à§‡ (exact match)"""
            with open(source_file, 'r', encoding='utf-8') as f:
                content = f.read()
            
            urls = []
            
            # à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ keyword à¦à¦° à¦œà¦¨à§à¦¯ exact match à¦–à§à¦à¦œà§à¦¨
            for keyword in keywords:
                # Exact match à¦à¦° à¦œà¦¨à§à¦¯ pattern - à¦¶à§à¦§à§à¦®à¦¾à¦¤à§à¦° à¦¸à¦®à§à¦ªà§‚à¦°à§à¦£ à¦¨à¦¾à¦® match à¦•à¦°à¦¬à§‡
                pattern = r'#EXTINF:[^\n]*,\s*{}\s*(?:\n|$)[^\n]*\n(http[^\s\n]+)'.format(re.escape(keyword))
                matches = re.findall(pattern, content, re.IGNORECASE | re.MULTILINE)
                
                if matches:
                    for url in matches:
                        urls.append(url.strip())
                        print(f"âœ… Found exact match for '{keyword}': {url}")
                else:
                    print(f"âŒ No exact match found for keyword: '{keyword}'")
            
            return urls
        
        def update_channel_in_playlist(main_content, channel_name, new_urls):
            """à¦®à§‡à¦‡à¦¨ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿà§‡ à¦¨à¦¿à¦°à§à¦¦à¦¿à¦·à§à¦Ÿ à¦šà§à¦¯à¦¾à¦¨à§‡à¦² à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à§‡"""
            timestamp = get_bangladesh_time()
            is_manual_run = os.environ.get('GITHUB_EVENT_NAME') == 'workflow_dispatch'
            
            print(f"ğŸ”„ Processing channel: {channel_name}")
            print(f"   URLs to add: {len(new_urls)}")
            print(f"   Run type: {'Manual' if is_manual_run else 'Scheduled'}")
            
            # à¦šà§à¦¯à¦¾à¦¨à§‡à¦² à¦¬à§à¦²à¦• à¦–à§à¦à¦œà§‡ à¦¬à§‡à¦° à¦•à¦°à¦¾à¦° pattern
            channel_pattern = r'(#EXTINF:-1[^\n]*{}[^\n]*\n)(.*?)(?=#EXTINF|\Z)'.format(re.escape(channel_name))
            match = re.search(channel_pattern, main_content, re.IGNORECASE | re.DOTALL)
            
            if not match:
                print(f"âŒ Channel '{channel_name}' not found in main playlist")
                return main_content
            
            extinf_line = match.group(1)
            existing_content = match.group(2)
            full_block = match.group(0)
            
            # à¦¨à¦¤à§à¦¨ URLs à¦¥à§‡à¦•à§‡ AUTO-UPDATED section à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨
            auto_urls_text = "".join([f"{url}\n" for url in new_urls])
            
            if len(new_urls) > 1:
                auto_header = f"#AUTO-UPDATED - Multiple Channel - {timestamp} ğŸ”„ğŸ”„\n"
            else:
                auto_header = f"#AUTO-UPDATED - Channel - {timestamp} ğŸ”„\n"
            
            auto_section = auto_header + auto_urls_text
            
            # Check if AUTO-UPDATED section already exists
            auto_updated_pattern = r'(#AUTO-UPDATED[^\n]*\n)((?:http[^\n]*\n)*)'
            auto_match = re.search(auto_updated_pattern, existing_content)
            
            if auto_match:
                # AUTO-UPDATED section exists - scheduled update
                if is_manual_run:
                    # Manual run: à¦¨à¦¤à§à¦¨ section à¦¯à§‹à¦— à¦•à¦°à§à¦¨ existing AUTO-UPDATED section à¦à¦° à¦‰à¦ªà¦°à§‡
                    updated_content = auto_section + existing_content
                    print(f"âœ… Manual run: Added new AUTO-UPDATED section with {len(new_urls)} links")
                else:
                    # Scheduled run: à¦¶à§à¦§à§ existing AUTO-UPDATED URLs replace à¦•à¦°à§à¦¨
                    old_auto_section = auto_match.group(0)
                    new_auto_section = auto_section
                    updated_content = existing_content.replace(old_auto_section, new_auto_section)
                    print(f"âœ… Scheduled run: Replaced AUTO-UPDATED URLs with {len(new_urls)} links")
            else:
                # No AUTO-UPDATED section exists - manual run
                updated_content = auto_section + existing_content
                print(f"âœ… Manual run: Added AUTO-UPDATED section with {len(new_urls)} links")
            
            # à¦¨à¦¤à§à¦¨ à¦šà§à¦¯à¦¾à¦¨à§‡à¦² à¦¬à§à¦²à¦• à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨
            new_channel_block = extinf_line + updated_content
            
            # à¦ªà§à¦°à§‹ à¦•à¦¨à§à¦Ÿà§‡à¦¨à§à¦Ÿà§‡ replace à¦•à¦°à§à¦¨
            updated_main_content = main_content.replace(full_block, new_channel_block)
            
            return updated_main_content
        
        # à¦®à§‡à¦‡à¦¨ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿ à¦²à§‹à¦¡ à¦•à¦°à§à¦¨
        with open('main_playlist.m3u', 'r', encoding='utf-8') as f:
            main_content = f.read()
        
        updated_content = main_content
        total_channels_updated = 0
        total_links_added = 0
        
        # à¦ªà§à¦°à¦¤à¦¿à¦Ÿà¦¿ à¦šà§à¦¯à¦¾à¦¨à§‡à¦²à§‡à¦° à¦œà¦¨à§à¦¯ à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à§à¦¨
        for main_channel, search_keywords in CHANNEL_MAPPING.items():
            print(f"\nğŸ” Processing: {main_channel}")
            print(f"   Searching for exact matches: {search_keywords}")
            
            # à¦¸à§‹à¦°à§à¦¸ à¦ªà§à¦²à§‡à¦²à¦¿à¦¸à§à¦Ÿ à¦¥à§‡à¦•à§‡ URLs à¦–à§à¦à¦œà§‡ à¦¬à§‡à¦° à¦•à¦°à§à¦¨
            channel_urls = find_channel_urls('source_playlist.m3u', search_keywords)
            
            if channel_urls:
                updated_content = update_channel_in_playlist(updated_content, main_channel, channel_urls)
                total_channels_updated += 1
                total_links_added += len(channel_urls)
            else:
                print(f"âš ï¸ Skipping {main_channel} - no URLs found")
        
        # à¦†à¦ªà¦¡à§‡à¦Ÿ à¦•à¦°à¦¾ à¦•à¦¨à§à¦Ÿà§‡à¦¨à§à¦Ÿ à¦¸à§‡à¦­ à¦•à¦°à§à¦¨
        with open('sirometv_updated.m3u', 'w', encoding='utf-8') as f:
            f.write(updated_content)
        
        print(f"\nğŸ‰ Update Summary:")
        print(f"   Total channels processed: {len(CHANNEL_MAPPING)}")
        print(f"   Total channels updated: {total_channels_updated}")
        print(f"   Total links added/updated: {total_links_added}")
        
        EOF
        
    - name: Verify and replace playlist
      run: |
        echo "ğŸ” Verifying updated playlist..."
        
        if [ ! -f "sirometv_updated.m3u" ] || [ ! -s "sirometv_updated.m3u" ]; then
          echo "âŒ ERROR: Updated playlist is missing or empty!"
          exit 1
        fi
        
        # à¦®à§‚à¦² playlist backup à¦•à¦°à§à¦¨
        cp sirometv.m3u sirometv_backup.m3u 2>/dev/null || true
        
        mv sirometv_updated.m3u sirometv.m3u
        
        echo "ğŸ” Updated channels preview:"
        grep -B1 -A15 "AUTO-UPDATED" sirometv.m3u | head -50 || echo "No AUTO-UPDATED sections found"
        
    - name: Commit and push changes
      run: |
        echo "ğŸ’¾ Saving changes to repository..."
        
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add sirometv.m3u
        
        if git diff --staged --quiet; then
          echo "âœ… No changes detected - playlist is up to date"
        else
          BANGLADESH_TIME=$(TZ='Asia/Dhaka' date +'%Y-%m-%d %I:%M:%S%p BD Time')
          
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            git commit -m "ğŸ”„ Manual Update: Channel Links - $BANGLADESH_TIME"
          else
            git commit -m "ğŸ”„ Scheduled Update: Channel Links - $BANGLADESH_TIME"
          fi
          git push
          echo "ğŸ‰ Successfully updated channel links!"
        fi
        
    - name: Cleanup
      run: |
        rm -f main_playlist.m3u source_playlist.m3u sirometv_backup.m3u
        echo "âœ… Cleanup completed!"
