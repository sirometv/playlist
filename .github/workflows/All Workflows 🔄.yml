name: All Workflows ЁЯФД

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/All Workflows ЁЯФД.yml'

permissions:
  contents: write

jobs:
  update-all-workflows:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Download and Update Workflow Files
        run: |
          #!/bin/bash
          
          echo "ЁЯФД Starting automated update of all workflow files..."
          echo "================================================"
          
          # ржУрзЯрж╛рж░рзНржХржлрзНрж▓рзЛ URL ржПржмржВ ржлрж╛ржЗрж▓ржирзЗржо ржорзНржпрж╛ржкрж┐ржВ
          declare -A workflow_map=(
            ["Combined Playlist Skipper ЁЯЯв.yml"]="https://raw.githubusercontent.com/sirometv/playlist/refs/heads/main/.github/workflows/Combined%20Playlist%20Skipper%F0%9F%9F%A2.yml"
            ["LiveFancodeЁЯФПЁЯФП.yml"]="https://raw.githubusercontent.com/sirometv/playlist/refs/heads/main/.github/workflows/LiveFancode%F0%9F%94%84%F0%9F%94%84.yml"
            ["Ayna TV ЁЯФП.yml"]="https://raw.githubusercontent.com/sirometv/playlist/refs/heads/main/.github/workflows/Ayna%20TV%20%F0%9F%94%84.yml"
            ["CricHD ЁЯТа.yml"]="https://raw.githubusercontent.com/sirometv/playlist/refs/heads/main/.github/workflows/CricHD%20%F0%9F%92%A0.yml"
            ["CRICHD JSON ЁЯЯд.yml"]="https://raw.githubusercontent.com/sirometv/playlist/refs/heads/main/.github/workflows/CRICHD%20JSON%20%F0%9F%9F%A4.yml"
          )
          
          # ржирждрзБржи ржУрзЯрж╛рж░рзНржХржлрзНрж▓рзЛ ржпрзЛржЧ ржХрж░рж╛рж░ ржЬржирзНржп ржПржЗ рж▓рж╛ржЗржирзЗрж░ ржирж┐ржЪрзЗ ржпрзЛржЧ ржХрж░рзБржи
          # ["Your New Workflow.yml"]="YOUR_WORKFLOW_URL_HERE"
          
          total_files=${#workflow_map[@]}
          updated_count=0
          
          echo "ЁЯУК Total workflows to update: $total_files"
          echo ""
          
          for filename in "${!workflow_map[@]}"; do
            url="${workflow_map[$filename]}"
            
            echo "ЁЯФД Processing: $filename"
            echo "ЁЯУе URL: $url"
            
            # ржлрж╛ржЗрж▓ ржбрж╛ржЙржирж▓рзЛржб ржХрж░рзБржи
            if curl -s -L -o "temp_workflow.yml" "$url"; then
              echo "тЬЕ Successfully downloaded"
              
              # ржорзВрж▓ ржХржирзНржЯрзЗржирзНржЯ ржжрзЗржЦрзБржи (ржбрж┐ржмрж╛ржЧрж┐ржВ)
              echo "ЁЯУД Original content (first 5 lines):"
              head -5 "temp_workflow.yml"
              
              # YML ржкрзНрж░рж╕рзЗрж╕ ржХрж░рж╛рж░ ржЬржирзНржп Python рж╕рзНржХрзНрж░рж┐ржкрзНржЯ
              python3 << EOF
import yaml
import sys
import os

try:
    with open('temp_workflow.yml', 'r', encoding='utf-8') as file:
        content = file.read()
    
    # YML ржкрж╛рж░рзНрж╕ ржХрж░рзБржи
    data = yaml.safe_load(content)
    
    # 'on' рж╕рзЗржХрж╢ржи рждрзИрж░рж┐ ржХрж░рзБржи ржмрж╛ ржЖржкржбрзЗржЯ ржХрж░рзБржи
    if 'on' not in data:
        data['on'] = {}
    
    # рж╢рж┐ржбрж┐ржЙрж▓ рж╕рзЗржЯ ржХрж░рзБржи (ржкрзНрж░рждрж┐ 5 ржорж┐ржирж┐ржЯ)
    if isinstance(data['on'], dict):
        data['on']['schedule'] = [{'cron': '*/5 * * * *'}]
        
        # workflow_dispatch ржпрзЛржЧ ржХрж░рзБржи ржпржжрж┐ ржирж╛ ржерж╛ржХрзЗ
        if 'workflow_dispatch' not in data['on']:
            data['on']['workflow_dispatch'] = {}
    elif isinstance(data['on'], list):
        # ржпржжрж┐ 'on' ржПржХржЯрж┐ рж▓рж┐рж╕рзНржЯ рж╣рзЯ
        if 'schedule' not in data['on']:
            data['on'].append('schedule')
    
    # ржЖржкржбрзЗржЯрзЗржб YML рж╕рзЗржн ржХрж░рзБржи
    updated_content = yaml.dump(data, default_flow_style=False, allow_unicode=True, sort_keys=False)
    
    # ржХржорзЗржирзНржЯ ржпрзЛржЧ ржХрж░рзБржи
    final_content = f"""# ЁЯЪА Auto-updated by 'All Workflows ЁЯФД' workflow
# ЁЯФД Last updated: $(date)
# ЁЯУЕ Scheduled to run every 5 minutes

{updated_content}"""
    
    with open('temp_workflow.yml', 'w', encoding='utf-8') as file:
        file.write(final_content)
    
    print("тЬЕ Successfully updated schedule configuration")
    
except Exception as e:
    print(f"тЭМ Error processing YML: {str(e)}")
    sys.exit(1)
EOF
              
              # ржЖржкржбрзЗржЯрзЗржб ржлрж╛ржЗрж▓ рж╕рзЗржн ржХрж░рзБржи
              mkdir -p .github/workflows
              mv "temp_workflow.yml" ".github/workflows/$filename"
              
              echo "ЁЯТ╛ Saved as: .github/workflows/$filename"
              ((updated_count++))
              
            else
              echo "тЭМ Failed to download: $filename"
            fi
            
            echo "---"
          done
          
          echo "================================================"
          echo "ЁЯУИ Update Summary:"
          echo "тЬЕ Successfully updated: $updated_count/$total_files files"
          echo "ЁЯХТ Next auto-update in 5 minutes"
          echo "================================================"

      - name: Verify Updated Files
        run: |
          echo "ЁЯУБ Listing all workflow files:"
          ls -la .github/workflows/
          
          echo ""
          echo "ЁЯФН Checking schedule configuration in each file:"
          echo ""
          
          for file in .github/workflows/*.yml; do
            if [[ "$file" != *"All Workflows"* ]]; then
              echo "=== $(basename "$file") ==="
              if grep -q "schedule:" "$file"; then
                echo "тЬЕ Schedule: ENABLED (runs every 5 minutes)"
                grep "cron:" "$file"
              else
                echo "тЭМ Schedule: NOT FOUND"
              fi
              
              if grep -q "workflow_dispatch:" "$file"; then
                echo "тЬЕ Manual run: ENABLED"
              else
                echo "тЭМ Manual run: NOT FOUND"
              fi
              echo ""
            fi
          done

      - name: Commit and Push Updates
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # ржкрж░рж┐ржмрж░рзНрждржиржЧрзБрж▓рзЛ ржЪрзЗржХ ржХрж░рзБржи
          echo "ЁЯФН Checking for changes..."
          git status
          
          # ржкрж░рж┐ржмрж░рзНрждржи ржерж╛ржХрж▓рзЗ ржХржорж┐ржЯ ржПржмржВ ржкрзБрж╢ ржХрж░рзБржи
          if [ -n "$(git status --porcelain .github/workflows/)" ]; then
            echo "ЁЯУж Changes detected, committing..."
            git add .github/workflows/
            git commit -m "ЁЯФД Auto-update all workflows via 'All Workflows ЁЯФД' workflow
            
            ЁЯУЕ Scheduled update performed by github-actions[bot]
            ЁЯХТ Next update in 5 minutes
            тЬЕ All workflows now configured to run automatically"
            
            git push origin main
            echo "тЬЕ Successfully pushed updates to repository!"
            
            # ржкрзБрж╢рзЗрж░ ржкрж░ рж▓ржЧ
            echo ""
            echo "ЁЯОп Update completed successfully!"
            echo "ЁЯУК All workflow files are now:"
            echo "   тАв Scheduled to run every 5 minutes"
            echo "   тАв Enabled for manual trigger"
            echo "   тАв Auto-updated by this workflow"
            
          else
            echo "тД╣я╕П No changes detected in workflow files"
            echo "ЁЯУЭ All files are already up-to-date"
          fi

      - name: Send Success Notification
        if: success()
        run: |
          echo "ЁЯОЙ Workflow update process completed!"
          echo ""
          echo "ЁЯУЛ Summary:"
          echo "  тЬЕ All workflows downloaded"
          echo "  тЬЕ Schedules configured (every 5 minutes)"
          echo "  тЬЕ Files saved to .github/workflows/"
          echo "  тЬЕ Changes committed and pushed"
          echo ""
          echo "тП░ Next automatic run: In 5 minutes"
          echo "ЁЯФз Manual run: Available via GitHub Actions UI"

      - name: Handle Failure
        if: failure()
        run: |
          echo "тЭМ Workflow update failed!"
          echo "Please check the logs for errors."
          echo ""
          echo "Possible issues:"
          echo "1. Network connectivity"
          echo "2. Invalid YML syntax in source files"
          echo "3. GitHub token permissions"
