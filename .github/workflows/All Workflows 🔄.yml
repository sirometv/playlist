name:  All Workflows üîÑ

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/sync-workflows.yml'

# Write permission for Git push
permissions:
  contents: write

jobs:
  sync-workflows:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python and dependencies
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install PyYAML
        run: pip install pyyaml

      - name: Download and Update Workflows
        run: |
          #!/bin/bash
          
          # ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø Python ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶™‡ßç‡¶ü
          python3 << 'EOF'
          import urllib.request
          import os
          import yaml
          import json
          from pathlib import Path
          import urllib.parse
          
          # ‡¶ì‡ßü‡¶æ‡¶∞‡ßç‡¶ï‡¶´‡ßç‡¶≤‡ßã URL ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü
          workflow_urls = [
              'https://raw.githubusercontent.com/sirometv/playlist/refs/heads/main/.github/workflows/Combined%20Playlist%20Skipper%F0%9F%9F%A2.yml',
              'https://raw.githubusercontent.com/sirometv/playlist/refs/heads/main/.github/workflows/LiveFancode%F0%9F%94%84%F0%9F%94%84.yml',
              'https://raw.githubusercontent.com/sirometv/playlist/refs/heads/main/.github/workflows/Ayna%20TV%20%F0%9F%94%84.yml',
              'https://raw.githubusercontent.com/sirometv/playlist/refs/heads/main/.github/workflows/CricHD%20%F0%9F%92%A0.yml',
              'https://raw.githubusercontent.com/sirometv/playlist/refs/heads/main/.github/workflows/CRICHD%20JSON%20%F0%9F%9F%A4.yml',
          ]
          
          for url in workflow_urls:
              try:
                  # ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶®‡¶æ‡¶Æ ‡¶è‡¶ï‡ßç‡¶∏‡¶ü‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                  filename = url.split('/')[-1]
                  filename = urllib.parse.unquote(filename)
                  
                  print(f'üîç Processing: {filename}')
                  
                  # YML ‡¶´‡¶æ‡¶á‡¶≤ ‡¶°‡¶æ‡¶â‡¶®‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                  req = urllib.request.Request(url, headers={'User-Agent': 'Mozilla/5.0'})
                  response = urllib.request.urlopen(req)
                  content = response.read().decode('utf-8')
                  
                  # YAML ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡ßÅ‡¶®
                  workflow_data = yaml.safe_load(content)
                  
                  # ‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶¨‡¶æ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
                  if 'on' in workflow_data:
                      # ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶∞‡ßÅ‡¶® schedule key ‡¶Ü‡¶õ‡ßá
                      if isinstance(workflow_data['on'], dict):
                          if 'schedule' not in workflow_data['on']:
                              workflow_data['on']['schedule'] = [{'cron': '*/5 * * * *'}]
                          else:
                              # ‡¶∂‡¶ø‡¶°‡¶ø‡¶â‡¶≤ ‡¶Ü‡¶™‡¶°‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
                              workflow_data['on']['schedule'] = [{'cron': '*/5 * * * *'}]
                      
                      # workflow_dispatch ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶Ø‡¶¶‡¶ø ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá
                      if 'workflow_dispatch' not in workflow_data['on']:
                          workflow_data['on']['workflow_dispatch'] = {}
                  
                  # ‡¶Ü‡¶™‡¶°‡ßá‡¶ü‡ßá‡¶° YAML ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
                  updated_content = yaml.dump(workflow_data, default_flow_style=False, allow_unicode=True, sort_keys=False)
                  
                  # ‡¶´‡¶æ‡¶á‡¶≤ ‡¶∏‡ßá‡¶≠ ‡¶ï‡¶∞‡ßÅ‡¶®
                  workflow_path = Path('.github/workflows') / filename
                  workflow_path.parent.mkdir(parents=True, exist_ok=True)
                  
                  with open(workflow_path, 'w', encoding='utf-8') as f:
                      f.write(f"# Auto-updated by sync-workflows workflow\n{updated_content}")
                      
                  print(f'‚úÖ Updated: {filename}')
                  
              except Exception as e:
                  print(f'‚ùå Error processing {url}: {str(e)}')
                  import traceback
                  traceback.print_exc()
          
          print("üéâ All workflows processed!")
          EOF

      - name: Commit and Push Changes
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶® ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®
          git status
          
          # ‡¶∏‡¶¨ ‡¶´‡¶æ‡¶á‡¶≤ ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßÅ‡¶®
          git add .
          
          # ‡¶ï‡¶Æ‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®
          git commit -m "üîÑ Auto-sync workflows: $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
          
          # ‡¶™‡ßÅ‡¶∂ ‡¶ï‡¶∞‡ßÅ‡¶®
          git push origin main || echo "Nothing to push"
          
          echo "‚úÖ Process completed!"

      - name: Show Updated Files
        run: |
          echo "üìÅ Updated files in .github/workflows/:"
          ls -la .github/workflows/
          echo ""
          echo "üìã File list:"
          ls .github/workflows/
