name: â° Master Workflow Scheduler

on:
  schedule:
    - cron: '*/10 * * * *'  # à¦ªà§à¦°à¦¤à¦¿ à§§à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡
  workflow_dispatch:

jobs:
  update-schedules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: ğŸ› ï¸ Setup environment
        run: |
          echo "Starting schedule update process..."
          echo "Current directory: $(pwd)"
          echo "Workflow files:"
          ls -la .github/workflows/
          
      - name: ğŸ”„ Update ALL workflow schedules
        run: |
          echo "ğŸ”„ Processing workflow files..."
          
          # Process each YAML file
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              
              # Skip scheduler files
              if [[ "$filename" == "master-scheduler.yml" || "$filename" == "run-all.yml" ]]; then
                echo "â­ï¸ Skipping scheduler file: $filename"
                continue
              fi
              
              echo "ğŸ“ Processing: $filename"
              
              # Create backup
              cp "$file" "$file.bak"
              
              # Read file content
              content=$(cat "$file")
              
              # Check if file has schedule
              if echo "$content" | grep -q "schedule:"; then
                # Update existing schedule
                echo "Found existing schedule, updating..."
                
                # Create temp file with sed for in-place editing
                sed -i.bak2 '/cron:/c\    - cron: '\''*/10 * * * *'\''  # à¦ªà§à¦°à¦¤à¦¿ à§§à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡' "$file"
                
                # Also update the schedule: line if needed
                sed -i.bak3 's/schedule:/schedule:/' "$file"
                
                echo "âœ… Updated existing schedule in: $filename"
              else
                # Add new schedule section
                echo "No schedule found, adding new one..."
                
                # Check if file has 'on:' section
                if echo "$content" | grep -q "^on:"; then
                  # Add schedule to existing 'on:'
                  awk '/^on:/ {print $0; print "  schedule:"; print "    - cron: '\''*/10 * * * *'\''  # à¦ªà§à¦°à¦¤à¦¿ à§§à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡"; next} 1' "$file" > "$file.tmp"
                else
                  # Add complete 'on:' section at top
                  echo "on:
  schedule:
    - cron: '*/10 * * * *'  # à¦ªà§à¦°à¦¤à¦¿ à§§à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡
" > "$file.tmp"
                  cat "$file" >> "$file.tmp"
                fi
                
                mv "$file.tmp" "$file"
                echo "âœ… Added new schedule to: $filename"
              fi
              
              # Clean up backups
              rm -f "$file.bak" "$file.bak2" "$file.bak3" 2>/dev/null || true
            fi
          done
          
          echo ""
          echo "========================================"
          echo "ğŸ‰ PROCESSING COMPLETE!"
          echo "========================================"
          
      - name: ğŸ“‹ Show changes made
        run: |
          echo "ğŸ“Š Changes made to workflow files:"
          git diff --name-only || echo "No changes yet"
          
      - name: ğŸ’¾ Commit and push updates
        run: |
          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all workflow files
          git add .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null || true
          
          # Check for changes
          if ! git diff --cached --quiet; then
            echo "ğŸš€ Changes detected! Committing..."
            git commit -m "ğŸ”„ Updated all workflow schedules to run every 10 minutes [Automated]"
            git push origin main
            echo "âœ… Changes pushed successfully!"
            
            echo ""
            echo "========================================"
            echo "ğŸ“… ALL WORKFLOWS UPDATED!"
            echo "========================================"
            echo "âœ… Schedule: Every 10 minutes"
            echo "âœ… Next run: In 10 minutes"
            echo "âœ… All workflows will now auto-update"
          else
            echo "ğŸ“­ No changes needed - schedules already set to 10 minutes"
          fi
          
      - name: ğŸ“ˆ Final Report
        run: |
          echo ""
          echo "========================================"
          echo "        âœ… MASTER SCHEDULER COMPLETE     "
          echo "========================================"
          echo ""
          echo "ğŸ¯ Task: Update all workflow schedules"
          echo "â° New Schedule: Every 10 minutes"
          echo "ğŸ”„ Execution: Fully automated"
          echo "ğŸ“Š Status: All workflows synchronized"
          echo ""
          echo "Next steps:"
          echo "1. Check each workflow's schedule"
          echo "2. Monitor Actions tab for runs"
          echo "3. Enjoy automated updates!"
