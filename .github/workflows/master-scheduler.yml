name: Master Scheduler ğŸ”„

on:
  schedule:
    - cron: '*/10 * * * *'  # à¦¨à¦¿à¦œà§‡ à¦ªà§à¦°à¦¤à¦¿ à§§à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡ à¦°à¦¾à¦¨ à¦¹à¦¬à§‡
  workflow_dispatch:  # à¦®à§à¦¯à¦¾à¦¨à§à¦¯à¦¼à¦¾à¦²à¦¿ à¦šà¦¾à¦²à¦¾à¦¨à§‹ à¦¯à¦¾à¦¬à§‡

jobs:
  update-all-schedules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update schedule in ALL workflow files
        run: |
          cd .github/workflows
          
          echo "ğŸ”„ Updating schedule in all workflow files..."
          echo "Target: Run every 10 minutes"
          echo ""
          
          # à¦¨à¦¿à¦œà§‡à¦•à§‡ à¦¬à¦¾à¦¦ à¦¦à¦¿à¦¨
          CURRENT_FILE="master-scheduler.yml"
          
          # à¦¸à¦¬ YML à¦«à¦¾à¦‡à¦² à¦²à§à¦ª à¦•à¦°à§à¦¨
          for file in *.yml; do
            # à¦¨à¦¿à¦œà§‡à¦•à§‡ à¦¬à¦¾à¦¦ à¦¦à¦¿à¦¨
            if [ "$file" = "$CURRENT_FILE" ] || [ "$file" = "debug-workflows.yml" ] || [ "$file" = "update-all-workflows.yml" ]; then
              echo "â­ï¸ Skipping: $file"
              continue
            fi
            
            echo "ğŸ“ Processing: $file"
            
            # Backup à¦•à¦°à§à¦¨
            cp "$file" "${file}.backup"
            
            # 1. à¦¬à¦¿à¦¦à§à¦¯à¦®à¦¾à¦¨ schedule à¦¸à¦°à¦¾à¦¨
            sed -i '/schedule:/,/cron:/d' "$file" 2>/dev/null || true
            sed -i '/^[[:space:]]*\- cron:/d' "$file" 2>/dev/null || true
            
            # 2. à¦¨à¦¤à§à¦¨ schedule à¦¯à§‹à¦— à¦•à¦°à§à¦¨ (10 à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡)
            if grep -q "^on:" "$file"; then
              # Case: 'on:' à¦¶à§à¦°à§à¦¤à§‡ à¦†à¦›à§‡
              echo "  âœ“ Adding schedule to existing 'on:' section"
              sed -i '/^on:/a\  schedule:\n    - cron: "*/10 * * * *"' "$file"
            elif grep -q "^  on:" "$file"; then
              # Case: indented 'on:'
              echo "  âœ“ Adding schedule to indented 'on:' section"
              sed -i '/^  on:/a\    schedule:\n      - cron: "*/10 * * * *"' "$file"
            else
              # Case: 'on:' à¦¨à§‡à¦‡
              echo "  âš ï¸ No 'on:' found, creating new one"
              
              # à¦«à¦¾à¦‡à¦²à§‡à¦° à¦¶à§à¦°à§à¦¤à§‡ on section à¦¯à§‹à¦— à¦•à¦°à§à¦¨
              TEMP_FILE=$(mktemp)
              echo "on:" > "$TEMP_FILE"
              echo "  schedule:" >> "$TEMP_FILE"
              echo "    - cron: \"*/10 * * * *\"" >> "$TEMP_FILE"
              echo "  workflow_dispatch:" >> "$TEMP_FILE"
              echo "" >> "$TEMP_FILE"
              tail -n +2 "$file" >> "$TEMP_FILE" 2>/dev/null || cat "$file" >> "$TEMP_FILE"
              mv "$TEMP_FILE" "$file"
            fi
            
            echo "  âœ… Updated: $file (now runs every 10 minutes)"
            echo ""
          done
      
      - name: Verify changes
        run: |
          echo "ğŸ” Verifying schedule updates..."
          echo ""
          
          cd .github/workflows
          
          for file in *.yml; do
            if [ "$file" != "master-scheduler.yml" ] && [ "$file" != "debug-workflows.yml" ] && [ "$file" != "update-all-workflows.yml" ]; then
              echo "ğŸ“„ $file:"
              if grep -q "cron:" "$file"; then
                grep "cron:" "$file"
              else
                echo "  âŒ No schedule found!"
              fi
              echo ""
            fi
          done
      
      - name: Set safe directory for Git
        run: |
          # Git safe directory set à¦•à¦°à§à¦¨
          git config --global --add safe.directory /github/workspace
          git config --global --add safe.directory /home/runner/work/playlist/playlist
      
      - name: Commit changes
        run: |
          echo "ğŸš€ Preparing to commit changes..."
          
          # Git configuration
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Changes à¦¦à§‡à¦–à¦¾à¦¨
          echo "ğŸ“‹ Changes made:"
          git status --porcelain .github/workflows/
          
          # à¦¶à§à¦§à§ workflow à¦«à¦¾à¦‡à¦²à¦—à§à¦²à§‹ add à¦•à¦°à§à¦¨
          git add .github/workflows/*.yml
          
          # Changes check
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit (schedules already up to date)"
          else
            echo "ğŸ“¦ Changes detected, committing..."
            git commit -m "ğŸ”„ Master Scheduler: Updated all workflows to run every 10 minutes [auto]"
            echo "âœ… Changes committed locally"
          fi
      
      - name: Push changes (with retry)
        run: |
          echo "ğŸš€ Attempting to push changes..."
          
          # Push with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Attempt $(($RETRY_COUNT + 1)) of $MAX_RETRIES..."
            
            if git push origin HEAD; then
              echo "ğŸ‰ Success! Changes pushed to repository"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "âŒ Push failed (attempt $RETRY_COUNT)"
              
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "â³ Waiting 5 seconds before retry..."
                sleep 5
              else
                echo "âš ï¸ Max retries reached. Changes are committed locally but not pushed."
                echo "You may need to manually push or check repository permissions."
              fi
            fi
          done
      
      - name: Cleanup backups
        run: |
          cd .github/workflows 2>/dev/null || true
          rm -f *.backup 2>/dev/null || true
          echo "ğŸ§¹ Cleanup completed"
      
      - name: Final success report
        if: success()
        run: |
          echo ""
          echo "========================================"
          echo "        ğŸ‰ SUCCESS REPORT               "
          echo "========================================"
          echo ""
          echo "âœ… Master Scheduler completed successfully!"
          echo ""
          echo "ğŸ“Š SUMMARY:"
          echo "â€¢ All workflows updated to run every 10 minutes"
          echo "â€¢ Schedule: */10 * * * *"
          echo "â€¢ Next auto-run: In 10 minutes"
          echo ""
          echo "ğŸ¯ Your workflows will now automatically run:"
          echo "   - Every 10 minutes (auto-scheduled)"
          echo "   - Can be manually triggered anytime"
          echo ""
          echo "ğŸ” Master scheduler will auto-update every 10 minutes"
          echo "   to ensure all workflows stay on schedule"
