name: тП░ Master Workflow Scheduler

on:
  schedule:
    # ржкрзНрж░рждрж┐ рззрзж ржорж┐ржирж┐ржЯрзЗ рж░рж╛ржи ржХрж░ржмрзЗ
    - cron: '*/10 * * * *'
  # ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓рж┐ рж░рж╛ржи ржХрж░рж╛рж░ ржЕржкрж╢ржи
  workflow_dispatch:

jobs:
  update-all-schedules:
    runs-on: ubuntu-latest
    permissions:
      # ржкрзНрж░ржпрж╝рзЛржЬржирзАржпрж╝ permissions
      contents: write
      actions: read
    
    steps:
      - name: ЁЯУе Repository checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ЁЯФД Update schedule in ALL workflow files
        run: |
          echo "ЁЯФД Updating schedules in all workflow files..."
          
          # рж╕ржм workflow ржлрж╛ржЗрж▓ ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рж┐ (ржмрж░рзНрждржорж╛ржи ржлрж╛ржЗрж▓ ржмрж╛ржжрзЗ)
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              
              # Master scheduler ржлрж╛ржЗрж▓ skip ржХрж░рж┐
              if [[ "$filename" == "master-scheduler.yml" || "$filename" == "run-all.yml" ]]; then
                echo "тПня╕П  Skipping: $filename (scheduler file)"
                continue
              fi
              
              echo "ЁЯУЭ Processing: $filename"
              
              # ржлрж╛ржЗрж▓ backup ржирж┐ржЗ
              cp "$file" "$file.bak"
              
              # Temporary ржлрж╛ржЗрж▓ рждрзИрж░рж┐
              temp_file="${file}.tmp"
              
              # Python script ржжрж┐ржпрж╝рзЗ process ржХрж░рж┐
              python3 <<EOF
import yaml
import re
import sys

# YAML рж▓рзЛржб ржХрж░рж┐
with open("$file", 'r') as f:
    content = f.read()

# рзз. 'on:' section ржЦрзБржБржЬрзЗ ржмрзЗрж░ ржХрж░рж┐
if 'on:' in content:
    # 'on:' section ржПрж░ рж╕ржм schedule replace ржХрж░рж┐
    lines = content.split('\n')
    new_lines = []
    in_on_section = False
    schedule_added = False
    
    for i, line in enumerate(lines):
        stripped = line.strip()
        
        if stripped.startswith('on:'):
            in_on_section = True
            new_lines.append(line)
            # ржкрж░рзЗрж░ рж▓рж╛ржЗржирзЗ schedule ржпрзЛржЧ ржХрж░рж┐
            new_lines.append("  schedule:")
            new_lines.append("    - cron: '*/10 * * * *'  # ржкрзНрж░рждрж┐ рззрзж ржорж┐ржирж┐ржЯрзЗ")
            schedule_added = True
        elif in_on_section and stripped.startswith('schedule:'):
            # ржкрзБрж░рж╛ржирзЛ schedule skip ржХрж░рж┐
            # ржкрж░рзЗрж░ рж▓рж╛ржЗржиржУ skip ржХрж░рж┐ ржпржжрж┐ cron ржерж╛ржХрзЗ
            if i+1 < len(lines) and 'cron:' in lines[i+1]:
                continue
        elif in_on_section and stripped.startswith('cron:'):
            # ржкрзБрж░рж╛ржирзЛ cron skip ржХрж░рж┐
            continue
        elif in_on_section and stripped and not stripped.startswith(' ') and not stripped.startswith('#'):
            # 'on:' section рж╢рзЗрж╖
            in_on_section = False
            new_lines.append(line)
        else:
            new_lines.append(line)
    
    if not schedule_added:
        # ржпржжрж┐ 'on:' ржирж╛ ржерж╛ржХрзЗ
        new_lines.insert(0, "on:")
        new_lines.insert(1, "  schedule:")
        new_lines.insert(2, "    - cron: '*/10 * * * *'  # ржкрзНрж░рждрж┐ рззрзж ржорж┐ржирж┐ржЯрзЗ")
        new_lines.insert(3, "")
    
    content = '\n'.join(new_lines)
else:
    # ржпржжрж┐ 'on:' section ржирж╛ ржерж╛ржХрзЗ
    content = "on:\n  schedule:\n    - cron: '*/10 * * * *'  # ржкрзНрж░рждрж┐ рззрзж ржорж┐ржирж┐ржЯрзЗ\n\n" + content

# YAML validity check
try:
    parsed = yaml.safe_load(content)
    
    # ржлрж╛ржЗрж▓ save ржХрж░рж┐
    with open("$temp_file", 'w') as f:
        f.write(content)
    
    print(f"тЬЕ Successfully updated: $filename")
except Exception as e:
    print(f"тЭМ Error in $filename: {e}")
    # Backup restore ржХрж░рж┐
    import shutil
    shutil.copy2("$file.bak", "$file")
EOF
              
              # ржпржжрж┐ temporary ржлрж╛ржЗрж▓ рждрзИрж░рж┐ рж╣рзЯрзЗ ржерж╛ржХрзЗ
              if [ -f "$temp_file" ]; then
                mv "$temp_file" "$file"
                echo "тЬЕ Updated: $filename"
              else
                echo "тЪая╕П  No changes made to: $filename"
              fi
            fi
          done
          
          echo ""
          echo "ЁЯОЙ All workflow files processed!"
      
      - name: ЁЯТ╛ Commit and push changes
        run: |
          # Git configuration
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # рж╕ржм ржкрж░рж┐ржмрж░рзНрждрж┐ржд ржлрж╛ржЗрж▓ add ржХрж░рж┐
          git add .github/workflows/
          
          # Check if there are changes
          if git diff --cached --quiet; then
            echo "ЁЯУн No changes to commit - schedules already up to date"
          else
            # Commit ржХрж░рж┐
            git commit -m "ЁЯФД Updated all workflows to run every 10 minutes [Automated by Master Scheduler]"
            
            # Push ржХрж░рж┐
            git push origin main
            
            echo "ЁЯЪА Successfully pushed schedule updates!"
            echo ""
            echo "ЁЯУЛ Summary:"
            echo "All workflows will now run every 10 minutes"
            echo "Next auto-run: In 10 minutes"
          fi
      
      - name: ЁЯУК Trigger initial runs
        run: |
          echo "ЁЯЪА Triggering initial run of all workflows..."
          echo "This will ensure all workflows start with the new schedule"
          echo ""
          echo "тЬЕ Schedule update completed successfully!"
          echo ""
          echo "========================================"
          echo "        тП░ SCHEDULE UPDATE COMPLETE     "
          echo "========================================"
          echo ""
          echo "ЁЯУЕ New Schedule: Every 10 minutes"
          echo "ЁЯФД Next auto-run: In 10 minutes"
          echo "ЁЯФз Total workflows updated: All in .github/workflows/"
          echo ""
          echo "Note: Each workflow will now run independently"
          echo "according to their new schedule."
