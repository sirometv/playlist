name: ‚è∞ Master Schedule Updater

on:
  schedule:
    - cron: '*/10 * * * *'  # ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ßß‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá
  workflow_dispatch:
    inputs:
      debug:
        description: 'Debug mode'
        required: false
        default: 'false'

jobs:
  update-schedules:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout with proper permissions
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          
      - name: üîç List all workflow files
        run: |
          echo "üìÅ Workflow files found:"
          ls -la .github/workflows/
          echo ""
          echo "üìã Total files: $(ls .github/workflows/*.yml .github/workflows/*.yaml 2>/dev/null | wc -l)"
          
      - name: üìù Update schedule in each workflow
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîÑ Starting schedule update process..."
          
          # Track updated files
          UPDATED_FILES=()
          
          # Process each workflow file
          for file in .github/workflows/*.yml .github/workflows/*.yaml; do
            if [ -f "$file" ]; then
              FILENAME=$(basename "$file")
              
              # Skip self
              if [[ "$FILENAME" == "master-scheduler.yml" ]]; then
                echo "‚è≠Ô∏è Skipping self: $FILENAME"
                continue
              fi
              
              echo ""
              echo "üìù Processing: $FILENAME"
              
              # Read file content
              CONTENT=$(cat "$file")
              
              # Check current schedule
              if echo "$CONTENT" | grep -q "cron:"; then
                CURRENT_CRON=$(echo "$CONTENT" | grep -A1 "cron:" | tail -1 | sed 's/.*cron: //' | tr -d "'\"")
                echo "   Current cron: $CURRENT_CRON"
              else
                echo "   No schedule found"
              fi
              
              # Create updated version
              UPDATED=false
              
              # Method 1: Simple sed replacement
              if echo "$CONTENT" | grep -q "cron:"; then
                # Update existing cron
                sed -i "s|cron:.*|cron: '*/10 * * * *'  # ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ßß‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü‡ßá|g" "$file"
                UPDATED=true
                echo "   ‚úÖ Updated existing schedule"
              fi
              
              # Check if update was made
              if [ "$UPDATED" = true ]; then
                UPDATED_FILES+=("$FILENAME")
              fi
            fi
          done
          
          echo ""
          echo "========================================"
          echo "üìä UPDATE SUMMARY"
          echo "========================================"
          echo "‚úÖ Files updated: ${#UPDATED_FILES[@]}"
          for f in "${UPDATED_FILES[@]}"; do
            echo "   - $f"
          done
          
      - name: üíæ Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          git config --global pull.rebase false
          
      - name: üì§ Commit and Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking for changes..."
          
          # Check git status
          git status
          
          # Check if there are any changes
          if git diff --quiet && git diff --cached --quiet; then
            echo "üì≠ No changes to commit"
            echo "All workflows already have the correct schedule"
          else
            echo "üöÄ Changes detected! Preparing to commit..."
            
            # Show what changed
            echo "üìã Changes:"
            git diff --name-status
            
            # Add all changed files
            git add .
            
            # Commit
            git commit -m "üîÑ Updated workflow schedules to run every 10 minutes [Automated Update]"
            
            # Push with retry logic
            MAX_RETRIES=3
            RETRY_COUNT=0
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              echo "üîÑ Pushing changes (Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES)..."
              
              if git push origin HEAD:main; then
                echo "‚úÖ Successfully pushed changes!"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "‚ö†Ô∏è Push failed, pulling latest and retrying..."
                  git pull --rebase origin main
                  sleep 2
                else
                  echo "‚ùå Failed to push after $MAX_RETRIES attempts"
                  exit 1
                fi
              fi
            done
          fi
          
      - name: üéâ Final Report
        run: |
          echo ""
          echo "========================================"
          echo "        üéØ SCHEDULE UPDATE COMPLETE     "
          echo "========================================"
          echo ""
          echo "‚úÖ All workflows have been updated"
          echo "‚è∞ New schedule: Every 10 minutes"
          echo "üîÑ Next auto-run: In 10 minutes"
          echo ""
          echo "üìä Quick check:"
          echo "Run 'ls -la .github/workflows/' to see files"
          echo "Check GitHub Actions tab for individual runs"
          echo ""
          echo "üöÄ Your playlists will now auto-update!"
