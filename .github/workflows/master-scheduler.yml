name: Master Scheduler ðŸ”„

on:
  schedule:
    - cron: '*/10 * * * *'  # à¦¨à¦¿à¦œà§‡ à¦ªà§à¦°à¦¤à¦¿ à§§à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡ à¦°à¦¾à¦¨ à¦¹à¦¬à§‡
  workflow_dispatch:  # à¦®à§à¦¯à¦¾à¦¨à§à¦¯à¦¼à¦¾à¦²à¦¿ à¦šà¦¾à¦²à¦¾à¦¨à§‹ à¦¯à¦¾à¦¬à§‡

jobs:
  update-all-schedules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update schedule in ALL workflow files
        run: |
          cd .github/workflows
          
          echo "ðŸ”„ Updating schedule in all workflow files..."
          echo "Target: Run every 10 minutes"
          echo ""
          
          # à¦¨à¦¿à¦œà§‡à¦•à§‡ à¦¬à¦¾à¦¦ à¦¦à¦¿à¦¨
          CURRENT_FILE="master-scheduler.yml"
          
          # à¦¸à¦¬ YML à¦«à¦¾à¦‡à¦² à¦²à§à¦ª à¦•à¦°à§à¦¨
          for file in *.yml; do
            # à¦¨à¦¿à¦œà§‡à¦•à§‡ à¦¬à¦¾à¦¦ à¦¦à¦¿à¦¨
            if [ "$file" = "$CURRENT_FILE" ] || [ "$file" = "debug-workflows.yml" ]; then
              echo "â­ï¸ Skipping: $file"
              continue
            fi
            
            echo "ðŸ“ Processing: $file"
            
            # Backup à¦•à¦°à§à¦¨
            cp "$file" "${file}.backup"
            
            # 1. à¦¬à¦¿à¦¦à§à¦¯à¦®à¦¾à¦¨ schedule à¦¸à¦°à¦¾à¦¨
            sed -i '/schedule:/,/cron:/d' "$file" 2>/dev/null || true
            sed -i '/^[[:space:]]*\- cron:/d' "$file" 2>/dev/null || true
            
            # 2. à¦¨à¦¤à§à¦¨ schedule à¦¯à§‹à¦— à¦•à¦°à§à¦¨ (10 à¦®à¦¿à¦¨à¦¿à¦Ÿà§‡)
            if grep -q "^on:" "$file"; then
              # Case: 'on:' à¦¶à§à¦°à§à¦¤à§‡ à¦†à¦›à§‡
              echo "  âœ“ Adding schedule to existing 'on:' section"
              sed -i '/^on:/a\  schedule:\n    - cron: "*/10 * * * *"' "$file"
            elif grep -q "^  on:" "$file"; then
              # Case: indented 'on:'
              echo "  âœ“ Adding schedule to indented 'on:' section"
              sed -i '/^  on:/a\    schedule:\n      - cron: "*/10 * * * *"' "$file"
            else
              # Case: 'on:' à¦¨à§‡à¦‡
              echo "  âš ï¸ No 'on:' found, creating new one"
              
              # à¦«à¦¾à¦‡à¦²à§‡à¦° à¦¶à§à¦°à§à¦¤à§‡ on section à¦¯à§‹à¦— à¦•à¦°à§à¦¨
              TEMP_FILE=$(mktemp)
              echo "on:" > "$TEMP_FILE"
              echo "  schedule:" >> "$TEMP_FILE"
              echo "    - cron: \"*/10 * * * *\"" >> "$TEMP_FILE"
              echo "  workflow_dispatch:" >> "$TEMP_FILE"
              echo "" >> "$TEMP_FILE"
              tail -n +2 "$file" >> "$TEMP_FILE" 2>/dev/null || cat "$file" >> "$TEMP_FILE"
              mv "$TEMP_FILE" "$file"
            fi
            
            echo "  âœ… Updated: $file (now runs every 10 minutes)"
            echo ""
          done
      
      - name: Verify changes
        run: |
          echo "ðŸ” Verifying schedule updates..."
          echo ""
          
          cd .github/workflows
          
          for file in *.yml; do
            if [ "$file" != "master-scheduler.yml" ] && [ "$file" != "debug-workflows.yml" ]; then
              echo "ðŸ“„ $file:"
              if grep -q "cron:" "$file"; then
                grep "cron:" "$file"
              else
                echo "  âŒ No schedule found!"
              fi
              echo ""
            fi
          done
      
      - name: Commit and push changes
        run: |
          echo "ðŸš€ Committing schedule updates..."
          
          # Git configuration
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # à¦¶à§à¦§à§ workflow à¦«à¦¾à¦‡à¦²à¦—à§à¦²à§‹ add à¦•à¦°à§à¦¨
          git add .github/workflows/*.yml
          
          # Changes check
          if git diff --cached --quiet; then
            echo "âœ… No changes to commit (schedules already up to date)"
          else
            # Changes à¦¦à§‡à¦–à¦¾à¦¨
            echo "ðŸ“‹ Modified files:"
            git diff --cached --name-only
            
            # Commit
            git commit -m "ðŸ”„ Master Scheduler: Update all workflows to run every 10 minutes"
            
            # Push
            git push
            
            echo "ðŸŽ‰ Success! All workflows updated to run every 10 minutes!"
          fi
          
          # Backup à¦«à¦¾à¦‡à¦² à¦®à§à¦›à§à¦¨
          cd .github/workflows 2>/dev/null || true
          rm -f *.backup 2>/dev/null || true
      
      - name: Final report
        run: |
          echo ""
          echo "========================================"
          echo "        ðŸŽ¯ MASTER SCHEDULER REPORT      "
          echo "========================================"
          echo ""
          echo "âœ… All workflows have been scheduled to run every 10 minutes"
          echo ""
          echo "ðŸ“… Next auto-run: In 10 minutes"
          echo "ðŸ”„ Manual run: Available via workflow_dispatch"
          echo ""
          echo "Modified workflows will now:"
          echo "1. Auto-run every 10 minutes"
          echo "2. Can be manually triggered"
          echo ""
          echo "Master scheduler will auto-update schedules every 10 minutes"
