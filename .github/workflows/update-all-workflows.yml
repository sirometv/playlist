name: All workflowğŸ‘Œ

on:
  schedule:
    - cron: '*/10 * * * *'  # à¦ªà§à¦°à¦¤à¦¿ à§§à§¦ à¦®à¦¿à¦¨à¦¿à¦Ÿ à¦ªà¦°
  workflow_dispatch:

jobs:
  update-all-schedules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository with write permission
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: Setup Git identity
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Process all workflow files
        run: |
          echo "ğŸ” Checking workflow directory..."
          cd .github/workflows
          
          # à¦¸à¦¬ YML à¦«à¦¾à¦‡à¦² à¦²à¦¿à¦¸à§à¦Ÿ à¦•à¦°à§à¦¨ (à¦¨à¦¿à¦œà§‡à¦•à§‡ à¦¬à¦¾à¦¦ à¦¦à¦¿à§Ÿà§‡)
          WORKFLOW_FILES=$(ls *.yml | grep -v "update-all-workflows.yml")
          
          if [ -z "$WORKFLOW_FILES" ]; then
            echo "âš ï¸ No other workflow files found!"
            exit 0
          fi
          
          echo "ğŸ“‹ Found workflow files:"
          echo "$WORKFLOW_FILES"
          echo ""
          
          CHANGED=false
          
          for file in $WORKFLOW_FILES; do
            echo "ğŸ”„ Processing: $file"
            
            # Backup à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨
            cp "$file" "${file}.backup"
            
            # 1. à¦¬à¦¿à¦¦à§à¦¯à¦®à¦¾à¦¨ schedule à¦¸à¦°à¦¾à¦¨ (à¦¯à¦¦à¦¿ à¦¥à¦¾à¦•à§‡)
            sed -i '/^  schedule:/,/^[^[:space:]]/d' "$file" 2>/dev/null || true
            sed -i '/schedule:/d' "$file" 2>/dev/null || true
            sed -i '/cron:/d' "$file" 2>/dev/null || true
            
            # 2. YAML à¦¸à§à¦Ÿà§à¦°à¦¾à¦•à¦šà¦¾à¦° à¦¬à§à¦à¦¤à§‡ à¦¸à¦¾à¦¹à¦¾à¦¯à§à¦¯à¦•à¦¾à¦°à§€ à¦²à¦¾à¦‡à¦¨ à¦¯à§‹à¦— à¦•à¦°à§à¦¨
            if grep -q "^on:" "$file"; then
              # Case 1: 'on:' à¦¶à§à¦°à§à¦¤à§‡ à¦†à¦›à§‡
              echo "  Found 'on:' at start, adding schedule..."
              sed -i '/^on:/a\  schedule:\n    - cron: \"\*/10 \* \* \* \*\"' "$file"
              CHANGED=true
              
            elif grep -q "on:" "$file" && grep -q "^  on:" "$file"; then
              # Case 2: 'on:' indent à¦¸à¦¹ à¦†à¦›à§‡
              echo "  Found indented 'on:', adding schedule..."
              sed -i '/^  on:/a\    schedule:\n      - cron: \"\*/10 \* \* \* \*\"' "$file"
              CHANGED=true
              
            elif grep -q "^name:" "$file"; then
              # Case 3: name à¦à¦° à¦ªà¦°à§‡ on à¦¯à§‹à¦— à¦•à¦°à§à¦¨
              echo "  Adding 'on' section after name..."
              sed -i '/^name:/a\on:\n  schedule:\n    - cron: \"\*/10 \* \* \* \*\"' "$file"
              CHANGED=true
              
            else
              # Case 4: à¦«à¦¾à¦‡à¦²à§‡à¦° à¦¶à§à¦°à§à¦¤à§‡ à¦¸à¦¬ à¦¯à§‹à¦— à¦•à¦°à§à¦¨
              echo "  Adding complete workflow structure..."
              HEADER="# Auto-generated schedule by All workflowğŸ‘Œ\n"
              SCHEDULE="on:\n  schedule:\n    - cron: \"*/10 * * * *\"\n"
              
              # Temporary file à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨
              TEMP_FILE=$(mktemp)
              echo -e "$HEADER$SCHEDULE" > "$TEMP_FILE"
              cat "$file" >> "$TEMP_FILE"
              mv "$TEMP_FILE" "$file"
              CHANGED=true
            fi
            
            echo "  âœ… Done: $file"
            echo ""
          done
          
          if [ "$CHANGED" = true ]; then
            echo "ğŸ“ Changes were made to workflow files"
            echo "Modified files:"
            for file in $WORKFLOW_FILES; do
              if [ -f "${file}.backup" ]; then
                if ! diff -q "$file" "${file}.backup" > /dev/null; then
                  echo "  â€¢ $file"
                fi
              fi
            done
          else
            echo "â„¹ï¸ No changes were needed"
          fi
      
      - name: Commit and push changes
        if: success()
        run: |
          echo "ğŸš€ Checking for changes to commit..."
          
          # à¦¶à§à¦§à§ modified à¦«à¦¾à¦‡à¦²à¦—à§à¦²à§‹ add à¦•à¦°à§à¦¨
          git add .github/workflows/*.yml 2>/dev/null || true
          
          # à¦•à§‹à¦¨ à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨ à¦†à¦›à§‡ à¦•à¦¿à¦¨à¦¾ à¦šà§‡à¦• à¦•à¦°à§à¦¨
          if git diff --staged --quiet; then
            echo "âœ… No changes to commit - schedules are already up to date"
          else
            echo "ğŸ“¦ Changes detected, committing..."
            
            # à¦ªà¦°à¦¿à¦¬à¦°à§à¦¤à¦¨à¦—à§à¦²à§‹ à¦¦à§‡à¦–à§à¦¨
            echo "Modified files:"
            git diff --staged --name-only
            
            # Commit à¦•à¦°à§à¦¨
            git commit -m "ğŸ”„ Auto-update: Set all workflows to run every 10 minutes"
            
            # Push à¦•à¦°à§à¦¨
            git push origin HEAD
            
            echo "ğŸ‰ Successfully updated all workflow schedules!"
          fi
      
      - name: Cleanup backups
        if: always()
        run: |
          cd .github/workflows 2>/dev/null || exit 0
          rm -f *.backup 2>/dev/null || true
          echo "ğŸ§¹ Cleanup completed"
