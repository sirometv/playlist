name: All workflowЁЯСМ

on:
  schedule:
    - cron: '*/10 * * * *'  # ржкрзНрж░рждрж┐ рззрзж ржорж┐ржирж┐ржЯ ржкрж░
  workflow_dispatch:  # ржорзНржпрж╛ржирзБржпрж╝рж╛рж▓ ржЪрж╛рж▓рж╛ржирзЛрж░ ржЬржирзНржп

jobs:
  update-all-schedules:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Add/Update schedule in all workflow files
        env:
          # ржПржЗ ржлрж╛ржЗрж▓рзЗрж░ ржирж╛ржо (ржирж┐ржЬрзЗржХрзЗ ржмрж╛ржж ржжрзЗржУрзЯрж╛рж░ ржЬржирзНржп)
          CURRENT_FILE: "update-all-workflows.yml"
        run: |
          cd .github/workflows
          
          echo "=== Processing workflow files ==="
          ls -la *.yml
          
          for workflow_file in *.yml; do
            # ржирж┐ржЬрзЗржХрзЗ ржмрж╛ржж ржжрж┐ржи
            if [ "$workflow_file" = "$CURRENT_FILE" ]; then
              echo "тПня╕П  Skipping self: $workflow_file"
              continue
            fi
            
            echo "ЁЯФД Processing: $workflow_file"
            
            # ржлрж╛ржЗрж▓рзЗрж░ ржХржирзНржЯрзЗржирзНржЯ ржжрзЗржЦрзБржи (ржбрж┐ржмрж╛ржЧрж┐ржВ ржПрж░ ржЬржирзНржп)
            echo "--- Current content of $workflow_file ---"
            head -20 "$workflow_file"
            echo "----------------------------------------"
            
            # 1. ржкрзНрж░ржержорзЗ schedule section remove ржХрж░рзБржи (ржпржжрж┐ ржерж╛ржХрзЗ)
            sed -i '/^  schedule:/,/^[^ ]/d' "$workflow_file" 2>/dev/null || true
            sed -i '/schedule:/d' "$workflow_file" 2>/dev/null || true
            sed -i '/cron:/d' "$workflow_file" 2>/dev/null || true
            
            # 2. ржПржЦржи schedule ржпрзЛржЧ ржХрж░рзБржи
            # ржЙржкрж╛рзЯ рзз: ржпржжрж┐ 'on:' рж▓рж╛ржЗржи ржерж╛ржХрзЗ
            if grep -q "^on:" "$workflow_file"; then
              echo "тЬЕ Found 'on:' in $workflow_file, adding schedule..."
              
              # 'on:' ржПрж░ ржирж┐ржЪрзЗ schedule ржпрзЛржЧ ржХрж░рзБржи
              # 'on:' рж▓рж╛ржЗржирзЗрж░ ржкрж░ржмрж░рзНрждрзА рж▓рж╛ржЗржи ржерзЗржХрзЗ рж╢рзБрж░рзБ ржХрж░рзЗ, indent ржмржЬрж╛рзЯ рж░рзЗржЦрзЗ
              sed -i '/^on:/a\  schedule:\n    - cron: "*/10 * * * *"' "$workflow_file"
            
            # ржЙржкрж╛рзЯ рзи: ржпржжрж┐ 'on' key ржерж╛ржХрзЗ (YAML structure ржЕржирзБржпрж╛рзЯрзА)
            elif grep -q "on:" "$workflow_file"; then
              echo "тЬЕ Found 'on:' (indented) in $workflow_file, adding schedule..."
              
              # 'on:' рж▓рж╛ржЗржирзЗрж░ ржкрж░ schedule ржпрзЛржЧ ржХрж░рзБржи
              sed -i '/^  on:/a\    schedule:\n      - cron: \"*\/10 * * * *\"' "$workflow_file"
            
            # ржЙржкрж╛рзЯ рзй: ржпржжрж┐ workflow ржЯрзНрж░рж┐ржЧрж╛рж░ ржЕржирзНржп ржХрзЛржи ржлрж░рзНржорзНржпрж╛ржЯрзЗ ржерж╛ржХрзЗ
            else
              echo "тЪая╕П  No 'on:' found in standard format, trying alternative approach..."
              
              # ржлрж╛ржЗрж▓рзЗрж░ рж╢рзБрж░рзБрждрзЗ ржмрж╛ ржЙржкржпрзБржХрзНржд ржЬрж╛рзЯржЧрж╛рзЯ schedule ржпрзЛржЧ ржХрж░рж╛рж░ ржЪрзЗрж╖рзНржЯрж╛ ржХрж░рзБржи
              # ржкрзНрж░ржержорзЗ ржлрж╛ржЗрж▓ backup ржХрж░рзБржи
              cp "$workflow_file" "${workflow_file}.bak"
              
              # Python script ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗ YAML parse ржХрж░рзБржи
              python3 -c "
import yaml
import sys

try:
    with open('$workflow_file', 'r') as f:
        data = yaml.safe_load(f) or {}
    
    # 'on' key ржпрзЛржЧ ржХрж░рзБржи ржмрж╛ update ржХрж░рзБржи
    if 'on' not in data:
        data['on'] = {'schedule': [{'cron': '*/10 * * * *'}]}
    else:
        if isinstance(data['on'], dict):
            data['on']['schedule'] = [{'cron': '*/10 * * * *'}]
        else:
            # ржпржжрж┐ 'on' ржЕржирзНржп ржХрзЛржи ржлрж░рзНржорзНржпрж╛ржЯрзЗ ржерж╛ржХрзЗ
            data['on'] = {'schedule': [{'cron': '*/10 * * * *'}]}
    
    # ржлрж╛ржЗрж▓ рж▓рж┐ржЦрзБржи
    with open('$workflow_file', 'w') as f:
        yaml.dump(data, f, default_flow_style=False, sort_keys=False)
    
    print('тЬЕ Schedule added using Python parser')
    
except Exception as e:
    print(f'тЭМ Error: {e}')
    # Backup ржлрж╛ржЗрж▓ restore ржХрж░рзБржи
    import shutil
    shutil.copy('${workflow_file}.bak', '$workflow_file')
"
            fi
            
            echo "тЬЕ Updated: $workflow_file"
            echo ""
          done
          
          echo "=== Final check ==="
          for workflow_file in *.yml; do
            if [ "$workflow_file" != "$CURRENT_FILE" ]; then
              echo "ЁЯУД $workflow_file schedule check:"
              grep -A2 "schedule:" "$workflow_file" || echo "  No schedule found"
            fi
          done
      
      - name: Commit and push changes
        run: |
          # Git configuration
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          
          # рж╢рзБржзрзБ workflow ржлрж╛ржЗрж▓ржЧрзБрж▓рзЛ add ржХрж░рзБржи
          git add .github/workflows/*.yml
          
          # ржкрж░рж┐ржмрж░рзНрждржи check ржХрж░рзБржи
          if git diff --cached --quiet; then
            echo "тД╣я╕П  No changes to commit"
          else
            # ржкрж░рж┐ржмрж░рзНрждржиржЧрзБрж▓рзЛ ржжрзЗржЦрзБржи
            echo "ЁЯУЭ Changes to be committed:"
            git diff --cached --name-only
            
            # Commit ржПржмржВ push
            git commit -m "тЬЕ Automated: Updated all workflows to run every 10 minutes"
            git push
            echo "ЁЯЪА Changes pushed successfully"
          fi
