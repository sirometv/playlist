name: ‚ú® Schedule All Workflows

on:
  schedule:
    - cron: '*/10 * * * *'  # ‡¶®‡¶ø‡¶ú‡ßá ‡¶™‡ßç‡¶∞‡¶§‡¶ø ‡ßß‡ß¶ ‡¶Æ‡¶ø‡¶®‡¶ø‡¶ü ‡¶™‡¶∞ ‡¶∞‡¶æ‡¶® ‡¶π‡¶¨‡ßá
  workflow_dispatch:

jobs:
  master-scheduler:
    runs-on: ubuntu-latest
    
    steps:
      - name: üîì Checkout with full access
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: üìã Discover workflow files
        id: discover
        run: |
          echo "üîç Looking for workflow files..."
          
          # ‡¶®‡¶ø‡¶ú‡ßá‡¶ï‡ßá ‡¶¨‡¶æ‡¶¶ ‡¶¶‡¶ø‡¶®
          CURRENT_FILE="Schedule-All-Workflows.yml"
          
          # ‡¶∏‡¶¨ workflow ‡¶´‡¶æ‡¶á‡¶≤‡ßá‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
          WORKFLOWS=$(find .github/workflows -name "*.yml" -type f | grep -v "$CURRENT_FILE" | grep -v "debug-workflows.yml")
          
          if [ -z "$WORKFLOWS" ]; then
            echo "‚ùå No other workflow files found!"
            echo "Creating a test workflow..."
            
            # ‡¶è‡¶ï‡¶ü‡¶ø ‡¶ü‡ßá‡¶∏‡ßç‡¶ü workflow ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡ßÅ‡¶®
            cat > .github/workflows/example-workflow.yml << 'EOF'
name: Example Workflow
on:
  workflow_dispatch:
jobs:
  example:
    runs-on: ubuntu-latest
    steps:
      - run: echo "This workflow will get automated schedule"
EOF
            
            WORKFLOWS=".github/workflows/example-workflow.yml"
          fi
          
          # List files
          echo "üìÅ Found workflow files:"
          for wf in $WORKFLOWS; do
            echo "  - $wf"
          done
          
          # Environment variable ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá save ‡¶ï‡¶∞‡ßÅ‡¶®
          echo "WORKFLOW_LIST=$(echo $WORKFLOWS | tr '\n' ' ')" >> $GITHUB_ENV
          echo "WF_COUNT=$(echo $WORKFLOWS | wc -w)" >> $GITHUB_ENV
      
      - name: üõ†Ô∏è Process each workflow file
        run: |
          echo "üéØ Processing $WF_COUNT workflow files..."
          echo ""
          
          for wf in $WORKFLOW_LIST; do
            echo "========================================"
            echo "üìÑ FILE: $(basename $wf)"
            echo "========================================"
            
            # Backup ‡¶ï‡¶∞‡ßÅ‡¶®
            cp "$wf" "${wf}.backup"
            
            # Method 1: Python ‡¶¶‡¶ø‡ßü‡ßá ‡¶∏‡¶†‡¶ø‡¶ï‡¶≠‡¶æ‡¶¨‡ßá process ‡¶ï‡¶∞‡ßÅ‡¶®
            python3 << ENDPYTHON
import yaml
import os
import sys

file_path = "$wf"

try:
    # YAML ‡¶´‡¶æ‡¶á‡¶≤ ‡¶™‡ßú‡ßÅ‡¶®
    with open(file_path, 'r') as f:
        content = f.read()
        data = yaml.safe_load(content) if content.strip() else {}
    
    print(f"Current structure type: {type(data)}")
    
    # Ensure data is a dictionary
    if not isinstance(data, dict):
        data = {}
    
    # Add or update schedule
    if 'on' not in data:
        data['on'] = {'schedule': [{'cron': '*/10 * * * *'}]}
    else:
        if isinstance(data['on'], dict):
            # If 'on' is a dict, add schedule to it
            data['on']['schedule'] = [{'cron': '*/10 * * * *'}]
        elif isinstance(data['on'], list):
            # If 'on' is a list, convert to dict with schedule
            data['on'] = {'schedule': [{'cron': '*/10 * * * *'}]}
        elif isinstance(data['on'], str):
            # If 'on' is string, convert to dict
            data['on'] = {'schedule': [{'cron': '*/10 * * * *'}]}
        else:
            # Fallback
            data['on'] = {'schedule': [{'cron': '*/10 * * * *'}]}
    
    # Write back to file
    with open(file_path, 'w') as f:
        yaml.dump(data, f, default_flow_style=False, sort_keys=False, width=1000)
    
    print("‚úÖ Successfully added/updated schedule")
    
except Exception as e:
    print(f"‚ùå Error: {e}")
    
    # Method 2: Simple sed method if Python fails
    print("Trying alternative method...")
    os.system(f'''cat > "$wf" << 'EOF'
name: $(basename "$wf" .yml)
on:
  schedule:
    - cron: "*/10 * * * *"
  workflow_dispatch:
jobs:
  default-job:
    runs-on: ubuntu-latest
    steps:
      - run: echo "This workflow is automatically scheduled"
EOF''')
    
    print("‚úÖ Applied fallback method")

ENDPYTHON
            
            echo ""
            echo "üìù New content of $(basename $wf):"
            echo "----------------------------------------"
            head -15 "$wf"
            echo "----------------------------------------"
            echo ""
          done
      
      - name: üíæ Commit changes
        run: |
          echo "üöÄ Preparing to commit changes..."
          
          # Git configuration
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add all workflow files
          git add .github/workflows/*.yml
          
          # Check for changes
          if ! git diff --cached --quiet; then
            echo "üì¶ Changes found! Committing..."
            
            # Show what changed
            echo "Modified files:"
            git diff --cached --name-only
            
            # Commit
            git commit -m "ü§ñ AUTO: Scheduled all workflows to run every 10 minutes"
            
            # Push
            git push
            
            echo "üéâ SUCCESS! All workflows are now scheduled!"
            echo ""
            echo "üìÖ Each workflow will now run automatically every 10 minutes"
          else
            echo "‚úÖ No changes needed - schedules already exist"
          fi
          
          # Cleanup
          find .github/workflows -name "*.backup" -delete
      
      - name: üìä Final report
        run: |
          echo ""
          echo "========================================"
          echo "           üìã FINAL REPORT              "
          echo "========================================"
          echo ""
          
          echo "Processed workflow files:"
          echo "-------------------------"
          for wf in $WORKFLOW_LIST; do
            if [ -f "$wf" ]; then
              FILENAME=$(basename "$wf")
              HAS_SCHEDULE=$(grep -c "schedule:" "$wf" || echo "0")
              HAS_CRON=$(grep -c "cron:" "$wf" || echo "0")
              
              echo "üìÑ $FILENAME:"
              echo "   - Has schedule: $HAS_SCHEDULE"
              echo "   - Has cron: $HAS_CRON"
              
              if [ "$HAS_SCHEDULE" -gt 0 ] && [ "$HAS_CRON" -gt 0 ]; then
                echo "   ‚úÖ Status: SCHEDULED (every 10 min)"
              else
                echo "   ‚ùå Status: NOT SCHEDULED"
              fi
              echo ""
            fi
          done
          
          echo "========================================"
          echo "üéØ NEXT STEPS:"
          echo "1. Check your workflow files in .github/workflows/"
          echo "2. Each should now have 'schedule' section"
          echo "3. They will auto-run every 10 minutes"
          echo "========================================"
