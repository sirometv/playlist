name: Fancode BD & IND Playlist Updater

on:
  schedule:
    - cron: '7,17,27,37,47,57 * * * *'
  workflow_dispatch:
  push:
    paths:
      - 'data.json'

jobs:
  update-playlists:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Update playlists from JSON
      run: |
        echo "========================================="
        echo "ðŸš€ Starting Fancode Playlist Update"
        echo "ðŸ“… Time: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "========================================="
        
        # Check if data.json exists
        if [ ! -f "data.json" ]; then
          echo "âŒ ERROR: data.json file not found!"
          echo "Current directory contents:"
          ls -la
          exit 1
        fi
        
        # Create Python script
        cat > update_script.py << 'EOF'
        import json
        import os
        import sys
        
        def main():
            print("ðŸ“‚ Checking files...")
            print(f"Working directory: {os.getcwd()}")
            print(f"Files in directory: {os.listdir('.')}")
            
            try:
                # Check if data.json exists
                if not os.path.exists('data.json'):
                    print("âŒ data.json not found!")
                    return False
                
                print("âœ… data.json found")
                
                # Read JSON file
                with open('data.json', 'r', encoding='utf-8') as f:
                    data = json.load(f)
                
                print(f"ðŸ“Š JSON loaded successfully")
                print(f"ðŸ“ˆ Total matches found: {len(data.get('matches', []))}")
                
                matches = data.get('matches', [])
                
                # Initialize playlists
                bd_entries = []
                in_entries = []
                
                # Process each match
                for i, match in enumerate(matches):
                    adfree_url = match.get('adfree_url', '')
                    
                    if not adfree_url:
                        continue
                    
                    # Get details
                    title = match.get('title', f'Channel {i+1}')
                    logo = match.get('logo', '')
                    group_title = match.get('group_title', 'Sports')
                    
                    # Create EXTINF line (correct M3U format)
                    extinf_line = f'#EXTINF:-1 tvg-logo="{logo}" group-title="{group_title}", {title}'
                    
                    print(f"\nðŸ“º Processing: {title}")
                    print(f"   URL: {adfree_url}")
                    
                    # Bangladeshi playlist
                    if 'https://bd' in adfree_url:
                        bd_entries.append(extinf_line)
                        bd_entries.append(adfree_url)
                        print(f"   âž• Added to BD playlist")
                    
                    # Indian playlist
                    if 'https://bd' in adfree_url:
                        indian_url = adfree_url.replace('https://bd', 'https://in', 1)
                        in_entries.append(extinf_line)
                        in_entries.append(indian_url)
                        print(f"   âž• Added to IN playlist (converted)")
                    elif 'https://in' in adfree_url:
                        in_entries.append(extinf_line)
                        in_entries.append(adfree_url)
                        print(f"   âž• Added to IN playlist")
                
                # Create M3U content
                bd_content = ['#EXTM3U'] + bd_entries
                in_content = ['#EXTM3U'] + in_entries
                
                # Write to files
                with open('fancodeBD.m3u', 'w', encoding='utf-8') as f:
                    f.write('\n'.join(bd_content))
                
                with open('fancodeIND.m3u', 'w', encoding='utf-8') as f:
                    f.write('\n'.join(in_content))
                
                print(f"\n=========================================")
                print(f"âœ… UPDATE COMPLETED SUCCESSFULLY")
                print(f"=========================================")
                print(f"ðŸ“Š Bangladeshi playlist: {len(bd_entries)//2} channels")
                print(f"ðŸ“Š Indian playlist: {len(in_entries)//2} channels")
                
                # Show sample output
                if bd_entries:
                    print(f"\nðŸ“ Sample BD entry:")
                    print(f"   {bd_entries[0]}")
                    print(f"   {bd_entries[1][:50]}...")
                
                if in_entries:
                    print(f"\nðŸ“ Sample IN entry:")
                    print(f"   {in_entries[0]}")
                    print(f"   {in_entries[1][:50]}...")
                
                return True
                
            except Exception as e:
                print(f"âŒ ERROR: {str(e)}")
                import traceback
                traceback.print_exc()
                return False
        
        if __name__ == '__main__':
            success = main()
            sys.exit(0 if success else 1)
        EOF
        
        # Run the Python script
        python3 update_script.py
        
        # Show created files
        echo ""
        echo "ðŸ“ Created files:"
        ls -la *.m3u
        echo ""
        echo "ðŸ“„ First few lines of BD playlist:"
        head -5 fancodeBD.m3u
        echo ""
        echo "ðŸ“„ First few lines of IN playlist:"
        head -5 fancodeIND.m3u
        
    - name: Commit and Push Changes
      run: |
        echo "ðŸ”„ Checking for changes..."
        
        # Configure git
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        # Check if files have changed
        if git diff --name-only | grep -q "\.m3u$"; then
          echo "ðŸ“ Changes detected in playlist files"
          
          # Show what changed
          echo "Changes summary:"
          git diff --stat fancodeBD.m3u fancodeIND.m3u
          
          # Add and commit
          git add fancodeBD.m3u fancodeIND.m3u
          git commit -m "ðŸ”„ Auto-update playlists $(date +'%Y-%m-%d %H:%M:%S')
          
          â€¢ Updated from data.json
          â€¢ Automated playlist generation"
          
          # Push changes
          git push
          echo "âœ… Changes pushed successfully!"
        else
          echo "â„¹ï¸ No changes detected in playlist files"
          echo "Current playlist status:"
          echo "BD playlist entries: $(grep -c '^#EXTINF' fancodeBD.m3u || echo 0)"
          echo "IN playlist entries: $(grep -c '^#EXTINF' fancodeIND.m3u || echo 0)"
        fi
