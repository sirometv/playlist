name: Fancode BD & IND Playlist Updater

on:
  schedule:
    - cron: '7,17,27,37,47,57 * * * *'
  workflow_dispatch:
  push:
    paths:
      - 'fancode.json'

jobs:
  update-playlists:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install pytz for Bangladesh timezone
      run: pip install pytz
    
    - name: Update playlists from JSON
      run: |
        echo "========================================="
        echo "ðŸš€ Starting Fancode Playlist Update"
        echo "========================================="
        
        # Check if fancode.json exists
        if [ ! -f "fancode.json" ]; then
          echo "âŒ ERROR: fancode.json file not found!"
          exit 1
        fi
        
        # Create Python script
        cat > update_script.py << 'EOF'
        import json
        import os
        import sys
        from datetime import datetime
        import pytz
        
        def get_bangladesh_time():
            """Get current Bangladesh time"""
            bd_tz = pytz.timezone('Asia/Dhaka')
            return datetime.now(bd_tz)
        
        def get_stream_url(match):
            """Get stream URL from match (check both hls_url and stream_url)"""
            # First try hls_url
            hls_url = match.get('hls_url', '')
            if hls_url:
                return hls_url
            
            # Then try stream_url
            stream_url = match.get('stream_url', '')
            if stream_url:
                return stream_url
            
            # Try adfree_url if exists
            adfree_url = match.get('adfree_url', '')
            if adfree_url:
                return adfree_url
            
            return ''
        
        def main():
            print("ðŸ“‚ Starting playlist update process...")
            
            # Get Bangladesh time
            bd_time = get_bangladesh_time()
            update_time = bd_time.strftime("%I:%M:%S %p - %d-%m-%Y")
            print(f"ðŸ•’ Bangladesh Time: {update_time}")
            
            try:
                # Read JSON file
                with open('fancode.json', 'r', encoding='utf-8') as f:
                    data = json.load(f)
                
                # Check if data is a list or has matches key
                if isinstance(data, list):
                    matches = data
                    print(f"ðŸ“Š JSON is a list with {len(matches)} items")
                elif isinstance(data, dict):
                    matches = data.get('matches', [])
                    print(f"ðŸ“Š Found {len(matches)} matches in JSON")
                else:
                    print("âŒ ERROR: Invalid JSON format")
                    return False
                
                # Debug: Show first match structure
                if matches:
                    print(f"\nðŸ” First match structure:")
                    for key, value in list(matches[0].items())[:5]:
                        print(f"   {key}: {str(value)[:50]}...")
                
                # Common header for both playlists
                common_comments = [
                    "#ðŸ”´ à¦à¦‡ à¦«à¦¾à¦‡à¦²à§‡à¦° à¦¸à¦®à¦¸à§à¦¤ à¦²à¦¿à¦™à§à¦• à¦ªà¦¾à¦¬à¦²à¦¿à¦• à¦¸à§‹à¦°à§à¦¸ à¦¥à§‡à¦•à§‡ à¦¸à¦‚à¦—à§à¦°à¦¹ à¦•à¦°à¦¾ à¦¹à¦¯à¦¼à§‡à¦›à§‡à¥¤ à¦¯à¦¦à¦¿ à¦•à§‡à¦‰ à¦¤à¦¾à¦¦à§‡à¦° à¦¸à§‹à¦°à§à¦¸ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¤à§‡ à¦šà¦¾à¦¨, à¦¤à¦¾à¦¹à¦²à§‡ à¦¦à¦¯à¦¼à¦¾ à¦•à¦°à§‡ à¦†à¦®à¦¾à¦¦à§‡à¦° à¦œà¦¾à¦¨à¦¾à¦¨à¥¤ à¦†à¦®à¦°à¦¾ à¦†à¦ªà¦¨à¦¾à¦° à¦®à¦¤à¦¾à¦®à¦¤ à¦à¦¬à¦‚ à¦ªà§à¦°à¦šà§‡à¦·à§à¦Ÿà¦¾à¦•à§‡ à¦¸à¦®à§à¦®à¦¾à¦¨ à¦•à¦°à¦¿, à¦¤à¦¾à¦‡ à¦†à¦ªà¦¨à¦¾à¦° à¦¸à§‹à¦°à§à¦¸ à¦®à§à¦›à§‡ à¦«à§‡à¦²à¦¾à¦° à¦¬à§à¦¯à¦¾à¦ªà¦¾à¦°à§‡ à¦†à¦®à¦°à¦¾ à¦†à¦ªà¦ªà§à¦¤à¦¿ à¦•à¦°à¦¬ à¦¨à¦¾à¥¤",
                    "# All the links in this file are collected from public sources. If anyone wants to remove their source, please let us know. We respect your opinions and efforts, so we will not object to removing your source.",
                    f"#Update Time: {update_time}",
                    "#Telegram: https://t.me/sirometv",
                    "#WEB TV: https://sirometv-tv.vercel.app"
                ]
                
                # Process Bangladeshi playlist
                print("\nðŸ‡§ðŸ‡© Processing Bangladeshi playlist...")
                bd_content = ['#EXTM3U']
                bd_content.extend(common_comments)
                
                bd_count = 0
                bd_entries = []
                
                for match in matches:
                    # Get stream URL
                    stream_url = get_stream_url(match)
                    
                    if stream_url:
                        # Check if it's a Bangladeshi URL
                        if 'https://bd' in stream_url or '.bd.' in stream_url:
                            title = match.get('title', 'Unknown')
                            logo = match.get('logo', match.get('image', ''))
                            group_title = match.get('group_title', match.get('category', 'Sports'))
                            
                            extinf_line = f'#EXTINF:-1 tvg-logo="{logo}" group-title="{group_title}", {title}'
                            bd_entries.append(extinf_line)
                            bd_entries.append(stream_url)
                            bd_count += 1
                            print(f"   âœ… Added: {title} - {stream_url[:50]}...")
                
                if bd_count > 0:
                    bd_content.append("# We Found Some Match... Watch Now.")
                    bd_content.extend(bd_entries)
                    print(f"âœ… Found {bd_count} Bangladeshi streams")
                else:
                    bd_content.append("#Here Not Available Stream, We Will Update as soon possible")
                    print("â„¹ï¸ No Bangladeshi streams found")
                
                # Process Indian playlist
                print("\nðŸ‡®ðŸ‡³ Processing Indian playlist...")
                in_content = ['#EXTM3U']
                in_content.extend(common_comments)
                
                in_count = 0
                in_entries = []
                
                for match in matches:
                    stream_url = get_stream_url(match)
                    
                    if stream_url:
                        title = match.get('title', 'Unknown')
                        logo = match.get('logo', match.get('image', ''))
                        group_title = match.get('group_title', match.get('category', 'Sports'))
                        
                        # Check for Indian URLs
                        if 'https://bd' in stream_url or '.bd.' in stream_url:
                            # Convert bd to in for Indian playlist
                            indian_url = stream_url.replace('https://bd', 'https://in')
                            indian_url = indian_url.replace('.bd.', '.in.')
                            
                            extinf_line = f'#EXTINF:-1 tvg-logo="{logo}" group-title="{group_title}", {title}'
                            in_entries.append(extinf_line)
                            in_entries.append(indian_url)
                            in_count += 1
                            print(f"   âœ… Added (converted): {title}")
                        elif 'https://in' in stream_url or '.in.' in stream_url:
                            # Direct Indian URL
                            extinf_line = f'#EXTINF:-1 tvg-logo="{logo}" group-title="{group_title}", {title}'
                            in_entries.append(extinf_line)
                            in_entries.append(stream_url)
                            in_count += 1
                            print(f"   âœ… Added: {title}")
                
                if in_count > 0:
                    in_content.append("# We Found Some Match... Watch Now.")
                    in_content.extend(in_entries)
                    print(f"âœ… Found {in_count} Indian streams")
                else:
                    in_content.append("#Here Not Available Stream, We Will Update as soon possible")
                    print("â„¹ï¸ No Indian streams found")
                
                # Write playlist files
                with open('fancodeBD.m3u', 'w', encoding='utf-8') as f:
                    f.write('\n'.join(bd_content))
                
                with open('fancodeIND.m3u', 'w', encoding='utf-8') as f:
                    f.write('\n'.join(in_content))
                
                print(f"\n=========================================")
                print(f"âœ… UPDATE COMPLETED SUCCESSFULLY")
                print(f"=========================================")
                print(f"ðŸ“Š Bangladeshi playlist: {bd_count} channels")
                print(f"ðŸ“Š Indian playlist: {in_count} channels")
                print(f"ðŸ•’ Updated at: {update_time}")
                
                return True
                
            except Exception as e:
                print(f"âŒ UNEXPECTED ERROR: {str(e)}")
                import traceback
                traceback.print_exc()
                return False
        
        if __name__ == '__main__':
            success = main()
            sys.exit(0 if success else 1)
        EOF
        
        # Run the Python script
        python3 update_script.py
        
        # Show created files
        echo ""
        echo "ðŸ“ Created files preview:"
        echo "=========================="
        
        echo "ðŸ“„ fancodeBD.m3u (first 15 lines):"
        echo "----------------------------------"
        head -15 fancodeBD.m3u
        echo ""
        
        echo "ðŸ“„ fancodeIND.m3u (first 15 lines):"
        echo "-----------------------------------"
        head -15 fancodeIND.m3u
        echo ""
        
        echo "ðŸ“Š Statistics:"
        echo "--------------"
        echo "BD playlist entries: $(grep -c '^#EXTINF' fancodeBD.m3u || echo 0)"
        echo "IN playlist entries: $(grep -c '^#EXTINF' fancodeIND.m3u || echo 0)"
        
    - name: Commit and Push Changes
      run: |
        echo "ðŸ”„ Checking for changes..."
        
        # Configure git
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
        # Check if files have changed
        if ! git diff --quiet fancodeBD.m3u fancodeIND.m3u 2>/dev/null || \
           ! git ls-files --error-unmatch fancodeBD.m3u fancodeIND.m3u >/dev/null 2>&1; then
          
          echo "ðŸ“ Changes detected in playlist files"
          
          # Add and commit
          git add fancodeBD.m3u fancodeIND.m3u
          
          # Get update time and counts
          UPDATE_TIME=$(date '+%Y-%m-%d %H:%M:%S')
          BD_COUNT=$(grep -c '^#EXTINF' fancodeBD.m3u 2>/dev/null || echo 0)
          IN_COUNT=$(grep -c '^#EXTINF' fancodeIND.m3u 2>/dev/null || echo 0)
          
          git commit -m "ðŸ”„ Auto-update playlists - $UPDATE_TIME
        
â€¢ BD: $BD_COUNT channels
â€¢ IN: $IN_COUNT channels
â€¢ Source: fancode.json" || echo "No changes to commit"
          
          # Push changes
          git push
          echo "âœ… Changes pushed successfully!"
        else
          echo "â„¹ï¸ No changes detected in playlist files"
          echo "ðŸ“Š Current status:"
          echo "   BD playlist: $(grep -c '^#EXTINF' fancodeBD.m3u 2>/dev/null || echo 0) channels"
          echo "   IN playlist: $(grep -c '^#EXTINF' fancodeIND.m3u 2>/dev/null || echo 0) channels"
        fi
