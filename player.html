<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shaka Player</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/controls.min.css">
<style>
body, html {
  margin:0; padding:0; background:#000;
  height:100%; width:100%;
  display:flex; justify-content:center; align-items:center;
}
#player-container {
  width:100%; max-width:1280px;
  aspect-ratio:16/9; position:relative; background:#000;
}
video.shaka-video {
  width:100%; height:100%; object-fit:contain; background:#000;
}
.shaka-controls-container {
  z-index:9999!important; background:transparent!important;
}
.overlay-logo, .overlay-text {
  position:absolute; z-index:50; pointer-events:none; display:none;
  color:#fff; font-weight:600;
}
.overlay-text { font-size:18px; }
</style>
</head>
<body>
<div id="player-container">
  <video id="video" autoplay playsinline class="shaka-video"></video>
  <div class="shaka-controls-container"></div>
  <img id="overlayLogo" class="overlay-logo">
  <div id="overlayText" class="overlay-text"></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.6/shaka-player.ui.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async()=>{
  const video = document.getElementById('video');
  const container = document.getElementById('player-container');
  const overlayLogo = document.getElementById('overlayLogo');
  const overlayText = document.getElementById('overlayText');

  const player = new shaka.Player(video);
  player.addEventListener('error', e=>console.error('Shaka error', e.detail||e));

  const ui = new shaka.ui.Overlay(player, container, video);
  ui.configure({
    controlPanelElements: [
      'play_pause','mute','volume','spacer',
      'settings','quality',
      'picture_in_picture','fullscreen'
    ],
    settingsMenuElements: [
      'quality'
    ]
  });
  player.configure({ abr:{enabled:true} });

  // Read URL params
  const p = new URLSearchParams(window.location.search);
  const url = p.get('url');
  const keyId = p.get('keyId');
  const keyValue = p.get('keyValue');
  const logoOn = p.get('logoOn')=='1';
  const logo = p.get('logo');
  const logoPos = p.get('logoPos') || 'top-left';
  const logoSize = p.get('logoSize') || '120';
  const logoOpacity = p.get('logoOpacity') || '80';
  const wmOn = p.get('wmOn')=='1';
  const wm = p.get('wm');
  const wmPos = p.get('wmPos') || 'bottom-left';
  const wmOpacity = p.get('wmOpacity') || '70';

  async function loadVideo(){
    try {
      // DRM
      if(keyId && keyValue){
        player.configure({
          drm:{
            clearKeys:{
              [keyId]: keyValue
            }
          }
        });
      }

      await player.load(decodeURIComponent(url));
      console.log('✅ Video loaded successfully');
    } catch(err){
      console.warn('⚠️ DRM failed or unnecessary, retrying without DRM...', err);
      try {
        player.configure({drm:null});
        await player.load(decodeURIComponent(url));
        console.log('✅ Video loaded without DRM');
      } catch(e){
        console.error('❌ Cannot load video', e);
        alert('Video cannot be loaded. Check console for details.');
      }
    }
  }

  if(url) loadVideo();

  // Logo overlay
  if(logoOn && logo){
    overlayLogo.src = decodeURIComponent(logo);
    overlayLogo.style.display='block';
    overlayLogo.style.width = logoSize+'px';
    overlayLogo.style.opacity = logoOpacity/100;
    setPosition(overlayLogo, logoPos);
  }

  // Watermark overlay
  if(wmOn && wm){
    overlayText.textContent = decodeURIComponent(wm);
    overlayText.style.display='block';
    overlayText.style.opacity = wmOpacity/100;
    setPosition(overlayText, wmPos);
  }

  function setPosition(el, pos){
    el.style.top=''; el.style.left=''; el.style.right=''; el.style.bottom=''; el.style.transform='';
    switch(pos){
      case 'top-left': el.style.top='10px'; el.style.left='10px'; break;
      case 'top-right': el.style.top='10px'; el.style.right='10px'; break;
      case 'bottom-left': el.style.bottom='10px'; el.style.left='10px'; break;
      case 'bottom-right': el.style.bottom='10px'; el.style.right='10px'; break;
      case 'center': el.style.top='50%'; el.style.left='50%'; el.style.transform='translate(-50%,-50%)'; break;
    }
  }
});
</script>
</body>
</html>
